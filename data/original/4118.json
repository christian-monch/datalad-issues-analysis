{"url": "https://api.github.com/repos/datalad/datalad/issues/4118", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4118/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4118/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4118/events", "html_url": "https://github.com/datalad/datalad/pull/4118", "id": 560780056, "node_id": "MDExOlB1bGxSZXF1ZXN0MzcxNzA5MTY4", "number": 4118, "title": "update: Try harder to fetch and merge subdataset revision", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1037235281, "node_id": "MDU6TGFiZWwxMDM3MjM1Mjgx", "url": "https://api.github.com/repos/datalad/datalad/labels/do%20not%20merge", "name": "do not merge", "color": "fbca04", "default": false, "description": "Not to be merged, will trigger WIP app \"not passed\" status"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2020-02-06T04:59:32Z", "updated_at": "2020-03-18T15:28:45Z", "closed_at": "2020-02-19T21:14:43Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/4118", "html_url": "https://github.com/datalad/datalad/pull/4118", "diff_url": "https://github.com/datalad/datalad/pull/4118.diff", "patch_url": "https://github.com/datalad/datalad/pull/4118.patch"}, "body": "The motivation for this series stemmed from a scenario where, on the remote end, the submodule revision is the commit pointed to by another branch, say \"other\".  `update(..., merge=True)` called while on master in the local repo may choose to merge in something different, most likely origin/master, which let's say hasn't diverged from the local master (though either way it's problematic).  Then it saves that state as the submodule revision in the parent, bringing the submodule revision back to where it was before the remote update.\r\n\r\n<details>\r\n<summary>In code</summary>\r\n\r\n```sh\r\ncd \"$(mktemp -d --tmpdir dl-XXXXXXX)\"\r\n\r\ndatalad create rem\r\ndatalad create rem/sub\r\ndatalad -C rem save -r\r\n\r\ndatalad install -r -s rem ds\r\n\r\n(\r\n    cd rem/sub\r\n    git checkout -b other\r\n    echo foo >foo\r\n)\r\ndatalad -C rem save -r\r\n\r\ndatalad -C ds update -r --merge\r\n```\r\n\r\n</details>\r\n\r\nA very similar case can happen when the remote submodule has a detached head, a common occurrence when working with `git submodule` directly.  In this case, an additional issue is that the submodule revision might not even be fetched from the remote if the revision isn't contained in a ref that is pulled down on the fetch.\r\n\r\n---\r\n\r\n```\r\n  [ 1/12] ENH: repo: Teach get_tracking_branch() to optionally ignore \".\"\r\n  [ 2/12] BF: update: Don't consider \".\" as an upstream remote\r\n  [ 3/12] BF: update: Query intended branch.*.remote variable\r\n  [ 4/12] RF: update: Cosmetic changes to _update_repo() helper\r\n  [ 5/12] RF: update: Avoid overloading a variable for clarity\r\n  [ 6/12] OPT: update: Avoid repeatedly accessing Dataset.path in a loop\r\n  [ 7/12] RF: update: Break apart _update_repo() helper\r\n  [ 8/12] ENH: update: Use same merge approach for plain and annex repos\r\n  [ 9/12] ENH: update: Avoid calling 'git pull' to merge changes\r\n  [10/12] ENH: update: Don't set merge target to a guess that doesn't exist\r\n  [11/12] ENH: update: Try to fetch submodule commit explicitly if needed\r\n  [12/12] ENH: update: Prefer merge of submodule revision to a ref without it\r\n```\r\n\r\nPatch 1-3 are unrelated bugs that I noticed in the code I was touching for the fix.  These (or something like them) should be split off into a separate PR if the more substantial changes in this PR don't make the cut.\r\n\r\nPatch 4-7 are cleanup/prep patches, with no intended change in behavior.\r\n\r\nPatch 8-12 are the proposed fix, moving to a more targeted `git merge` to bring in changes rather using `git pull <remote> [<configured upstream or guess>]` in git repos or using `git annex sync <remote>`  in annex repos.  Note that, when we're on an adjusted branch, we keep using `git annex sync <remote>` as we did before.  It's not that this is correct or leads to good behavior; it's just that I don't see an alternative because using submodules and adjusted branches together is fundamentally problematic, and this PR isn't trying to address that.\r\n", "closed_by": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4118/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4118/timeline", "performed_via_github_app": null}