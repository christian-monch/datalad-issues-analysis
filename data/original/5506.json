{"url": "https://api.github.com/repos/datalad/datalad/issues/5506", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5506/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5506/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5506/events", "html_url": "https://github.com/datalad/datalad/pull/5506", "id": 833202620, "node_id": "MDExOlB1bGxSZXF1ZXN0NTk0MjQyMTI2", "number": 5506, "title": "BF: AnnexJsonProtocol - memoize the last line which failed to json load", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1746781627, "node_id": "MDU6TGFiZWwxNzQ2NzgxNjI3", "url": "https://api.github.com/repos/datalad/datalad/labels/merge-if-ok", "name": "merge-if-ok", "color": "fbca04", "default": false, "description": "OP considers this work done, and requests review/merge"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2021-03-16T21:15:13Z", "updated_at": "2021-04-29T21:54:41Z", "closed_at": "2021-03-17T22:36:32Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/5506", "html_url": "https://github.com/datalad/datalad/pull/5506", "diff_url": "https://github.com/datalad/datalad/pull/5506.diff", "patch_url": "https://github.com/datalad/datalad/pull/5506.patch"}, "body": "Protocol's buffer could get filled up before the entire json line is\r\nactually received, so the AnnexJsonProtocol could then receive only a\r\npart of it, and fail to parse such a partial json entry.\r\n\r\nThe patch is a bit overdone: in principle I think\r\n\r\n    not data.endswith(os.linesep.encode())\r\n\r\ncondition could be dropped, but I think it should not hurt since we are not\r\nexpecting new lines in the output within records, thus if the trailing symbol\r\nin the entire data is a newline, it would mean that we did read the entire line\r\nand thus we should not try to join it with the next one.\r\n\r\nI am not sure if similar \"I care about lines\" behavior is relevant to other\r\nWitlessProtocols and might need to be adjusted similarly.\r\n\r\nCloses #5393\r\n\r\nTODO:\r\n- [x] test (just feed with some large and short json records interleaved and see if all good)\r\n\r\nindividual commits (adjusted more while crafting the tests) might have more information.", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5506/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5506/timeline", "performed_via_github_app": null}