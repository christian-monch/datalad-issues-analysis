{"url": "https://api.github.com/repos/datalad/datalad/issues/4976", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4976/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4976/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4976/events", "html_url": "https://github.com/datalad/datalad/issues/4976", "id": 713644367, "node_id": "MDU6SXNzdWU3MTM2NDQzNjc=", "number": 4976, "title": "Weird crash of git rev-parse ... rm: cannot remove '/home/yoh/.cache/git-annex/locales/...", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2020-10-02T13:59:53Z", "updated_at": "2020-10-06T00:09:23Z", "closed_at": "2020-10-05T19:17:50Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "I decided to troubleshoot (log at higher level etc) \"why creating subdatasets is so slow when done by `addurls`\".  And quickly it has crashed with\r\n\r\n```\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/core/local/save.py\", line 304, in __call__\r\n    if start_commit != pds_repo.get_hexsha()\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/support/gitrepo.py\", line 1808, in get_hexsha\r\n    return self.call_git_oneline(cmd)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/support/gitrepo.py\", line 2290, in call_git_oneline\r\n    .format([\"git\"] + args, lines))\r\nAssertionError: Expected ['git', 'rev-parse', '--quiet', '--verify', 'HEAD^{commit}'] to return single line, but it returned [\"rm: cannot remove '/home/yoh/.cache/git-annex/locales/bb375eb6ec0d2706f1723307f068911a': Directory not empty\", '01a0149f261576dbaf2823d63ac0a789a02af1df']\r\n```\r\n\r\n<details>\r\n<summary>full trace with invocation etc</summary> \r\n\r\n```shell\r\nsmaug:/mnt/scrap/tmp/abcd\r\n$> DATALAD_LOG_TIMESTAMP=1 DATALAD_LOG_NAME=1 DATALAD_LOG_LEVEL=4 DATALAD_LOG_PID=1 DATALAD_LOG_TARGET=$PWD/datalad-full4-part-`mdate`-1.log  datalad-nda/scripts/datalad-nda --pdb add2datalad -i <(xzcat ~/proj/abcd/datastructure_manifest.txt.xz) -d testds-fast-full4-part --fast\r\n2020-10-02 09:04:34,643 [INFO   ] Creating a new dataset at /mnt/scrap/tmp/abcd/testds-fast-full4-part\r\n2020-10-02 09:04:39,574 [INFO   ] Creating a helper procedure\r\ninitremote datalad ok\r\n(recording state in git...)\r\n2020-10-02 09:04:42,230 [INFO   ] Reading entire file\r\n2020-10-02 09:04:47,199 [INFO   ] Read 4166278 lines\r\n 81%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258f                                 | 3367150/4166278 [00:18<00:04, 174639.02it/s]2020-10-02 09:05:10,681 [INFO   ] Loaded 4166276 records from 40 submissions for 40 datasets.\r\ninitremote datalad ok\r\n(recording state in git...)\r\n2020-10-02 09:05:28,210 [INFO   ] Processing for submission 21948\r\n2020-10-02 09:05:28,897 [INFO   ] Getting records only for submission_id=21948\r\n2020-10-02 09:05:30,036 [INFO   ] Got 331758 records\r\n2020-10-02 09:05:32,469 [INFO   ] Processed entire file: got 331758 files, 1472 subdatasets with 7 files having multiple URLs to possibly reach them\r\n2020-10-02 09:05:32,470 [WARNING]  - dataset_description.json: 45848 records\r\n|   - README: 45848 records\r\n|   - CHANGES: 45848 records\r\n|   - task-nback_bold.json: 1197 records\r\n|   - task-MID_bold.json: 1235 records\r\n|   - task-SST_bold.json: 1191 records\r\n|   - task-rest_bold.json: 1470 records\r\n2020-10-02 09:05:45,461 [INFO   ] Saved output to <_io.TextIOWrapper name='/mnt/scrap/tmp/abcd/testds-fast-full4-part/sourcedata/submission-21948.csv' mode='w' encoding='UTF-8'>\r\ninitremote datalad ok\r\n(recording state in git...)\r\ninitremote datalad ok\r\n(recording state in git...)\r\nTraceback (most recent call last):\r\n  File \"datalad-nda/scripts/datalad-nda\", line 424, in <module>\r\n    main()\r\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 764, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 717, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 1137, in invoke\r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))\r\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 956, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/usr/lib/python3/dist-packages/click/core.py\", line 555, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"datalad-nda/scripts/datalad-nda\", line 244, in add2datalad\r\n    on_failure=\"stop\",\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/distribution/dataset.py\", line 503, in apply_func\r\n    return f(**kwargs)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 481, in eval_func\r\n    return return_func(generator_func)(*args, **kwargs)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 469, in return_func\r\n    results = list(results)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 400, in generator_func\r\n    allkwargs):\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 539, in _process_results\r\n    for res in results:\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/plugin/addurls.py\", line 897, in __call__\r\n    return_type='generator')\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 400, in generator_func\r\n    allkwargs):\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 539, in _process_results\r\n    for res in results:\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/core/local/create.py\", line 540, in __call__\r\n    path=tbds.path,\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/distribution/dataset.py\", line 503, in apply_func\r\n    return f(**kwargs)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 481, in eval_func\r\n    return return_func(generator_func)(*args, **kwargs)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 469, in return_func\r\n    results = list(results)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 400, in generator_func\r\n    allkwargs):\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 539, in _process_results\r\n    for res in results:\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/core/local/save.py\", line 304, in __call__\r\n    if start_commit != pds_repo.get_hexsha()\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/support/gitrepo.py\", line 1808, in get_hexsha\r\n    return self.call_git_oneline(cmd)\r\n  File \"/mnt/scrap/tmp/abcd/datalad/datalad/support/gitrepo.py\", line 2290, in call_git_oneline\r\n    .format([\"git\"] + args, lines))\r\nAssertionError: Expected ['git', 'rev-parse', '--quiet', '--verify', 'HEAD^{commit}'] to return single line, but it returned [\"rm: cannot remove '/home/yoh/.cache/git-annex/locales/bb375eb6ec0d2706f1723307f068911a': Directory not empty\", '01a0149f261576dbaf2823d63ac0a789a02af1df']\r\n\r\n> /mnt/scrap/tmp/abcd/datalad/datalad/support/gitrepo.py(2290)call_git_oneline()\r\n-> .format([\"git\"] + args, lines))\r\n```\r\n</details>\r\n\r\nfull log dump to that point is on smaug:/mnt/scrap/tmp/datalad-full4-part-20201002-1.log\r\n\r\ngit-annex is some recent snapshot...  may be that cache/locales is smth contributing to the slowness... (inspired by this -- initiated https://github.com/datalad/datalad-extensions/issues/36)\r\n\r\nedit 1: slowness is probably largely due to sandwiching too much of datalad!! It looks like `datalad-nda python script -> bash procedure -> git annex initremote -> git-annex-remote-datalad -> git/git-annex` if I got it right...\r\n\r\n<details>\r\n<summary>WTF</summary> \r\n\r\n# WTF\r\n## configuration <SENSITIVE, report disabled by configuration>\r\n## datalad \r\n  - full_version: 0.13.3.dev351-g2e67\r\n  - version: 0.13.3.dev351\r\n## dependencies \r\n  - annexremote: 1.4.3\r\n  - appdirs: 1.4.3\r\n  - boto: 2.44.0\r\n  - cmd:7z: 16.02\r\n  - cmd:annex: 8.20200908-gcfc74c2f4\r\n  - cmd:bundled-git: 2.28.0\r\n  - cmd:git: 2.28.0\r\n  - cmd:system-git: 2.28.0\r\n  - cmd:system-ssh: 7.9p1\r\n  - exifread: 2.1.2\r\n  - git: 3.0.5\r\n  - gitdb: 2.0.5\r\n  - humanize: 0.5.1\r\n  - iso8601: 0.1.11\r\n  - keyring: 17.1.1\r\n  - keyrings.alt: 3.1.1\r\n  - msgpack: 0.5.6\r\n  - mutagen: 1.40.0\r\n  - requests: 2.21.0\r\n  - wrapt: 1.10.11\r\n## environment \r\n  - GIT_PAGER: less --no-init --quit-if-one-screen\r\n  - LANG: en_US\r\n  - LANGUAGE: en_US:en\r\n  - LC_ADDRESS: en_US.UTF-8\r\n  - LC_COLLATE: en_US.UTF-8\r\n  - LC_CTYPE: en_US.UTF-8\r\n  - LC_IDENTIFICATION: en_US.UTF-8\r\n  - LC_MEASUREMENT: en_US.UTF-8\r\n  - LC_MESSAGES: en_US.UTF-8\r\n  - LC_MONETARY: en_US.UTF-8\r\n  - LC_NAME: en_US.UTF-8\r\n  - LC_NUMERIC: en_US.UTF-8\r\n  - LC_PAPER: en_US.UTF-8\r\n  - LC_TELEPHONE: en_US.UTF-8\r\n  - LC_TIME: en_US.UTF-8\r\n  - PATH: /home/yoh/.tmp/ga-RIFzW89/git-annex.linux:/mnt/scrap/tmp/abcd/datalad/venvs/dev3/bin:/home/yoh/gocode/bin:/home/yoh/gocode/bin:/home/yoh/gocode/bin:/home/yoh/bin:/home/yoh/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/games:/sbin:/usr/sbin:/usr/local/sbin\r\n## extensions \r\n  - container: \r\n    - description: Containerized environments\r\n    - entrypoints: \r\n      - datalad_container.containers_add.ContainersAdd: \r\n        - class: ContainersAdd\r\n        - load_error: None\r\n        - module: datalad_container.containers_add\r\n        - names: \r\n          - containers-add\r\n          - containers_add\r\n      - datalad_container.containers_list.ContainersList: \r\n        - class: ContainersList\r\n        - load_error: None\r\n        - module: datalad_container.containers_list\r\n        - names: \r\n          - containers-list\r\n          - containers_list\r\n      - datalad_container.containers_remove.ContainersRemove: \r\n        - class: ContainersRemove\r\n        - load_error: None\r\n        - module: datalad_container.containers_remove\r\n        - names: \r\n          - containers-remove\r\n          - containers_remove\r\n      - datalad_container.containers_run.ContainersRun: \r\n        - class: ContainersRun\r\n        - load_error: None\r\n        - module: datalad_container.containers_run\r\n        - names: \r\n          - containers-run\r\n          - containers_run\r\n    - load_error: None\r\n    - module: datalad_container\r\n    - version: 1.0.1\r\n## git-annex \r\n  - build flags: \r\n    - Assistant\r\n    - Webapp\r\n    - Pairing\r\n    - Inotify\r\n    - DBus\r\n    - DesktopNotify\r\n    - TorrentParser\r\n    - MagicMime\r\n    - Feeds\r\n    - Testsuite\r\n    - S3\r\n    - WebDAV\r\n  - dependency versions: \r\n    - aws-0.22\r\n    - bloomfilter-2.0.1.0\r\n    - cryptonite-0.26\r\n    - DAV-1.3.4\r\n    - feed-1.3.0.1\r\n    - ghc-8.8.4\r\n    - http-client-0.6.4.1\r\n    - persistent-sqlite-2.10.6.2\r\n    - torrent-10000.1.1\r\n    - uuid-1.3.13\r\n    - yesod-1.6.1.0\r\n  - key/value backends: \r\n    - SHA256E\r\n    - SHA256\r\n    - SHA512E\r\n    - SHA512\r\n    - SHA224E\r\n    - SHA224\r\n    - SHA384E\r\n    - SHA384\r\n    - SHA3_256E\r\n    - SHA3_256\r\n    - SHA3_512E\r\n    - SHA3_512\r\n    - SHA3_224E\r\n    - SHA3_224\r\n    - SHA3_384E\r\n    - SHA3_384\r\n    - SKEIN256E\r\n    - SKEIN256\r\n    - SKEIN512E\r\n    - SKEIN512\r\n    - BLAKE2B256E\r\n    - BLAKE2B256\r\n    - BLAKE2B512E\r\n    - BLAKE2B512\r\n    - BLAKE2B160E\r\n    - BLAKE2B160\r\n    - BLAKE2B224E\r\n    - BLAKE2B224\r\n    - BLAKE2B384E\r\n    - BLAKE2B384\r\n    - BLAKE2BP512E\r\n    - BLAKE2BP512\r\n    - BLAKE2S256E\r\n    - BLAKE2S256\r\n    - BLAKE2S160E\r\n    - BLAKE2S160\r\n    - BLAKE2S224E\r\n    - BLAKE2S224\r\n    - BLAKE2SP256E\r\n    - BLAKE2SP256\r\n    - BLAKE2SP224E\r\n    - BLAKE2SP224\r\n    - SHA1E\r\n    - SHA1\r\n    - MD5E\r\n    - MD5\r\n    - WORM\r\n    - URL\r\n    - X*\r\n  - operating system: linux x86_64\r\n  - remote types: \r\n    - git\r\n    - gcrypt\r\n    - p2p\r\n    - S3\r\n    - bup\r\n    - directory\r\n    - rsync\r\n    - web\r\n    - bittorrent\r\n    - webdav\r\n    - adb\r\n    - tahoe\r\n    - glacier\r\n    - ddar\r\n    - git-lfs\r\n    - httpalso\r\n    - hook\r\n    - external\r\n  - supported repository versions: \r\n    - 8\r\n  - upgrade supported from repository versions: \r\n    - 0\r\n    - 1\r\n    - 2\r\n    - 3\r\n    - 4\r\n    - 5\r\n    - 6\r\n    - 7\r\n  - version: 8.20200908-gcfc74c2f4\r\n## location \r\n  - path: /mnt/scrap/tmp/abcd\r\n  - type: directory\r\n## metadata_extractors \r\n  - annex: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.annex\r\n    - version: None\r\n  - audio: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.audio\r\n    - version: None\r\n  - datacite: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.datacite\r\n    - version: None\r\n  - datalad_core: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.datalad_core\r\n    - version: None\r\n  - datalad_rfc822: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.datalad_rfc822\r\n    - version: None\r\n  - exif: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.exif\r\n    - version: None\r\n  - frictionless_datapackage: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.frictionless_datapackage\r\n    - version: None\r\n  - image: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.image\r\n    - version: None\r\n  - xmp: \r\n    - load_error: None\r\n    - module: datalad.metadata.extractors.xmp\r\n    - version: None\r\n## python \r\n  - implementation: CPython\r\n  - version: 3.7.3\r\n## system \r\n  - distribution: debian/10.0\r\n  - encoding: \r\n    - default: utf-8\r\n    - filesystem: utf-8\r\n    - locale.prefered: UTF-8\r\n  - max_path_length: 275\r\n  - name: Linux\r\n  - release: 4.19.0-5-amd64\r\n  - type: posix\r\n  - version: #1 SMP Debian 4.19.37-5+deb10u1 (2019-07-19)\r\n\r\n</details>", "closed_by": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4976/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4976/timeline", "performed_via_github_app": null}