{"url": "https://api.github.com/repos/datalad/datalad/issues/5277", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5277/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5277/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5277/events", "html_url": "https://github.com/datalad/datalad/issues/5277", "id": 779578294, "node_id": "MDU6SXNzdWU3Nzk1NzgyOTQ=", "number": 5277, "title": "testrepo setup key issue", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 132485920, "node_id": "MDU6TGFiZWwxMzI0ODU5MjA=", "url": "https://api.github.com/repos/datalad/datalad/labels/annex", "name": "annex", "color": "0052cc", "default": false, "description": "Git-annex related issue"}, {"id": 188141023, "node_id": "MDU6TGFiZWwxODgxNDEwMjM=", "url": "https://api.github.com/repos/datalad/datalad/labels/platform-windows", "name": "platform-windows", "color": "0052cc", "default": false, "description": "Issue concerned with Windows"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2021-01-05T21:10:27Z", "updated_at": "2021-01-15T08:20:21Z", "closed_at": "2021-01-15T08:20:20Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Debugging why the basic testrepo setup on windows still does not work, which ultimately led us to disable tons of tests:\r\n\r\n```\r\n        self.repo.add_url_to_file(\"test-annex.dat\", fileurl)\r\n        self.repo.commit(\"Adding a rudimentary git-annex load file\")\r\n        self.repo.drop(\"test-annex.dat\")  # since available from URL\r\n```\r\n\r\nEither the `add_url_to_file()` call fails, or the `drop()` call fails in `populate()` of the test repo.\r\n\r\nOn the machine that I am at right now, it is the `drop()` command. The file is present, the source at the end of the URL is present to. Both files are readable. I can delete the annexed file (hence no process seems to be blocking it). Yet the `drop()` fails.\r\n\r\nCalling a dedicated `git annex drop test-annex.dat` gives:\r\n\r\n```\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex drop test-annex.dat\r\ndrop test-annex.dat\r\ngit-annex: content is locked\r\nfailed\r\ngit-annex: drop: 1 failed\r\n```\r\n\r\nnothing seems to change that\r\n```\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex fsck test-annex.dat\r\nfsck test-annex.dat (checksum...) ok\r\n\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex unlock test-annex.dat\r\n(recording state in git...)\r\n\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex drop test-annex.dat\r\ndrop test-annex.dat\r\ngit-annex: content is locked\r\nfailed\r\ngit-annex: drop: 1 failed\r\n```\r\n\r\n<details>\r\n<summary>Nothing insightful in the debug log either</summary>\r\n\r\n```\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex --debug drop test-annex.dat\r\n[2021-01-05 21:37:37.6167558] process [5316] read: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"symbolic-ref\",\"-q\",\"HEAD\"]\r\n[2021-01-05 21:37:37.6357331] process [5316] done ExitSuccess\r\n[2021-01-05 21:37:37.6377555] process [12636] read: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"show-ref\",\"refs/heads/adjusted/dl-test-branch(unlocked)\"]\r\n[2021-01-05 21:37:37.660762] process [12636] done ExitSuccess\r\n[2021-01-05 21:37:37.6637398] process [13508] read: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"ls-files\",\"--stage\",\"-z\",\"--\",\"test-annex.dat\"]\r\n[2021-01-05 21:37:37.6677381] process [11776] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"cat-file\",\"--batch-check=%(objectname) %(objecttype) %(objectsize)\",\"--buffer\"]\r\n[2021-01-05 21:37:37.6717402] process [12476] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"cat-file\",\"--batch=%(objectname) %(objecttype) %(objectsize)\",\"--buffer\"]\r\n[2021-01-05 21:37:37.6767604] process [2748] read: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"show-ref\",\"git-annex\"]\r\n[2021-01-05 21:37:37.7147348] process [2748] done ExitSuccess\r\n[2021-01-05 21:37:37.7177386] process [5124] read: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"show-ref\",\"--hash\",\"refs/heads/git-annex\"]\r\n[2021-01-05 21:37:37.7407367] process [5124] done ExitSuccess\r\n[2021-01-05 21:37:37.7567382] process [4904] read: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"log\",\"refs/heads/git-annex..340c60576e09c1f712193b5823d5da15e07915d3\",\"--pretty=%H\",\"-n1\"]\r\n[2021-01-05 21:37:37.7817393] process [4904] done ExitSuccess\r\n[2021-01-05 21:37:37.7877391] process [13132] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"hash-object\",\"-w\",\"--stdin-paths\",\"--no-filters\"]\r\n[2021-01-05 21:37:37.7927408] process [15312] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"cat-file\",\"--batch\"]\r\n[2021-01-05 21:37:37.7977415] process [12264] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"cat-file\",\"--batch-check=%(objectname) %(objecttype) %(objectsize)\"]\r\n[2021-01-05 21:37:37.800739] process [2836] feed: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"update-index\",\"-z\",\"--index-info\"]\r\n[2021-01-05 21:37:37.8047388] process [14136] read: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"diff-index\",\"--raw\",\"-z\",\"-r\",\"--no-renames\",\"-l0\",\"--cached\",\"refs/heads/git-annex\",\"--\"]\r\n[2021-01-05 21:37:37.8487403] process [14136] done ExitSuccess\r\n[2021-01-05 21:37:37.8527379] process [2836] done ExitSuccess\r\n[2021-01-05 21:37:37.8687391] process [3500] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"cat-file\",\"--batch=%(objectname) %(objecttype) %(objectsize)\",\"--buffer\"]\r\n[2021-01-05 21:37:37.899739] process [8288] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"check-attr\",\"-z\",\"--stdin\",\"annex.backend\",\"annex.numcopies\",\"annex.largefiles\",\"--\"]\r\n[2021-01-05 21:37:37.9227361] process [3872] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"cat-file\",\"--batch\"]\r\n[2021-01-05 21:37:37.9267387] process [13664] chat: git [\"--git-dir=.git\",\"--work-tree=.\",\"--literal-pathspecs\",\"cat-file\",\"--batch-check=%(objectname) %(objecttype) %(objectsize)\"]\r\ndrop test-annex.dat\r\ngit-annex: content is locked\r\nfailed\r\n[2021-01-05 21:37:37.9517345] process [3872] done ExitSuccess\r\n[2021-01-05 21:37:37.9547349] process [13664] done ExitSuccess\r\n[2021-01-05 21:37:37.9587383] process [8288] done ExitSuccess\r\n[2021-01-05 21:37:37.962735] process [13132] done ExitSuccess\r\n[2021-01-05 21:37:37.962735] process [3500] done ExitSuccess\r\n[2021-01-05 21:37:37.9637374] process done ExitSuccess\r\n[2021-01-05 21:37:37.9637374] process done ExitSuccess\r\n[2021-01-05 21:37:37.9647356] process [12476] done ExitSuccess\r\n[2021-01-05 21:37:37.965738] process [11776] done ExitSuccess\r\n[2021-01-05 21:37:37.965738] process [13508] done ExitSuccess\r\n[2021-01-05 21:37:37.965738] process done ExitSuccess\r\ngit-annex: drop: 1 failed\r\n```\r\n\r\n</details>\r\n\r\n\r\nDropping the key is not solution either\r\n\r\n```\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex drop --key SHA256E-s28--2795fb26981c5a687b9bf44930cc220029223f472cea0f0b17274f4473181e7b.dat\r\ndrop SHA256E-s28--2795fb26981c5a687b9bf44930cc220029223f472cea0f0b17274f4473181e7b.dat\r\ngit-annex: content is locked\r\nfailed\r\ngit-annex: drop: 1 failed\r\n```\r\n\r\nThis is the only annex'ed file in the entire repo:\r\n\r\n```\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex info\r\ntrusted repositories: 0\r\nsemitrusted repositories: 3\r\n        00000000-0000-0000-0000-000000000001 -- web\r\n        00000000-0000-0000-0000-000000000002 -- bittorrent\r\n        c6ce6559-ba6c-48a2-888f-4ca2b0755a00 -- datalad@latitude-e7440:~/AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8 [here]\r\nuntrusted repositories: 0\r\ntransfers in progress: none\r\navailable local disk space: 33.29 gigabytes (+1 megabyte reserved)\r\nlocal annex keys: 1\r\nlocal annex size: 28 bytes\r\nannexed files in working tree: 1\r\nsize of annexed files in working tree: 28 bytes\r\nbloom filter size: 32 mebibytes (0% full)\r\nbackend usage:\r\n        SHA256E: 1\r\n```\r\n\r\nAnd it is not about dropping in general either:\r\n\r\n```\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>echo 1234 > other.txt\r\n\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>datalad save\r\nadd(ok): other.txt (file)\r\nsave(ok): . (dataset)\r\naction summary:\r\n  add (ok: 1)\r\n  save (ok: 1)\r\n\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex drop other.txt\r\ndrop other.txt (unsafe)\r\n  Could only verify the existence of 0 out of 1 necessary copies\r\n\r\n  Rather than dropping this file, try using: git annex move\r\n\r\n  (Use --force to override this check, or adjust numcopies.)\r\nfailed\r\ngit-annex: drop: 1 failed\r\n\r\nC:\\Users\\datalad\\AppData\\Local\\Temp\\datalad_temp_testrepo_h0ro_zp8>git annex drop other.txt --force\r\ndrop other.txt ok\r\n(recording state in git...)\r\n```\r\n\r\nAnd it is not dropping a file with a public URL:\r\n\r\n```\r\nC:\\some>git annex addurl --file new.txt http://kumo.ovgu.de/~mih/annex.log\r\naddurl http://kumo.ovgu.de/~mih/annex.log\r\n(to new.txt) ok\r\n(recording state in git...)\r\n\r\nC:\\some>git commit -m some\r\n[adjusted/master(unlocked) dab4971] some\r\n 1 file changed, 1 insertion(+)\r\n create mode 100644 new.txt\r\n\r\nC:\\some>git annex drop new.txt\r\ndrop new.txt (checking http://kumo.ovgu.de/~mih/annex.log...) ok\r\n(recording state in git...)\r\n```\r\n\r\nBut something is broken in the handling of `file://` urls on windows. And that seems to break the core of the testrepo setup:\r\n\r\n```\r\nC:\\some>git -c annex.security.allowed-ip-addresses=all -c annex.security.allowed-url-schemes=\"file http\" annex addurl --file new2.txt file://C/Users/datalad/wizard.jpg\r\naddurl file://C/Users/datalad/wizard.jpg\r\n\r\ngit-annex: .git\\annex\\tmp\\URL-s80796--file&c%%C%Users%datalad%wizard.jpg: hGetContents: invalid argument (invalid byte sequence)\r\nfailed\r\ngit-annex: addurl: 1 failed\r\n```\r\n\r\nA similar `addurl` failure is also present in some windows CI runs.", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5277/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5277/timeline", "performed_via_github_app": null}