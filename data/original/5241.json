{"url": "https://api.github.com/repos/datalad/datalad/issues/5241", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5241/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5241/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5241/events", "html_url": "https://github.com/datalad/datalad/pull/5241", "id": 762120007, "node_id": "MDExOlB1bGxSZXF1ZXN0NTM2NzAwOTYx", "number": 5241, "title": "Proper handling of nested datasets in save/push/clone cycle", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1757223715, "node_id": "MDU6TGFiZWwxNzU3MjIzNzE1", "url": "https://api.github.com/repos/datalad/datalad/labels/adjusted-branches", "name": "adjusted-branches", "color": "0052cc", "default": false, "description": "Issues caused by or affected adjusted branch operation"}, {"id": 1782623847, "node_id": "MDU6TGFiZWwxNzgyNjIzODQ3", "url": "https://api.github.com/repos/datalad/datalad/labels/severity-critical", "name": "severity-critical", "color": "ff0000", "default": false, "description": "makes it unusable, causes data loss, introduces security vulnerability"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/75", "html_url": "https://github.com/datalad/datalad/milestone/75", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/75/labels", "id": 5395092, "node_id": "MDk6TWlsZXN0b25lNTM5NTA5Mg==", "number": 75, "title": "0.14.0", "description": "", "creator": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 31, "state": "closed", "created_at": "2020-05-07T17:48:31Z", "updated_at": "2021-08-05T15:29:32Z", "due_on": null, "closed_at": "2021-08-05T15:29:32Z"}, "comments": 17, "created_at": "2020-12-11T09:14:29Z", "updated_at": "2020-12-22T14:34:02Z", "closed_at": "2020-12-22T14:33:57Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/5241", "html_url": "https://github.com/datalad/datalad/pull/5241", "diff_url": "https://github.com/datalad/datalad/pull/5241.diff", "patch_url": "https://github.com/datalad/datalad/pull/5241.patch"}, "body": "Towards a fix of gh-5137 and various underlying issues.\r\n\r\nThis is a simplistic dataset workflow that must work across all platforms, as otherwise invalid datasets are being published and consumed.\r\n\r\nThe included test works on proper filesystems, but fails on crippled ones.\r\n\r\nThe goal here is to be as unimpacted from test-battery issues as possible. Hence I am going through the cmdine API, not using any testrepos, and only make use of non-highlevel API for querying to-be-tested properties.\r\n\r\nIssues:\r\n- [x] A superdataset trackes a commit in an adjusted branch for freshly created, empty subdatasets\r\n\r\n```\r\nAssertionError: Desired result\r\n  {\r\n   \"gitshasum\": \"22bcba3c3b058df33d12870782d3cd4d91c8aa94\",\r\n   \"path\": \"/media/mih/Samsung_T5/tmp/datalad_temp_test_nested_pushclone_cycle_allplatformswdj92o8g/super/sub\"\r\n  }\r\nnot found among\r\n  [\r\n   {\r\n    \"action\": \"subdataset\",\r\n    \"gitmodule_datalad-id\": \"764306ac-6647-4da5-b4fb-9edcf4977369\",\r\n    \"gitmodule_name\": \"sub\",\r\n    \"gitmodule_url\": \"./sub\",\r\n    \"gitshasum\": \"9794721d94a35243325472f5b7a40eca54662936\",\r\n    \"parentds\": \"/media/mih/Samsung_T5/tmp/datalad_temp_test_nested_pushclone_cycle_allplatformswdj92o8g/super\",\r\n    \"path\": \"/media/mih/Samsung_T5/tmp/datalad_temp_test_nested_pushclone_cycle_allplatformswdj92o8g/super/sub\",\r\n    \"refds\": \"/media/mih/Samsung_T5/tmp/datalad_temp_test_nested_pushclone_cycle_allplatformswdj92o8g/super\",\r\n    \"status\": \"ok\",\r\n    \"type\": \"dataset\"\r\n   }\r\n  ]\r\n```\r\n\r\n- [x] `save --recursive` records adjusted branch commit in superdataset\r\n       - This goes through a different code path that more or less calls `git add`, but already just on submodule paths. There should be an angle to re-use `_save_add_submodules()` or RF it to become usable for this\r\n\r\n- [x] while `git status` is expected to reported a properly saved subdataset as modified in the superdataset (due to the additional commit in the managed branch), a `datalad status` should no report such a constellation as a modification -- but presently it does, and breaks many test assumptions with it\r\n\r\n- [x] Fixes #3818 \r\n\r\n- [x] Fixes #5257.\r\n\r\n- [x] `Repo.dirty` is used by `run` to judge whether a dataset is clean. However, it uses `git status`, hence will report subdatasets in adjusted mode as modified, although they are not. We need to replace `GitRepo.dirty` with a more adequate test. It is not sufficient to implement an additional `AnnexRepo.dirty`, because it is possible that a `GitRepo` superdataset contains an adjusted `AnnexRepo` subdataset any number of levels underneath.\r\n\r\n- [x] A `GitRepo` super reports an `AnnexRepo` subdataset is modified, right after saving.\r\n\r\n- [x] `test_nested_pushclone_cycle_allplatforms` fails on AppVeyor", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5241/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5241/timeline", "performed_via_github_app": null}