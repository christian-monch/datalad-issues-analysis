{"url": "https://api.github.com/repos/datalad/datalad/issues/4929", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4929/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4929/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4929/events", "html_url": "https://github.com/datalad/datalad/issues/4929", "id": 703795354, "node_id": "MDU6SXNzdWU3MDM3OTUzNTQ=", "number": 4929, "title": "addurls: ignores on_failure=\"stop\" setting due to use of  `with_result_progress`", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 390153891, "node_id": "MDU6TGFiZWwzOTAxNTM4OTE=", "url": "https://api.github.com/repos/datalad/datalad/labels/UX", "name": "UX", "color": "0052cc", "default": false, "description": "user experience"}, {"id": 2805377474, "node_id": "MDU6TGFiZWwyODA1Mzc3NDc0", "url": "https://api.github.com/repos/datalad/datalad/labels/cmd-addurls", "name": "cmd-addurls", "color": "FEF2C0", "default": false, "description": ""}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2020-09-17T17:59:10Z", "updated_at": "2021-07-07T18:52:41Z", "closed_at": "2020-10-30T20:58:17Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "My usecase: I have following invocation \r\n```python\r\n        out = ds.addurls(\r\n            submission_file, '{associated_file}', '{path}',\r\n            exclude_autometa='*',\r\n            fast=fast,\r\n            save=False,\r\n            ifexists=\"overwrite\",\r\n            cfg_proc='nda',\r\n            on_failure=\"stop\",\r\n            # result_renderer='default'\r\n        )\r\n```\r\nwhich I run on thousands of files.  I do want it to stop as soon as an error encountered since it would make no sense to proceed forward (I want to get from clean state to clean state to save) but after a few minutes I get a first failed reported in progress bar (not sure which one) and it still has hours to go.  The only way is to interrupt but I would not even know what has failed.\r\n\r\nThe reason is: `@with_result_progress` is \"accumulating\" all returned or yielded values into the list first and then returns it.  That is what completely prevents correct treatment of `on_failure` in `_process_results`.\r\n\r\nI think ideally `@with_result_progress` should keep generator functions to be generator functions **but**, depending on the use case immediate yields could cause `_process_result` rendering of the results thus possibly interfering with the progress bars of `@with_result_progress`.  And `on_failure` is not passed into underlying functions (like `addurls` itself) so they cannot decide one way or another (fail or continue if error).  So I do not see an easy solution here yet.\r\n\r\napparently `@with_result_progress` is used only in addurls ATM within datalad-core:\r\n\r\n```shell\r\n$> git grep with_result_progress\r\ndatalad/log.py:def with_result_progress(fn, label=\"Total\", unit=\" Files\"):\r\ndatalad/plugin/addurls.py:from datalad.log import log_progress, with_result_progress\r\ndatalad/plugin/addurls.py:@with_result_progress(\"Adding URLs\")\r\ndatalad/plugin/addurls.py:@with_result_progress(\"Adding metadata\")\r\n```", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4929/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4929/timeline", "performed_via_github_app": null}