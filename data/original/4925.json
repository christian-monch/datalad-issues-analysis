{"url": "https://api.github.com/repos/datalad/datalad/issues/4925", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4925/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4925/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4925/events", "html_url": "https://github.com/datalad/datalad/pull/4925", "id": 702780986, "node_id": "MDExOlB1bGxSZXF1ZXN0NDg4MDAyNTIw", "number": 4925, "title": "ENH: log up to 100 of last lines in stderr (if log outputs) for batched processe", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-09-16T13:46:37Z", "updated_at": "2020-09-19T23:41:47Z", "closed_at": "2020-09-19T23:41:46Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/4925", "html_url": "https://github.com/datalad/datalad/pull/4925", "diff_url": "https://github.com/datalad/datalad/pull/4925.diff", "patch_url": "https://github.com/datalad/datalad/pull/4925.patch"}, "body": "I am chasing some bug in datalad/git-annex where batched addurls\r\neventually crashes with\r\n\r\n\tdatalad.cmd     [DEBUG  ] Closing stdin of <subprocess.Popen object at 0x7fa14a7cb940> and waiting process to finish\r\n\tdatalad.utils   [WARNING] Caught Command '['git', 'annex', 'addurl', '--fast', '--with-files', '--json', '--json-error-messages', '--batch']' timed out after 3.0 seconds [subprocess.py:_wait:1616] on trial #1. Sleeping 1.000000 and retrying\r\n\tdatalad.utils   [WARNING] Caught Command '['git', 'annex', 'addurl', '--fast', '--with-files', '--json', '--json-error-messages', '--batch']' timed out after 3.0 seconds [subprocess.py:_wait:1616] on trial #2. Sleeping 1.000000 and retrying\r\n\tdatalad.cmd     [WARNING] Batched process <subprocess.Popen object at 0x7fa14a7cb940> did not finish, abandoning it without killing it\r\n\tTraceback (most recent call last):\r\n\t  File \"datalad-nda/scripts/datalad-nda\", line 416, in <module>\r\n\t\tmain()\r\n\t  File \"/usr/lib/python3/dist-packages/click/core.py\", line 764, in __call__\r\n\t\treturn self.main(*args, **kwargs)\r\n\t  File \"/usr/lib/python3/dist-packages/click/core.py\", line 717, in main\r\n\t\trv = self.invoke(ctx)\r\n\t  File \"/usr/lib/python3/dist-packages/click/core.py\", line 1137, in invoke\r\n\t\treturn _process_result(sub_ctx.command.invoke(sub_ctx))\r\n\t  File \"/usr/lib/python3/dist-packages/click/core.py\", line 956, in invoke\r\n\t\treturn ctx.invoke(self.callback, **ctx.params)\r\n\t  File \"/usr/lib/python3/dist-packages/click/core.py\", line 555, in invoke\r\n\t\treturn callback(*args, **kwargs)\r\n\t  File \"datalad-nda/scripts/datalad-nda\", line 236, in add2datalad\r\n\t\ton_failure=\"stop\",\r\n\t  File \"/mnt/scrap/tmp/abcd/datalad/datalad/distribution/dataset.py\", line 503, in apply_func\r\n\t\treturn f(**kwargs)\r\n\t  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 481, in eval_func\r\n\t\treturn return_func(generator_func)(*args, **kwargs)\r\n\t  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 469, in return_func\r\n\t\tresults = list(results)\r\n\t  File \"/mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py\", line 456, in generator_func\r\n\t\tmsg=\"Command did not complete successfully\")\r\n\tdatalad.support.exceptions.IncompleteResultsError: Command did not complete successfully. 1 failed:\r\n\t[{'action': 'addurls',\r\n\t  'message': \"AnnexBatchCommandError: 'addurl' [Error, annex reported failure \"\r\n\t\t\t\t 'for addurl '\r\n\t\t\t\t \"(url='s3://NDAR_Central_2/submission_23229/derivatives/abcd-hcp-pipeline/sub-XXX/ses-baselineYear1Arm1/img/DVARS_and_FD_task-SST01.png'): \"\r\n\t\t\t\t \"{'command': 'addurl', 'success': False, 'error-messages': ['  \"\r\n\t\t\t\t \"unable to use special remote due to protocol error'], 'file': \"\r\n\t\t\t\t \"'sub-XXX/ses-baselineYear1Arm1/img/DVARS_and_FD_task-SST01.png'}] \"\r\n\t\t\t\t '[annexrepo.py:add_url_to_file:1879]',\r\n\t  'path': '/mnt/scrap/tmp/abcd/testds-fast-full2/derivatives/abcd-hcp-pipeline/sub-XXX/ses-baselineYear1Arm1/img/DVARS_and_FD_task-SST01.png',\r\n\t  'status': 'error',\r\n\t  'type': 'file'}]\r\n\r\n\t> /mnt/scrap/tmp/abcd/datalad/datalad/interface/utils.py(456)generator_func()\r\n\t-> msg=\"Command did not complete successfully\")\r\n\r\nI have no clue what is going on and since it is a sandwich of\r\ndatalad/git-annex/git-annex-remote-datalad-archives here -- it is hard to\r\nimpossible to see what is happening.  Logging last lines from stderr might give\r\na clue if would include relevant log lines from special remote log etc.\r\n\r\nTODOs\r\n- [ ] See if actually provides useful information on my usecase", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4925/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4925/timeline", "performed_via_github_app": null}