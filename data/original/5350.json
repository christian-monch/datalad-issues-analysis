{"url": "https://api.github.com/repos/datalad/datalad/issues/5350", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5350/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5350/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5350/events", "html_url": "https://github.com/datalad/datalad/pull/5350", "id": 790076354, "node_id": "MDExOlB1bGxSZXF1ZXN0NTU4MzIyNDM4", "number": 5350, "title": "RF: cmd - reuse asyncio loop if there is one, start/close new one otherwise", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1746781627, "node_id": "MDU6TGFiZWwxNzQ2NzgxNjI3", "url": "https://api.github.com/repos/datalad/datalad/labels/merge-if-ok", "name": "merge-if-ok", "color": "fbca04", "default": false, "description": "OP considers this work done, and requests review/merge"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 35, "created_at": "2021-01-20T15:22:31Z", "updated_at": "2021-04-29T21:52:56Z", "closed_at": "2021-01-22T16:14:37Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/5350", "html_url": "https://github.com/datalad/datalad/pull/5350", "diff_url": "https://github.com/datalad/datalad/pull/5350.diff", "patch_url": "https://github.com/datalad/datalad/pull/5350.patch"}, "body": "If BlockingIOError remains an issue, this change might have it resurfaced in\r\nthose use cases where datalad is used within some other asyncio app/script.\r\nBut at least it seems to mitigate current complete inability to use datalad\r\nwithin asyncio scripts such as the minimal one provided by @djarecka:\r\n\r\n    import asyncio\r\n    asyncio.get_event_loop()\r\n    import datalad.api as datalad\r\n    datalad.clone(path='/tmp/afni', source=\"https://github.com/afni/afni_data.git\")\r\n    asyncio.get_event_loop()\r\n\r\nWas not sure if not too radical for `maint` but let me know ;)\r\n\r\nAlternative to #5314 \r\n\r\nTODOs (if we decide that it is a way forward):\r\n- [x] code in above code snippet as a unittest\r\n\r\n<details>\r\n<summary>FWIW -- benchmarks are suggesting some speedups</summary> \r\n\r\n```shell\r\n       before           after         ratio\r\n     [6945d71d]       [7c34a334]\r\n     <bm/merge-target>       <bm/pr>   \r\n       1.23\u00b10.01s       1.12\u00b10.01s     0.91  api.supers.time_createadd\r\n       1.23\u00b10.01s       1.09\u00b10.02s    ~0.89  api.supers.time_createadd_to_dataset\r\n           failed           failed      n/a  api.supers.time_diff\r\n           failed           failed      n/a  api.supers.time_diff_recursive\r\n       5.93\u00b10.01s       5.56\u00b10.01s     0.94  api.supers.time_installr\r\n          232\u00b17ms          215\u00b15ms     0.92  api.supers.time_ls\r\n       2.20\u00b10.06s       2.01\u00b10.02s     0.91  api.supers.time_ls_recursive\r\n       2.34\u00b10.06s       2.19\u00b10.02s     0.94  api.supers.time_ls_recursive_long_all\r\n           failed           failed      n/a  api.supers.time_remove\r\n       1.13\u00b10.02s       1.07\u00b10.01s     0.94  api.supers.time_status\r\n       2.08\u00b10.05s       2.09\u00b10.01s     1.01  api.supers.time_status_recursive\r\n          101\u00b14ms         95.6\u00b15ms     0.94  api.supers.time_subdatasets\r\n          357\u00b16ms          347\u00b19ms     0.97  api.supers.time_subdatasets_recursive\r\n          102\u00b13ms       94.5\u00b10.9ms     0.92  api.supers.time_subdatasets_recursive_first\r\n       3.99\u00b10.07s       3.79\u00b10.01s     0.95  api.supers.time_uninstall\r\n         642\u00b120ms         599\u00b110ms     0.93  api.testds.time_create_test_dataset1\r\n       3.74\u00b10.09s       3.65\u00b10.02s     0.98  api.testds.time_create_test_dataset2x2\r\n         970\u00b140ms         957\u00b130ms     0.99  core.startup.time_help_np\r\n          158\u00b13ms          154\u00b12ms     0.97  core.startup.time_import\r\n          586\u00b17ms         585\u00b110ms     1.00  core.startup.time_import_api\r\n      2.86\u00b10.05ms       2.49\u00b10.2ms    ~0.87  core.witlessrunner.time_echo\r\n      3.27\u00b10.05ms       2.91\u00b10.1ms    ~0.89  core.witlessrunner.time_echo_gitrunner\r\n      3.52\u00b10.05ms       3.00\u00b10.1ms    ~0.85  core.witlessrunner.time_echo_gitrunner_fullcapture\r\n         486\u00b110ms         480\u00b120ms     0.99  plugins.addurls.addurls1.time_addurls('*')\r\n       2.10\u00b10.01s       2.02\u00b10.02s     0.96  plugins.addurls.addurls1.time_addurls(None)\r\n       16.5\u00b10.9ms       15.6\u00b10.5ms     0.95  repo.gitrepo.time_get_content_info\r\n      7.63\u00b10.08ms      7.55\u00b10.06ms     0.99  support.path.get_parent_paths.time_allsubmods_toplevel\r\n      7.07\u00b10.09ms         7.51\u00b11ms     1.06  support.path.get_parent_paths.time_allsubmods_toplevel_only\r\n          391\u00b16ns          360\u00b13ns     0.92  support.path.get_parent_paths.time_no_submods\r\n       6.03\u00b10.4ms      6.06\u00b10.07ms     1.01  support.path.get_parent_paths.time_one_submod_subdir\r\n      6.08\u00b10.07ms       5.95\u00b10.2ms     0.98  support.path.get_parent_paths.time_one_submod_toplevel\r\n        29.5\u00b10.3s        27.9\u00b10.3s     0.94  usecases.study_forrest.time_make_studyforrest_mockup\r\n```\r\n</details>", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5350/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5350/timeline", "performed_via_github_app": null}