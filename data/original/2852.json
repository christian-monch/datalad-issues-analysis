{"url": "https://api.github.com/repos/datalad/datalad/issues/2852", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2852/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2852/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2852/events", "html_url": "https://github.com/datalad/datalad/pull/2852", "id": 362011542, "node_id": "MDExOlB1bGxSZXF1ZXN0MjE2ODM5NTk1", "number": 2852, "title": "BF: V6: Fix file_has_content and is_under_annex for unlocked files", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/53", "html_url": "https://github.com/datalad/datalad/milestone/53", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/53/labels", "id": 3542066, "node_id": "MDk6TWlsZXN0b25lMzU0MjA2Ng==", "number": 53, "title": "Release 0.11.0", "description": "", "creator": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 40, "state": "closed", "created_at": "2018-08-02T13:36:42Z", "updated_at": "2018-10-24T18:43:30Z", "due_on": "2018-10-23T07:00:00Z", "closed_at": "2018-10-24T18:43:30Z"}, "comments": 3, "created_at": "2018-09-20T04:10:22Z", "updated_at": "2018-10-22T14:22:46Z", "closed_at": "2018-09-22T12:11:31Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/2852", "html_url": "https://github.com/datalad/datalad/pull/2852", "diff_url": "https://github.com/datalad/datalad/pull/2852.diff", "patch_url": "https://github.com/datalad/datalad/pull/2852.patch"}, "body": "`AnnexRepo.{file_has_content,is_under_annex}` get confused on unlocked files in V6. In V5, both these functions return false for unlocked files (i.e. we don't trust that the content in the working tree that replaced the symlink is unmodified). In V6, being unlocked isn't necessarily a transient state and doesn't mean that the content isn't in annex/objects, so we need a different check. This PR changes the \"return false for unlocked\" bit of the check to a more specific \"return false if the file has unstaged modifications\" in V6. The focus is on **unstaged** changes because any staged files will have already had their content added to the annex.\r\n\r\nCommits ad8525b18 and 5dc2eb495 are the ones that actually change the checks. Most of the others fix other issues in these methods (and their helpers) and aren't specific for V6.\r\n\r\nFixes #2845.\r\n\r\n---\r\n\r\n\r\n- [x] base is #2811 rather than master, but that was for my local testing and shouldn't be necessary\r\n- [x] might fail on tests outside of the limited ones I tested locally (edit: passing now)\r\n- [ ] doesn't address requested [change in sematics](https://github.com/datalad/datalad/issues/2845#issuecomment-422834346)\r\n      IMO this should be done in a separate PR.\r\n", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2852/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2852/timeline", "performed_via_github_app": null}