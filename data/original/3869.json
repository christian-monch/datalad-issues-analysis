{"url": "https://api.github.com/repos/datalad/datalad/issues/3869", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3869/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3869/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3869/events", "html_url": "https://github.com/datalad/datalad/issues/3869", "id": 523554105, "node_id": "MDU6SXNzdWU1MjM1NTQxMDU=", "number": 3869, "title": "Behavior with large N datasets", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 289240596, "node_id": "MDU6TGFiZWwyODkyNDA1OTY=", "url": "https://api.github.com/repos/datalad/datalad/labels/performance", "name": "performance", "color": "f4b2d8", "default": false, "description": "Improve performance of an existing feature"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 18, "created_at": "2019-11-15T16:02:49Z", "updated_at": "2020-08-03T13:13:43Z", "closed_at": "2020-05-30T07:44:05Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Demo dataset with 100k tiny files. A size like this is often considered the upper sensible limit of numbers of files.  Each file is placed in a 4th-level subdirectory, because I find that is a frequent average depth in the datasets that I work with.\r\n\r\n```sh\r\n$ for i in $(seq 100000); do s=$(uuid | tr '-' '/'); mkdir -p ${s:5:19} && echo $s > ${s:5}; done\r\n# [7min, total size <4MB]\r\n```\r\n\r\nCreate a dataset\r\n\r\n```sh\r\n/tmp/big % time datalad create -f\r\n[INFO   ] Creating a new annex repo at /tmp/big \r\ncreate(ok): /tmp/big (dataset)                                                               \r\ndatalad create -f  1.03s user 0.52s system 66% cpu 2.327 total\r\n```\r\n\r\n```sh\r\n/tmp/big (git)-[master] % time datalad save\r\nTotal (100000 ok out of 100000): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3.70M/3.70M [12:50<00:00, 12.0kB/s]\r\n<snip 99999 lines>\r\nadd(ok): ffe/07be/11ea/ba1c/1fdd75885bdc (file)\r\nsave(ok): . (dataset)\r\naction summary:\r\n  add (ok: 100000)\r\n  save (ok: 1)\r\ndatalad save  781.46s user 189.75s system 109% cpu 14:46.91 total\r\n```\r\n\r\nFirst, it works! Second, every ~30k files, my machine took a break (desktop sluggish). It seems inside `git-annex-add` numerous `git ls-files` processes (among others) are started. I am attaching a `pstree` of a moment in such a phase that has ~100 such processes running.\r\n\r\n[ptree.txt](https://github.com/datalad/datalad/files/3852232/ptree.txt)\r\n\r\nNB: while we are calling `git-annex-add` in batches with long lists of filenames already, `git-annex` itself further splits to-be-processed files into (smaller) batches.\r\n\r\nThe result renderer output is completely useless (100k `add(ok)` lines), nobody knows if there was an important message on top.\r\n\r\nIt took 2x longer to save the files than to create them on the file system -- not too bad IMHO.\r\n\r\n```sh\r\n% time datalad status\r\ndatalad status  60.22s user 13.44s system 61% cpu 2:00.10 total\r\n% time datalad status -t raw\r\ndatalad status -t raw  6.09s user 1.45s system 100% cpu 7.487 total\r\n\r\n% time datalad save\r\ndatalad save  8.90s user 1.56s system 99% cpu 10.485 total\r\n```\r\n\r\nSensible IMHO. With a hot cache `git status` does\r\n\r\n```\r\n% time git status\r\nOn branch master\r\nnothing to commit, working tree clean\r\ngit status  0.42s user 0.94s system 127% cpu 1.064 total\r\n```\r\n\r\nand here some truths:\r\n\r\n```\r\n/tmp/big (git)-[master] % find . |wc -l\r\n506736\r\n/tmp/big (git)-[master] % find .git |wc -l\r\n296571\r\n /tmp/big (git)-[master] % du -sh .git\r\n1.3G    .git\r\n/tmp/big (git)-[master] % git gc --aggressive\r\nEnumerating objects: 425779, done.\r\nCounting objects: 100% (425779/425779), done.\r\nDelta compression using up to 4 threads\r\nCompressing objects: 100% (321825/321825), done.\r\nWriting objects: 100% (425779/425779), done.\r\nTotal 425779 (delta 11506), reused 414271 (delta 0)\r\ngit gc --aggressive  36.98s user 0.80s system 294% cpu 12.810 total\r\n/tmp/big (git)-[master] % du -sh .git\r\n1.3G    .git\r\n/tmp/big (git)-[master] % du -sh .git/annex\r\n1.2G    .git/annex\r\n/tmp/big (git)-[master] % du -sh .git/annex/objects\r\n1.2G    .git/annex/objects\r\n/tmp/big (git)-[master] % du -hc *\r\n<snip>\r\n821M    total\r\n```\r\n\r\nI did another test run with 500k files, but my machine ooops'ed after almost exactly one hour.It started to throw `add(error)` results afterwards.On reboot it took 8min to empty `/tmp` ;-)", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3869/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3869/timeline", "performed_via_github_app": null}