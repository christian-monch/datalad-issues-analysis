{"url": "https://api.github.com/repos/datalad/datalad/issues/4526", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4526/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4526/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4526/events", "html_url": "https://github.com/datalad/datalad/pull/4526", "id": 617808439, "node_id": "MDExOlB1bGxSZXF1ZXN0NDE3NjU3MjY3", "number": 4526, "title": "OPT: save - do not bother running full status within subdatasets unless recursive", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 390153891, "node_id": "MDU6TGFiZWwzOTAxNTM4OTE=", "url": "https://api.github.com/repos/datalad/datalad/labels/UX", "name": "UX", "color": "0052cc", "default": false, "description": "user experience"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/71", "html_url": "https://github.com/datalad/datalad/milestone/71", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/71/labels", "id": 5127107, "node_id": "MDk6TWlsZXN0b25lNTEyNzEwNw==", "number": 71, "title": "0.13.0", "description": "With all the interface removals, we are doomed for at least a new minor release.", "creator": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 49, "state": "closed", "created_at": "2020-02-20T19:12:55Z", "updated_at": "2020-06-24T23:01:53Z", "due_on": "2020-06-22T07:00:00Z", "closed_at": "2020-06-24T23:01:53Z"}, "comments": 3, "created_at": "2020-05-13T23:03:17Z", "updated_at": "2020-05-21T17:41:07Z", "closed_at": "2020-05-15T17:35:03Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/4526", "html_url": "https://github.com/datalad/datalad/pull/4526", "diff_url": "https://github.com/datalad/datalad/pull/4526.diff", "patch_url": "https://github.com/datalad/datalad/pull/4526.patch"}, "body": "Closes: #4523 \r\n\r\nI guess if all the other tests pass, this change does not break any \"semantic\" which would be great.\r\n\r\nNotes:\r\n- Even while being very basic, the unittest is quite slow (24sec) on my laptop. ~~`save` is \"non trivial\" even in this tiny datasets, heh.~~ my bet has to do with that infinite recursion mentioned below \r\n\r\nPossible TODOs:\r\n\r\n- It is an incomplete solution: it would still do \"full\" (and thus eg fail the test if added) if I do recursive=True even if should be cut off by `recursion_limit` parameter, which suggests that this location is not ideal for this fix (if there is any better).\r\n- That exception I am catching in the test, which is supposed to be  CommandError causes some other meltdown somewhere\r\n\r\n<details>\r\n<summary>Here is the displayed traceback which I do not know where to attribute to</summary> \r\n\r\n```shell\r\n======================================================================\r\nERROR: datalad.core.local.tests.test_save.test_subsuperdataset_save\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/nose/case.py\", line 197, in runTest\r\n    self.test(*self.arg)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/tests/utils.py\", line 691, in newfunc\r\n    return t(*(arg + (filename,)), **kw)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/core/local/tests/test_save.py\", line 232, in test_subsuperdataset_save\r\n    assert_raises(CommandError, parent.save, 'sub1', recursive=True)\r\n  File \"/usr/lib/python3.7/unittest/case.py\", line 756, in assertRaises\r\n    return context.handle('assertRaises', args, kwargs)\r\n  File \"/usr/lib/python3.7/unittest/case.py\", line 178, in handle\r\n    callable_obj(*args, **kwargs)\r\n  File \"/usr/lib/python3/dist-packages/wrapt/wrappers.py\", line 603, in __call__\r\n    args, kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/distribution/dataset.py\", line 498, in apply_func\r\n    return f(**kwargs)\r\n  File \"/usr/lib/python3/dist-packages/wrapt/wrappers.py\", line 564, in __call__\r\n    args, kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 494, in eval_func\r\n    return return_func(generator_func)(*args, **kwargs)\r\n  File \"/usr/lib/python3/dist-packages/wrapt/wrappers.py\", line 564, in __call__\r\n    args, kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 482, in return_func\r\n    results = list(results)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 413, in generator_func\r\n    allkwargs):\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 552, in _process_results\r\n    for res in results:\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/core/local/save.py\", line 211, in __call__\r\n    result_renderer='disabled'):\r\n  File \"/usr/lib/python3/dist-packages/wrapt/wrappers.py\", line 564, in __call__\r\n    args, kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 494, in eval_func\r\n    return return_func(generator_func)(*args, **kwargs)\r\n  File \"/usr/lib/python3/dist-packages/wrapt/wrappers.py\", line 564, in __call__\r\n    args, kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 482, in return_func\r\n    results = list(results)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 413, in generator_func\r\n    allkwargs):\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 552, in _process_results\r\n    for res in results:\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/core/local/status.py\", line 413, in __call__\r\n    content_info_cache):\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/core/local/status.py\", line 152, in _yield_status\r\n    cache):\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/core/local/status.py\", line 152, in _yield_status\r\n    cache):\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/core/local/status.py\", line 152, in _yield_status\r\n    cache):\r\n  [Previous line repeated 924 more times]\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/core/local/status.py\", line 114, in _yield_status\r\n    fr='HEAD' if repo.get_hexsha() else None,\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/support/gitrepo.py\", line 1747, in get_hexsha\r\n    commitish)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/support/gitrepo.py\", line 1718, in format_commit\r\n    '', cmd, expect_stderr=True, expect_fail=True)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/support/gitrepo.py\", line 328, in newfunc\r\n    result = func(self, files_new, *args, **kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/support/gitrepo.py\", line 2058, in _git_custom_command\r\n    expect_fail=expect_fail)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/cmd.py\", line 143, in run_gitcommand_on_file_list_chunks\r\n    results.append(func(cmd, *args, **kwargs))\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/cmd.py\", line 1114, in run\r\n    *args, **kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/cmd.py\", line 883, in run\r\n    stdin=stdin)\r\n  File \"/usr/lib/python3.7/subprocess.py\", line 800, in __init__\r\n    restore_signals, start_new_session)\r\n  File \"/usr/lib/python3.7/subprocess.py\", line 1472, in _execute_child\r\n    for dir in os.get_exec_path(env))\r\n  File \"/home/yoh/proj/datalad/datalad-master/venvs/dev3/lib/python3.7/os.py\", line 637, in get_exec_path\r\n    warnings.simplefilter(\"ignore\", BytesWarning)\r\n  File \"/home/yoh/proj/datalad/datalad-master/venvs/dev3/lib/python3.7/warnings.py\", line 179, in simplefilter\r\n    _add_filter(action, None, category, None, lineno, append=append)\r\n  File \"/home/yoh/proj/datalad/datalad-master/venvs/dev3/lib/python3.7/warnings.py\", line 186, in _add_filter\r\n    filters.remove(item)\r\nRecursionError: maximum recursion depth exceeded in comparison\r\n```\r\n</details>\r\nRunning with high log level eventually started to bombard me with the lines\r\n\r\n<details>\r\n<summary>at the bottom of this:</summary> \r\n\r\n```shell\r\n2020-05-13 19:14:45,797 [DEBUG  ] ...>gitrepo:3399  Done AnnexRepo(/home/yoh/.tmp/datalad_temp_test_subsuperdataset_savewi9yqcg_/sub1/sub2/sub3).get_content_info(...) \r\n2020-05-13 19:14:45,798 [Level 5] ...>cmd:1010  Running: ['git', 'ls-files', '-z', '-m'] \r\n2020-05-13 19:14:45,825 [Level 8] ...>cmd:1010  Finished running ['git', 'ls-files', '-z', '-m'] with status 0 \r\n2020-05-13 19:14:45,827 [DEBUG  ] ...>gitrepo:3289  AnnexRepo(/home/yoh/.tmp/datalad_temp_test_subsuperdataset_savewi9yqcg_/sub1/sub2/sub3).get_content_info(...) \r\n2020-05-13 19:14:45,827 [DEBUG  ] ...>gitrepo:3339  Query repo: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] \r\n2020-05-13 19:14:45,827 [Level 5] ...>cmd:1010  Running: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] \r\n2020-05-13 19:14:45,865 [Level 8] ...>cmd:1010  Finished running ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] with status 0 \r\n2020-05-13 19:14:45,866 [DEBUG  ] ...>gitrepo:3356  Done query repo: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] \r\n2020-05-13 19:14:45,867 [DEBUG  ] ...>gitrepo:3399  Done AnnexRepo(/home/yoh/.tmp/datalad_temp_test_subsuperdataset_savewi9yqcg_/sub1/sub2/sub3).get_content_info(...) \r\n2020-05-13 19:14:45,868 [DEBUG  ] ...>status:112  query AnnexRepo(/home/yoh/.tmp/datalad_temp_test_subsuperdataset_savewi9yqcg_/sub1/sub2/sub3).diffstatus() for paths: None \r\n2020-05-13 19:14:45,870 [Level 5] ...>cmd:1010  Running: ['git', 'show', '-z', '--no-patch', '--format=%H', '--'] \r\n2020-05-13 19:14:45,916 [Level 8] ...>cmd:1010  Finished running ['git', 'show', '-z', '--no-patch', '--format=%H', '--'] with status 0 \r\n2020-05-13 19:14:45,917 [DEBUG  ] ...>status:112  query AnnexRepo(/home/yoh/.tmp/datalad_temp_test_subsuperdataset_savewi9yqcg_/sub1/sub2/sub3).diffstatus() for paths: None \r\n2020-05-13 19:14:45,918 [Level 5] ...>cmd:1010  Running: ['git', 'show', '-z', '--no-patch', '--format=%H', '--'] \r\n2020-05-13 19:14:45,956 [Level 8] ...>cmd:1010  Finished running ['git', 'show', '-z', '--no-patch', '--format=%H', '--'] with status 0 \r\n2020-05-13 19:14:45,957 [DEBUG  ] ...>status:112  query AnnexRepo(/home/yoh/.tmp/datalad_temp_test_subsuperdataset_savewi9yqcg_/sub1/sub2/sub3).diffstatus() for paths: None \r\n2020-05-13 19:14:45,959 [Level 5] ...>cmd:1010  Running: ['git', 'show', '-z', '--no-patch', '--format=%H', '--'] \r\n2020-05-13 19:14:46,001 [Level 8] ...>cmd:1010  Finished running ['git', 'show', '-z', '--no-patch', '--format=%H', '--'] with status 0 \r\n2020-05-13 19:14:46,005 [DEBUG  ] ...>status:112  query AnnexRepo(/home/yoh/.tmp/datalad_temp_test_subsuperdataset_savewi9yqcg_/sub1/sub2/sub3).diffstatus() for paths: None \r\n...\r\n```\r\n</details>", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4526/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4526/timeline", "performed_via_github_app": null}