{"url": "https://api.github.com/repos/datalad/datalad/issues/3990", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3990/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3990/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3990/events", "html_url": "https://github.com/datalad/datalad/issues/3990", "id": 547025121, "node_id": "MDU6SXNzdWU1NDcwMjUxMjE=", "number": 3990, "title": "datalad diff against the worktree (even without -r) cannot be prevented to look through an entire dataset hierarchy", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 289240596, "node_id": "MDU6TGFiZWwyODkyNDA1OTY=", "url": "https://api.github.com/repos/datalad/datalad/labels/performance", "name": "performance", "color": "f4b2d8", "default": false, "description": "Improve performance of an existing feature"}, {"id": 390153891, "node_id": "MDU6TGFiZWwzOTAxNTM4OTE=", "url": "https://api.github.com/repos/datalad/datalad/labels/UX", "name": "UX", "color": "0052cc", "default": false, "description": "user experience"}, {"id": 2803341545, "node_id": "MDU6TGFiZWwyODAzMzQxNTQ1", "url": "https://api.github.com/repos/datalad/datalad/labels/cmd-diff", "name": "cmd-diff", "color": "FEF2C0", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2020-01-08T18:15:46Z", "updated_at": "2021-03-08T16:22:41Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "which makes it unusable (not just \"slightly slower\") on any sizeable hierarchy:\r\n\r\nthe last commit has modified adhd200 only:\r\n```shell\r\n$> git show \r\ncommit 43c6e439c4fd99297fdf21248d655388a3574bfb (HEAD -> master, datalad-public/synced/master, datalad-public/master, synced/master)\r\nAuthor: Yaroslav Halchenko <debian@onerussian.com>\r\nDate:   Wed Jan 8 13:00:24 2020 -0500\r\n\r\n    Recrawled adhd200 to fetch some fixes to BIDS\r\n\r\ndiff --git a/adhd200 b/adhd200\r\nindex 66ac19a..91451a1 160000\r\n--- a/adhd200\r\n+++ b/adhd200\r\n@@ -1 +1 @@\r\n-Subproject commit 66ac19a7a1e68a2b2f03c77c77e9b5f79009f9d1\r\n+Subproject commit 91451a19f2ea160cb38a8658745501f8a91287f9\r\n```\r\nso I expect `datalad diff -f HEAD^` be concerned only comparing that difference, but it ventures to explore other subdatasets as well right away:\r\n \r\n```shell\r\n$> time datalad -l debug diff -r -f HEAD^\r\n[DEBUG  ] Command line args 1st pass. Parsed: Namespace(common_output_format='HEAD^') Unparsed: ['diff', '-r']\r\n[DEBUG  ] Discovering plugins\r\n[DEBUG  ] Building doc for <class 'datalad.core.local.status.Status'>\r\n[DEBUG  ] Building doc for <class 'datalad.core.local.diff.Diff'>\r\n[DEBUG  ] Parsing known args among ['/home/yoh/proj/datalad/datalad-master/venvs/dev3/bin/datalad', '-l', 'debug', 'diff', '-r', '-f', 'HEAD^']\r\n[DEBUG  ] Determined class of decorated function: <class 'datalad.core.local.diff.Diff'>\r\n[DEBUG  ] Resolved dataset for difference reporting: /mnt/btrfs/datasets/datalad/crawl\r\n[DEBUG  ] diff <Dataset path=/mnt/btrfs/datasets/datalad/crawl> from 'HEAD^' to 'None'\r\n[DEBUG  ] <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG  ] Query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG  ] Done query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG  ] Done <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG  ] <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG  ] Query repo: ['git', 'ls-tree', 'HEAD^', '-z', '-r', '--full-tree', '-l']\r\n[DEBUG  ] Done query repo: ['git', 'ls-tree', 'HEAD^', '-z', '-r', '--full-tree', '-l']\r\n[DEBUG  ] Initiating a new process for BatchedCommand(cmd=['git', 'cat-file', '--batch'], output_proc=<function>, path=<<'/mnt/btrfs/datasets/d...>>)\r\n[DEBUG  ] Closing stdin of <subprocess.Popen object at 0x7f4365d3cf60> and waiting process to finish\r\n[DEBUG  ] Process <subprocess.Popen object at 0x7f4365d3cf60> has finished\r\n[DEBUG  ] Done <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG  ] <GitRepo path=/mnt/btrfs/datasets/datalad/crawl/abide (<class 'datalad.support.gitrepo.GitRepo'>)>.get_content_info(...)\r\n[DEBUG  ] Query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG  ] Done query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG  ] Done <GitRepo path=/mnt/btrfs/datasets/datalad/crawl/abide (<class 'datalad.support.gitrepo.GitRepo'>)>.get_content_info(...)\r\n[DEBUG  ] <GitRepo path=/mnt/btrfs/datasets/datalad/crawl/abide (<class 'datalad.support.gitrepo.GitRepo'>)>.get_content_info(...)\r\n[DEBUG  ] Query repo: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l']\r\n...\r\n```\r\nso you could see `abide` etc in there.  Even without `-r` it jumps into other subdatasets:\r\n```\r\n$> time datalad -l debug diff -f HEAD^ | head\r\n[DEBUG] Command line args 1st pass. Parsed: Namespace(common_output_format='HEAD^') Unparsed: ['diff']\r\n[DEBUG] Discovering plugins\r\n[DEBUG] Building doc for <class 'datalad.core.local.status.Status'>\r\n[DEBUG] Building doc for <class 'datalad.core.local.diff.Diff'>\r\n[DEBUG] Parsing known args among ['/home/yoh/proj/datalad/datalad-master/venvs/dev3/bin/datalad', '-l', 'debug', 'diff', '-f', 'HEAD^']\r\n[DEBUG] Determined class of decorated function: <class 'datalad.core.local.diff.Diff'>\r\n[DEBUG] Resolved dataset for difference reporting: /mnt/btrfs/datasets/datalad/crawl\r\n[DEBUG] diff <Dataset path=/mnt/btrfs/datasets/datalad/crawl> from 'HEAD^' to 'None'\r\n[DEBUG] <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG] Query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG] Done query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG] Done <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG] <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG] Query repo: ['git', 'ls-tree', 'HEAD^', '-z', '-r', '--full-tree', '-l']\r\n[DEBUG] Done query repo: ['git', 'ls-tree', 'HEAD^', '-z', '-r', '--full-tree', '-l']\r\n[DEBUG] Initiating a new process for BatchedCommand(cmd=['git', 'cat-file', '--batch'], output_proc=<function>, path=<<'/mnt/btrfs/datasets/d...>>)\r\n[DEBUG] Closing stdin of <subprocess.Popen object at 0x7f16eeca9f60> and waiting process to finish\r\n[DEBUG] Process <subprocess.Popen object at 0x7f16eeca9f60> has finished\r\n[DEBUG] Done <AnnexRepo path=/mnt/btrfs/datasets/datalad/crawl (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...)\r\n[DEBUG] <GitRepo path=/mnt/btrfs/datasets/datalad/crawl/abide (<class 'datalad.support.gitrepo.GitRepo'>)>.get_content_info(...)\r\n[DEBUG] Query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG] Done query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o', '--directory', '--no-empty-directory']\r\n[DEBUG] Done <GitRepo path=/mnt/btrfs/datasets/datalad/crawl/abide (<class 'datalad.support.gitrepo.GitRepo'>)>.get_content_info(...) \r\n[DEBUG] <GitRepo path=/mnt/btrfs/datasets/datalad/crawl/abide (<class 'datalad.support.gitrepo.GitRepo'>)>.get_content_info(...) \r\n[DEBUG] Query repo: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] \r\n[DEBUG] Done query repo: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] \r\n...\r\n```", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3990/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3990/timeline", "performed_via_github_app": null}