{"url": "https://api.github.com/repos/datalad/datalad/issues/5709", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5709/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5709/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5709/events", "html_url": "https://github.com/datalad/datalad/pull/5709", "id": 910872287, "node_id": "MDExOlB1bGxSZXF1ZXN0NjYxMjI5NzYx", "number": 5709, "title": "ENH+RF+BF:  github - sanitize top level reponame + make hierarchies datasets install/get-able from github", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1453907298, "node_id": "MDU6TGFiZWwxNDUzOTA3Mjk4", "url": "https://api.github.com/repos/datalad/datalad/labels/stale-PR-closed-without-merge", "name": "stale-PR-closed-without-merge", "color": "ffffff", "default": false, "description": ""}, {"id": 1746781627, "node_id": "MDU6TGFiZWwxNzQ2NzgxNjI3", "url": "https://api.github.com/repos/datalad/datalad/labels/merge-if-ok", "name": "merge-if-ok", "color": "fbca04", "default": false, "description": "OP considers this work done, and requests review/merge"}, {"id": 3049454433, "node_id": "MDU6TGFiZWwzMDQ5NDU0NDMz", "url": "https://api.github.com/repos/datalad/datalad/labels/patch", "name": "patch", "color": "870048", "default": false, "description": "Increment the patch version when merged"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 21, "created_at": "2021-06-03T21:36:28Z", "updated_at": "2021-07-08T15:43:43Z", "closed_at": "2021-07-08T15:43:42Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/5709", "html_url": "https://github.com/datalad/datalad/pull/5709", "diff_url": "https://github.com/datalad/datalad/pull/5709.diff", "patch_url": "https://github.com/datalad/datalad/pull/5709.patch"}, "body": "Please see the first commit which RFs and IMHO BFs our github repo name sanitization - it should address detected issue of us incorrectly assessing either top level repository is \"existing\" if its name was sanitized by github (or us) when it was created.\r\n\r\nThe second commit (details from commit message are pasted below) is the main purpose for this PR. The immediate use-case is to finally deploy https://github.com/con/tinuous/ to collect/archive CI logs for DataLad etc.  I think I will just publish them as hierarchies of the private datasets (one per month) under some dedicated organization (e.g. datalad-logs) so all team members could have access to them. But the `create-sibling-github -r` created hierarchies are not immediately available to `install -r` or `get [-r]` operations, hence this PR to address it.\r\n \r\n    This change introduces special handling for github URLs.  Since we do\r\n    have `create-sibling-github` I think it is Ok to also provide special\r\n    handling for such dataset hierarchies created on github (by DataLad)\r\n    within DataLad:\r\n    \r\n    - before this change we were using POSIX-style composition for all URL\r\n      + path, even though we know that it would not work for GitHub\r\n    \r\n    - we do our \"sanitization\" of repository names we provide to GitHub\r\n      upon create-sibling-github.  So we are the \"central\" place with\r\n      that logic on sanitization (see previous commit -- our logic is\r\n      different from github's)\r\n    \r\n    An alternative solution I considered:\r\n    \r\n    Add an option to `create-sibling-github` to populate full fledged urls\r\n    within .gitmodules.  I've decided against it for a number of reasons:\r\n    \r\n    - per above reasoning -- we are already doing the wrong thing\r\n      by trying POSIX-style composition on github urls, so it should\r\n            go even if for the purpose of not wasting CPU/bandwidth\r\n    \r\n    - GitHub could be one of many remotes, thus it might not be\r\n      desirable to \"hard-code\" the full url to github within .gitmodules\r\n    \r\n    - already created hierarchies would need fix ups got .gitmodules to\r\n      provide full urls\r\n\r\nWith this PR I can do full round-trip like\r\n\r\n```shell\r\n#!/bin/bash\r\n\r\nexport PS4='> '\r\nset -x\r\nset -eu\r\ncd \"$(mktemp -d ${TMPDIR:-/tmp}/dl-XXXXXXX)\"\r\n\r\ndatalad create \"test  gh4\"; \r\ncd \"test  gh4\"; \r\ndatalad create -d . \"sub _1\"\r\ndatalad create -d . \"sub _1/d/sub_sub- 1\"\r\n\r\ndatalad create-sibling-github -s github --github-organization dl-throwaway --existing replace -r \"test  gh4\"\r\ndatalad push --to github -r;\r\n\r\ndatalad install -r -s git://github.com/dl-throwaway/test_gh4 ../dest\r\n```\r\n\r\n<details>\r\n<summary>output of the interesting part</summary> \r\n\r\n```shell\r\n> datalad create-sibling-github -s github --github-organization dl-throwaway --existing replace -r 'test  gh4'\r\n[INFO   ] Successfully obtained information about organization dl-throwaway using token 765... \r\n.: github(-) [https://github.com/dl-throwaway/test_gh4.git (git)]\r\n.: github(-) [https://github.com/dl-throwaway/test_gh4-sub__1.git (git)]\r\n.: github(-) [https://github.com/dl-throwaway/test_gh4-sub__1-d-sub_sub-_1.git (git)]\r\n'https://github.com/dl-throwaway/test_gh4.git' configured as sibling 'github' for Dataset('/home/yoh/.tmp/dl-g82eogS/test  gh4')\r\n'https://github.com/dl-throwaway/test_gh4-sub__1.git' configured as sibling 'github' for Dataset('/home/yoh/.tmp/dl-g82eogS/test  gh4/sub _1')\r\n'https://github.com/dl-throwaway/test_gh4-sub__1-d-sub_sub-_1.git' configured as sibling 'github' for Dataset('/home/yoh/.tmp/dl-g82eogS/test  gh4/sub _1/d/sub_sub- 1')\r\n> datalad push --to github -r\r\npublish(ok): sub _1/d/sub_sub- 1 (dataset) [refs/heads/master->github:refs/heads/master [new branch]]     \r\npublish(ok): sub _1/d/sub_sub- 1 (dataset) [refs/heads/git-annex->github:refs/heads/git-annex [new branch]]\r\npublish(ok): sub _1 (dataset) [refs/heads/master->github:refs/heads/master [new branch]]                  \r\npublish(ok): sub _1 (dataset) [refs/heads/git-annex->github:refs/heads/git-annex [new branch]]            \r\npublish(ok): . (dataset) [refs/heads/master->github:refs/heads/master [new branch]]                       \r\npublish(ok): . (dataset) [refs/heads/git-annex->github:refs/heads/git-annex [new branch]]                 \r\n> datalad install -r -s git://github.com/dl-throwaway/test_gh4 ../dest                                    \r\n[INFO   ] scanning for unlocked files (this may take some time)                                           \r\n[INFO   ] Remote origin uses a protocol not supported by git-annex; setting annex-ignore                  \r\ninstall(ok): /home/yoh/.tmp/dl-g82eogS/dest (dataset)\r\n[INFO   ] Installing Dataset(/home/yoh/.tmp/dl-g82eogS/dest) to get /home/yoh/.tmp/dl-g82eogS/dest recursively \r\n[INFO   ] scanning for unlocked files (this may take some time) \r\n[INFO   ] Remote origin uses a protocol not supported by git-annex; setting annex-ignore                  \r\ninstall(ok): /home/yoh/.tmp/dl-g82eogS/dest/sub _1 (dataset)                                              \r\n[INFO   ] scanning for unlocked files (this may take some time)                                           \r\n[INFO   ] Remote origin uses a protocol not supported by git-annex; setting annex-ignore                  \r\ninstall(ok): /home/yoh/.tmp/dl-g82eogS/dest/sub _1/d/sub_sub- 1 (dataset)                                 \r\naction summary:                                                                                           \r\n  install (ok: 3)\r\nbash gh-recursive  12.14s user 3.39s system 41% cpu 37.848 total\r\n\r\n```\r\n</details>\r\n\r\nI am also ok to rebase this on  top of master (seems to be not merging cleanly) -- I think we should release `master` quite soon with its new WitlessRunner anyways ;-)", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5709/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5709/timeline", "performed_via_github_app": null}