{"url": "https://api.github.com/repos/datalad/datalad/issues/3974", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3974/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3974/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3974/events", "html_url": "https://github.com/datalad/datalad/issues/3974", "id": 543878706, "node_id": "MDU6SXNzdWU1NDM4Nzg3MDY=", "number": 3974, "title": "get_local_file_url() broken on windows (i.e. for use as annex input)", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 188141023, "node_id": "MDU6TGFiZWwxODgxNDEwMjM=", "url": "https://api.github.com/repos/datalad/datalad/labels/platform-windows", "name": "platform-windows", "color": "0052cc", "default": false, "description": "Issue concerned with Windows"}, {"id": 440544386, "node_id": "MDU6TGFiZWw0NDA1NDQzODY=", "url": "https://api.github.com/repos/datalad/datalad/labels/fix-implemented", "name": "fix-implemented", "color": "0e8a16", "default": false, "description": "A fix is available, but has not been merged or released, yet."}], "state": "closed", "locked": false, "assignee": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 1, "created_at": "2019-12-30T13:23:31Z", "updated_at": "2020-01-02T09:14:35Z", "closed_at": "2020-01-02T09:14:35Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "In short:\r\n\r\n```\r\n======================================================================\r\nERROR: datalad.tests.test_utils_testrepos.test_BasicAnnexTestRepo_random_location_generated\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"C:\\Users\\mih\\Miniconda3\\lib\\site-packages\\nose\\case.py\", line 198, in runTest\r\n    self.test(*self.arg)\r\n  File \"C:\\Users\\mih\\code\\datalad\\datalad\\tests\\test_utils_testrepos.py\", line 42, in test_BasicAnnexTestRepo_random_location_generated\r\n    _test_BasicAnnexTestRepo(None)  # without explicit path -- must be generated\r\n  File \"C:\\Users\\mih\\code\\datalad\\datalad\\tests\\test_utils_testrepos.py\", line 28, in _test_BasicAnnexTestRepo\r\n    trepo.create()\r\n  File \"C:\\Users\\mih\\code\\datalad\\datalad\\tests\\utils_testrepos.py\", line 90, in create\r\n    self.populate()\r\n  File \"C:\\Users\\mih\\code\\datalad\\datalad\\tests\\utils_testrepos.py\", line 117, in populate\r\n    self.repo.add_url_to_file(\"test-annex.dat\", fileurl)\r\n  File \"C:\\Users\\mih\\code\\datalad\\datalad\\support\\gitrepo.py\", line 231, in newfunc\r\n    return func(self, file_new, *args, **kwargs)\r\n  File \"C:\\Users\\mih\\code\\datalad\\datalad\\support\\annexrepo.py\", line 1895, in add_url_to_file\r\n    % (url, str(out_json)))\r\ndatalad.support.exceptions.CommandError: CommandError: command 'addurl'\r\nError, annex reported failure for addurl (url='file:///C%3A/Users/mih/AppData/Local/Temp/datalad_temp_testrepo_fpl3aaoz'): {'command': 'addurl', 'success': False, 'error-messages': ['  download failed: /C:/Users/mih/AppData/Local/Temp/datalad_temp_testrepo_fpl3aaoz: openBinaryFile: invalid argument (Invalid argument)'], 'file': 'test-annex.dat'}\r\n```\r\n\r\nThis function is used at the core of the testrepo setup, hence its breakage is a key reason for the disfunctionality of a large part of our test battery on windows.\r\n\r\nIt took me forever to find this, because the tests that cover it were disabled 4 years ago https://github.com/datalad/datalad/commit/c53298e46e3cf64d3b3294758aaeeb2f2b3d28c5\r\n\r\nIt is not clear to me how a working `file://` URL could look like. According to https://en.wikipedia.org/wiki/File_URI_scheme#Windows it is not too far off. Maybe just one slash less would do it. But I cannot seem to make anything work with git-annex directly:\r\n\r\n```\r\n> git -c annex.security.allowed-url-schemes=file annex addurl file://./c:/Windows/clock.avi\r\naddurl file://./c:/Windows/clock.avi\r\n\r\n  download failed: /c:/Windows/clock.avi: openBinaryFile: invalid argument (Invalid argument)\r\nfailed\r\ngit-annex: addurl: 1 failed\r\n\r\n>git -c annex.security.allowed-url-schemes=file annex addurl file://c$/Windows/clock.avi\r\naddurl file://c$/Windows/clock.avi\r\n\r\n  download failed: /Windows/clock.avi: openBinaryFile: does not exist (No such file or directory)\r\nfailed\r\ngit-annex: addurl: 1 failed\r\n\r\n>git -c annex.security.allowed-url-schemes=file annex addurl file:///c$/Windows/clock.avi\r\naddurl file:///c$/Windows/clock.avi\r\n\r\n  download failed: /c$/Windows/clock.avi: openBinaryFile: does not exist (No such file or directory)\r\nfailed\r\ngit-annex: addurl: 1 failed\r\n\r\n>git -c annex.security.allowed-url-schemes=file annex addurl file://localhost/c$/Windows/clock.avi\r\naddurl file://localhost/c$/Windows/clock.avi\r\n\r\n  download failed: /c$/Windows/clock.avi: openBinaryFile: does not exist (No such file or directory)\r\nfailed\r\ngit-annex: addurl: 1 failed\r\n\r\n>git -c annex.security.allowed-url-schemes=file annex addurl file://localhost/c:/Windows/clock.avi\r\naddurl file://localhost/c:/Windows/clock.avi\r\n\r\n  download failed: /c:/Windows/clock.avi: openBinaryFile: invalid argument (Invalid argument)\r\nfailed\r\ngit-annex: addurl: 1 failed\r\n```", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3974/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3974/timeline", "performed_via_github_app": null}