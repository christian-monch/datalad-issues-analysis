{"url": "https://api.github.com/repos/datalad/datalad/issues/2482", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2482/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2482/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2482/events", "html_url": "https://github.com/datalad/datalad/issues/2482", "id": 321328435, "node_id": "MDU6SXNzdWUzMjEzMjg0MzU=", "number": 2482, "title": "Result filter is not recognized", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-05-08T20:06:25Z", "updated_at": "2018-05-10T18:48:02Z", "closed_at": "2018-05-10T18:48:02Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "I want to set up a result filter, but I'm not having any luck in getting it executed.\r\n\r\nSay I have the following extension:\r\n\r\n```python\r\nfrom datalad.interface.base import Interface\r\nfrom datalad.interface.base import build_doc\r\nfrom datalad.interface.results import get_status_dict\r\n\r\n\r\n@build_doc\r\nclass Foo(Interface):\r\n    from datalad.distribution.dataset import EnsureDataset\r\n    from datalad.interface.utils import eval_results\r\n    from datalad.support.constraints import EnsureNone\r\n    from datalad.support.param import Parameter\r\n\r\n    result_filter = lambda x: \"blah\" in x\r\n\r\n    _params_ = dict(\r\n        dataset=Parameter(\r\n            args=(\"-d\", \"--dataset\"),\r\n            doc=\"\"\"\"dataset to foo.\"\"\",\r\n            constraints=EnsureDataset() | EnsureNone()),\r\n    )\r\n\r\n    @staticmethod\r\n    @eval_results\r\n    def __call__(dataset=None):\r\n        yield get_status_dict(\"foo\",\r\n                              message=\"has blah\",\r\n                              type=\"dataset\",\r\n                              path=dataset.path if dataset else \"nowhere\",\r\n                              status=\"ok\",\r\n                              blah=\"aaaa\")\r\n        yield get_status_dict(\"foo\",\r\n                              message=\"no blah\",\r\n                              type=\"dataset\",\r\n                              path=dataset.path if dataset else \"nowhere\",\r\n                              status=\"ok\")\r\n\r\n\r\n__datalad_plugin__ = Foo\r\n```\r\n\r\nThe key bit is the `result_filter` assignment above. With that filter, I want to limit the results to records that have the key \"blah\". But it isn't being executed.\r\n\r\n```\r\n% datalad -ldebug foo\r\n[DEBUG  ] Determined class of decorated function: <class 'datalad.plugin.foo.Foo'>\r\nfoo(ok): nowhere (dataset) [has blah]\r\nfoo(ok): nowhere (dataset) [no blah]\r\naction summary:\r\n  foo (ok: 2)\r\n```\r\n\r\nThe `result_filter` argument passed to `_process_results` is `None`. It seems like this issue is here:\r\n\r\n<https://github.com/datalad/datalad/blob/43e37edc6f00b6edf250f1edc0116b9bd62f3f87/datalad/interface/utils.py#L333-L337>\r\n\r\nMy filter is in `_func_class.result_filter`, but it doesn't get reached because `kwargs` has a `result_filter` key with a value of `None`, so the `pop` returns `None`.\r\n\r\nAlthough I doubt it's the right thing to do generally, if I let things fall back to `_func_class.result_filter` with\r\n\r\n```diff\r\ndiff --git a/datalad/interface/utils.py b/datalad/interface/utils.py\r\nindex f9e305b47..46d0ef903 100644\r\n--- a/datalad/interface/utils.py\r\n+++ b/datalad/interface/utils.py\r\n@@ -331,9 +331,8 @@ def eval_func(wrapped, instance, args, kwargs):\r\n         # retrieve common options from kwargs, and fall back on the command\r\n         # class attributes, or general defaults if needed\r\n         common_params = {\r\n-            p_name: kwargs.pop(\r\n-                p_name,\r\n-                getattr(_func_class, p_name, eval_defaults[p_name]))\r\n+            p_name: kwargs.pop(p_name, None) or \\\r\n+            getattr(_func_class, p_name, eval_defaults[p_name])\r\n             for p_name in eval_params}\r\n         # short cuts and configured setup for common options\r\n         on_failure = common_params['on_failure']\r\n```\r\n\r\nthen my result filter works was expected.\r\n\r\n```\r\n% datalad -ldebug foo\r\n[DEBUG  ] Determined class of decorated function: <class 'datalad.plugin.foo.Foo'>\r\nfoo(ok): nowhere (dataset) [has blah]\r\n[DEBUG  ] not reporting result (excluded by filter [utils.py:_process_results:525])\r\naction summary:\r\n  foo (ok: 2)\r\n```\r\n\r\nIs there a bug in how the result filter is being processed, or is there something else I need to do to set up the filter?\r\n", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2482/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2482/timeline", "performed_via_github_app": null}