{"url": "https://api.github.com/repos/datalad/datalad/issues/5151", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5151/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5151/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5151/events", "html_url": "https://github.com/datalad/datalad/pull/5151", "id": 741083397, "node_id": "MDExOlB1bGxSZXF1ZXN0NTE5NDYxMzg0", "number": 5151, "title": "BF: ora: Trigger SSH cleanup on failure to prevent stall", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/81", "html_url": "https://github.com/datalad/datalad/milestone/81", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/81/labels", "id": 6196851, "node_id": "MDk6TWlsZXN0b25lNjE5Njg1MQ==", "number": 81, "title": "0.13.6", "description": null, "creator": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 28, "state": "closed", "created_at": "2020-12-09T17:06:54Z", "updated_at": "2021-01-03T22:14:17Z", "due_on": null, "closed_at": "2021-01-03T22:14:17Z"}, "comments": 5, "created_at": "2020-11-11T21:29:49Z", "updated_at": "2020-12-12T14:21:45Z", "closed_at": "2020-11-13T15:37:07Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/5151", "html_url": "https://github.com/datalad/datalad/pull/5151", "diff_url": "https://github.com/datalad/datalad/pull/5151.diff", "patch_url": "https://github.com/datalad/datalad/pull/5151.patch"}, "body": "git-annex's shutdown process for external remotes was tweaked in\r\n7245a9ed5 (Improve shutdown process for external special remotes and\r\nexternal backends, 2020-11-02), part of the 8.20201103 release.  With\r\nthat commit, git-annex waits for stderr rather than closing it at\r\nshutdown of the external remote program.\r\n\r\nThis is reported to fix a stall on Windows, but it also triggers one\r\nwith the ora remote (seen on the github actions with Ubuntu and for me\r\nlocally on Debian Buster).  All of the initremote failure checks in\r\ntest_initremote_basic() against an SSH target trigger a stall.  This\r\ncan be easily triggered outside of the tests by using a non-existing\r\nSSH target:\r\n\r\n    $ git annex initremote --debug ria-remote \\\r\n      encryption=none type=external externaltype=ora autoenable=true \\\r\n      url=ria+ssh://datalad-test/tmp/i-do-not-exist\r\n\r\nEven when initremote succeeds before the above commit, ora is leaving\r\nan SSH socket behind.  It tries to register SSHRemoteIO.close(), which\r\ncalls SSHManager.close(), as an atexit function, but that doesn't seem\r\nto be in effect here.\r\n\r\nInstead of relying on the registered function to get called when\r\nhandling errors, call io.close() directly.  This avoids leaving a\r\nsocket behind and prevents stalling after git-annex's 7245a9ed5.\r\n\r\nNote that close() is only defined for SSHRemoteIO, so this change\r\ncomes with additional AttributeError handling.  It might make sense to\r\nadd a noop close() method to IOBase, but avoid that for now because\r\nHTTPRemoteIO doesn't actually inherit from IOBase.\r\n\r\nCloses #5145.\r\n", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5151/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5151/timeline", "performed_via_github_app": null}