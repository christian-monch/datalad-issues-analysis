{"url": "https://api.github.com/repos/datalad/datalad/issues/5317", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5317/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5317/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5317/events", "html_url": "https://github.com/datalad/datalad/issues/5317", "id": 784258958, "node_id": "MDU6SXNzdWU3ODQyNTg5NTg=", "number": 5317, "title": "It takes 2.5-3s to create an empty dataset", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 289240596, "node_id": "MDU6TGFiZWwyODkyNDA1OTY=", "url": "https://api.github.com/repos/datalad/datalad/labels/performance", "name": "performance", "color": "f4b2d8", "default": false, "description": "Improve performance of an existing feature"}, {"id": 2767220927, "node_id": "MDU6TGFiZWwyNzY3MjIwOTI3", "url": "https://api.github.com/repos/datalad/datalad/labels/cmd-create", "name": "cmd-create", "color": "FEF2C0", "default": false, "description": ""}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 9, "created_at": "2021-01-12T14:00:57Z", "updated_at": "2021-03-11T04:53:28Z", "closed_at": "2021-03-11T04:53:28Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "- What contributes to this time?\r\n- Can we make it faster?\r\n\r\nWe are creating a huge number of datasets in each test run. Shaving off something, even just milliseconds, will be felt.\r\n\r\nOn windows we are talking ~5s. On an NTFS SSD mounted on Debian it is ~3s. On my system SSD it is 2.5s.\r\n\r\nOne candidate is this spot:\r\n\r\n```\r\n2021-01-12 16:47:41,528 [DEBUG  ] Launching process ['git', 'annex', 'version', '--raw'] \r\n2021-01-12 16:47:41,532 [DEBUG  ] Process 1155999 started \r\n2021-01-12 16:47:41,532 [DEBUG  ] Waiting for process 1155999 to complete \r\n2021-01-12 16:47:41,546 [DEBUG  ] Process 1155999 exited with return code 0 \r\n\r\n>>HERE<<\r\n\r\n2021-01-12 16:47:43,250 [DEBUG  ] Async run ['git', 'annex', 'init', '-c', 'annex.dotfiles=true'] \r\n2021-01-12 16:47:43,251 [DEBUG  ] Launching process ['git', 'annex', 'init', '-c', 'annex.dotfiles=true'] \r\n2021-01-12 16:47:43,254 [DEBUG  ] Process 1156014 started \r\n```\r\n\r\nEven at log-level 1 there is nothing happening in that spot for ~1.5s on my laptop (that is 60% is the total runtime of a `create`).\r\n\r\n<details>\r\n<summary>Here is the list of processes involved and their timings</summary>\r\n\r\n```\r\n(datalad3-dev) mih@meiner /tmp % DATALAD_LOG_TIMESTAMP=1 datalad -l debug create d12 2>&1 | grep -i 'process' | grep -v 'Waiting'\r\n2021-01-12 17:03:30,627 [DEBUG] Launching process ['git', '--git-dir=', 'config', '-z', '-l', '--show-origin'] \r\n2021-01-12 17:03:30,630 [DEBUG] Process 1158112 started \r\n2021-01-12 17:03:30,630 [DEBUG] Process 1158112 exited with return code 0 \r\n2021-01-12 17:03:30,633 [DEBUG] Launching process ['git', '-C', '/tmp/d12', 'init'] \r\n2021-01-12 17:03:30,636 [DEBUG] Process 1158114 started \r\n2021-01-12 17:03:30,639 [DEBUG] Process 1158114 exited with return code 0 \r\n2021-01-12 17:03:30,640 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2021-01-12 17:03:30,642 [DEBUG] Process 1158116 started \r\n2021-01-12 17:03:30,643 [DEBUG] Process 1158116 exited with return code 0 \r\n2021-01-12 17:03:30,644 [DEBUG] Launching process ['git', 'config', '-z', '-l', '--show-origin'] \r\n2021-01-12 17:03:30,646 [DEBUG] Process 1158118 started \r\n2021-01-12 17:03:30,647 [DEBUG] Process 1158118 exited with return code 0 \r\n2021-01-12 17:03:30,648 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads'] \r\n2021-01-12 17:03:30,650 [DEBUG] Process 1158120 started \r\n2021-01-12 17:03:30,651 [DEBUG] Process 1158120 exited with return code 0 \r\n2021-01-12 17:03:30,652 [DEBUG] Launching process ['git', 'annex', 'version', '--raw'] \r\n2021-01-12 17:03:30,654 [DEBUG] Process 1158122 started \r\n2021-01-12 17:03:30,668 [DEBUG] Process 1158122 exited with return code 0 \r\n2021-01-12 17:03:32,343 [DEBUG] Launching process ['git', 'annex', 'init', '-c', 'annex.dotfiles=true'] \r\n2021-01-12 17:03:32,346 [DEBUG] Process 1158137 started \r\n2021-01-12 17:03:32,523 [DEBUG] Process 1158137 exited with return code 0 \r\n2021-01-12 17:03:32,525 [DEBUG] Launching process ['git', 'config', '-z', '-l', '--show-origin'] \r\n2021-01-12 17:03:32,532 [DEBUG] Process 1158177 started \r\n2021-01-12 17:03:32,533 [DEBUG] Process 1158177 exited with return code 0 \r\n2021-01-12 17:03:32,537 [DEBUG] Launching process ['git', 'check-attr', '-z', '--all', '--', '.'] \r\n2021-01-12 17:03:32,541 [DEBUG] Process 1158179 started \r\n2021-01-12 17:03:32,542 [DEBUG] Process 1158179 exited with return code 0 \r\n2021-01-12 17:03:32,544 [DEBUG] Launching process ['git', 'config', '--local', 'annex.backends', 'MD5E'] \r\n2021-01-12 17:03:32,547 [DEBUG] Process 1158181 started \r\n2021-01-12 17:03:32,548 [DEBUG] Process 1158181 exited with return code 0 \r\n2021-01-12 17:03:32,549 [DEBUG] Launching process ['git', 'config', '-z', '-l', '--show-origin'] \r\n2021-01-12 17:03:32,552 [DEBUG] Process 1158183 started \r\n2021-01-12 17:03:32,553 [DEBUG] Process 1158183 exited with return code 0 \r\n2021-01-12 17:03:32,554 [DEBUG] Launching process ['git', '-c', 'annex.largefiles=nothing', 'add', '--dry-run', '-N', '--ignore-missing', '--verbose', '--', '.gitattributes'] \r\n2021-01-12 17:03:32,557 [DEBUG] Process 1158185 started \r\n2021-01-12 17:03:32,558 [DEBUG] Process 1158185 exited with return code 0 \r\n2021-01-12 17:03:32,560 [DEBUG] Launching process ['git', '-c', 'annex.largefiles=nothing', 'add', '--verbose', '--', '.gitattributes'] \r\n2021-01-12 17:03:32,562 [DEBUG] Process 1158187 started \r\n2021-01-12 17:03:32,587 [DEBUG] Process 1158187 exited with return code 0 \r\n2021-01-12 17:03:32,588 [DEBUG] Launching process ['git', 'check-attr', '-z', '--all', '--', '.datalad/config', '.datalad/metadata/aggregate*', '.datalad/metadata/objects/**'] \r\n2021-01-12 17:03:32,590 [DEBUG] Process 1158204 started \r\n2021-01-12 17:03:32,591 [DEBUG] Process 1158204 exited with return code 0 \r\n2021-01-12 17:03:32,592 [DEBUG] Launching process ['git', 'check-attr', '-z', '--all', '--', '.git'] \r\n2021-01-12 17:03:32,595 [DEBUG] Process 1158206 started \r\n2021-01-12 17:03:32,595 [DEBUG] Process 1158206 exited with return code 0 \r\n2021-01-12 17:03:32,597 [DEBUG] Launching process ['git', 'config', '--file', '/tmp/d12/.datalad/config', '--add', 'datalad.dataset.id', '128e8c58-fe24-42c6-8626-32c56e08dbf0'] \r\n2021-01-12 17:03:32,601 [DEBUG] Process 1158208 started \r\n2021-01-12 17:03:32,602 [DEBUG] Process 1158208 exited with return code 0 \r\n2021-01-12 17:03:32,603 [DEBUG] Launching process ['git', 'config', '-z', '-l', '--show-origin', '--file', '/tmp/d12/.datalad/config'] \r\n2021-01-12 17:03:32,606 [DEBUG] Process 1158210 started \r\n2021-01-12 17:03:32,607 [DEBUG] Process 1158210 exited with return code 0 \r\n2021-01-12 17:03:32,608 [DEBUG] Launching process ['git', 'diff', '--name-only', '--staged'] \r\n2021-01-12 17:03:32,612 [DEBUG] Process 1158212 started \r\n2021-01-12 17:03:32,612 [DEBUG] Process 1158212 exited with return code 0 \r\n2021-01-12 17:03:32,614 [DEBUG] Launching process ['git', 'ls-files', '--stage', '-z', '--exclude-standard', '-o', '--', '.datalad'] \r\n2021-01-12 17:03:32,618 [DEBUG] Process 1158214 started \r\n2021-01-12 17:03:32,619 [DEBUG] Process 1158214 exited with return code 0 \r\n2021-01-12 17:03:32,621 [DEBUG] Launching process ['git', '-c', 'annex.largefiles=nothing', 'add', '--verbose', '--', '.gitattributes', '.datalad'] \r\n2021-01-12 17:03:32,623 [DEBUG] Process 1158216 started \r\n2021-01-12 17:03:32,696 [DEBUG] Process 1158216 exited with return code 0 \r\n2021-01-12 17:03:32,697 [DEBUG] Launching process ['git', 'rev-parse', '--quiet', '--verify', 'HEAD^{commit}'] \r\n2021-01-12 17:03:32,700 [DEBUG] Process 1158263 started \r\n2021-01-12 17:03:32,701 [DEBUG] Process 1158263 exited with return code 1 \r\n2021-01-12 17:03:32,701 [DEBUG] Launching process ['git', 'commit', '-m', '[DATALAD] new dataset', '--', '.gitattributes', '.datalad'] \r\n2021-01-12 17:03:32,704 [DEBUG] Process 1158265 started \r\n2021-01-12 17:03:32,813 [DEBUG] Process 1158265 exited with return code 0 \r\n2021-01-12 17:03:32,814 [DEBUG] Launching process ['git', 'symbolic-ref', 'HEAD'] \r\n2021-01-12 17:03:32,816 [DEBUG] Process 1158347 started \r\n2021-01-12 17:03:32,817 [DEBUG] Process 1158347 exited with return code 0 \r\n```\r\n\r\n</details>\r\n\r\nLooking at the timing within the `_call_annex(['init'])` call I see the following, with this patch:\r\n\r\n```diff\r\ndiff --git a/datalad/support/annexrepo.py b/datalad/support/annexrepo.py\r\nindex 6a6a7d4bb..e63274d17 100644\r\n--- a/datalad/support/annexrepo.py\r\n+++ b/datalad/support/annexrepo.py\r\n@@ -941,8 +941,10 @@ class AnnexRepo(GitRepo, RepoInterface):\r\n           stderr. Only supported if the given protocol captured stderr.\r\n         \"\"\"\r\n         if self.git_annex_version is None:\r\n+            lgr.debug(\"START %s\", args)\r\n             self._check_git_annex_version()\r\n \r\n+        lgr.debug(\"POSTVERSION %s\", args)\r\n         # git portion of the command\r\n         cmd = ['git'] + self._ANNEX_GIT_COMMON_OPTIONS\r\n \r\n@@ -977,11 +979,13 @@ class AnnexRepo(GitRepo, RepoInterface):\r\n         if jobs and jobs != 1:\r\n             cmd.append('-J%d' % jobs)\r\n \r\n+        lgr.debug(\"PRERUNNER %s\", args)\r\n         runner = self._git_runner\r\n         env = None\r\n         if self.fake_dates_enabled:\r\n             env = self.add_fake_dates(runner.env)\r\n \r\n+        lgr.debug(\"FAKEDATES %s\", args)\r\n         try:\r\n             if files:\r\n                 return runner.run_on_filelist_chunks(\r\n```\r\n\r\n```\r\n2021-01-12 17:21:09,868 [DEBUG  ] START ['init'] \r\n2021-01-12 17:21:09,868 [DEBUG  ] Async run ['git', 'annex', 'version', '--raw'] \r\n2021-01-12 17:21:09,868 [DEBUG  ] Launching process ['git', 'annex', 'version', '--raw'] \r\n2021-01-12 17:21:09,871 [DEBUG  ] Process 1161705 started \r\n2021-01-12 17:21:09,871 [DEBUG  ] Waiting for process 1161705 to complete \r\n2021-01-12 17:21:09,884 [DEBUG  ] Process 1161705 exited with return code 0 \r\n2021-01-12 17:21:11,577 [DEBUG  ] POSTVERSION ['init'] \r\n2021-01-12 17:21:11,577 [DEBUG  ] PRERUNNER ['init'] \r\n2021-01-12 17:21:11,577 [DEBUG  ] FAKEDATES ['init'] \r\n```\r\n\r\nThis means that the version info gathering takes 1.5s !\r\n\r\nAnd it is specifically the call to `get_linux_distribution()` inside `_check_git_annex_version()` that consumes all the time. As far as I can see, this is only done to generate a 'helpful' message.", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5317/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5317/timeline", "performed_via_github_app": null}