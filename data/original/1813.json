{"url": "https://api.github.com/repos/datalad/datalad/issues/1813", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/1813/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/1813/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/1813/events", "html_url": "https://github.com/datalad/datalad/issues/1813", "id": 256323898, "node_id": "MDU6SXNzdWUyNTYzMjM4OTg=", "number": 1813, "title": "publish -r --since=COMMIT manages to consider a file to be a dataset", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 440544386, "node_id": "MDU6TGFiZWw0NDA1NDQzODY=", "url": "https://api.github.com/repos/datalad/datalad/labels/fix-implemented", "name": "fix-implemented", "color": "0e8a16", "default": false, "description": "A fix is available, but has not been merged or released, yet."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2017-09-08T17:40:29Z", "updated_at": "2017-09-14T22:20:02Z", "closed_at": "2017-09-12T12:45:36Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "I let previously interrupted (see #1812) publish to go on and this time it crashed:\r\n\r\n```shell\r\n$> DATALAD_LOG_TIMESTAMP=1 datalad --dbg publish --to=datalad-public --missing=inherit -r --since=e1046e69133df9f6ab933a7759a64c2536b0ce0e      \r\nTraceback (most recent call last):\r\n  File \"/home/yoh/proj/datalad/datalad-master/venvs/dev/bin/datalad\", line 8, in <module>\r\n    main()\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/cmdline/main.py\", line 348, in main\r\n    ret = cmdlineargs.func(cmdlineargs)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/base.py\", line 424, in call_from_parser\r\n    ret = list(ret)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 382, in generator_func\r\n    result_renderer, result_xfm, _result_filter, **_kwargs):\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/interface/utils.py\", line 449, in _process_results\r\n    for res in results:\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/distribution/publish.py\", line 723, in __call__\r\n    ap['path'], ds_remote_info, to, missing)\r\n  File \"/home/yoh/proj/datalad/datalad-master/datalad/distribution/publish.py\", line 487, in _get_remote_info\r\n    elif to not in ds.repo.get_remotes():\r\nAttributeError: 'NoneType' object has no attribute 'get_remotes'\r\n()\r\n> /home/yoh/proj/datalad/datalad-master/datalad/distribution/publish.py(487)_get_remote_info()\r\n-> elif to not in ds.repo.get_remotes():\r\n(Pdb) p ds\r\n<Dataset path=/mnt/btrfs/datasets/datalad/crawl/openfmri/ds000002/changelog.txt>\r\n(Pdb) p ds.repo\r\nNone\r\n(Pdb) l\r\n482  \t            return ('notneeded',\r\n483  \t                    'Cannot determine target sibling, skipping publication')\r\n484  \t        else:\r\n485  \t            # we have no remote given and no upstream\r\n486  \t            return 'error', 'Cannot determine a default target sibling for publication'\r\n487  ->\t    elif to not in ds.repo.get_remotes():\r\n488  \t        # unknown given remote\r\n489  \t        if missing == 'skip':\r\n490  \t            ds_remote_info[ds_path] = None\r\n491  \t            return ('notneeded',\r\n492  \t                    (\"Unkown target sibling '%s', skipping publication\", to))\r\n(Pdb) up\r\n> /home/yoh/proj/datalad/datalad-master/datalad/distribution/publish.py(723)__call__()\r\n-> ap['path'], ds_remote_info, to, missing)\r\n(Pdb) l\r\n718  \t                # this is a dataset\r\n719  \t                if ap.get('state', None) == 'absent':\r\n720  \t                    continue\r\n721  \t                # get the remote info for itself\r\n722  \t                remote_info_result = _get_remote_info(\r\n723  ->\t                    ap['path'], ds_remote_info, to, missing)\r\n724  \t                ap['process_content'] = True\r\n725  \t            if remote_info_result is not None:\r\n726  \t                ap['status'] = remote_info_result[0]\r\n727  \t                ap['message'] = remote_info_result[1]\r\n728  \t                yield ap\r\n(Pdb) p ap['path']\r\n'/mnt/btrfs/datasets/datalad/crawl/openfmri/ds000002/changelog.txt'\r\n(Pdb) p ds_remote_info\r\n{'/mnt/btrfs/datasets/datalad/crawl/openfmri/ds000002': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/openfmri': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/openfmri/ds000001': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/openfmri/ds000006': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/openfmri/ds000003': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/kaggle': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/openfmri/ds000005': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/dbic/QA': {'remote': 'datalad-public'}, '/mnt/btrfs/datasets/datalad/crawl/dbic': {'remote': 'datalad-public'}}\r\n(Pdb) p to\r\n'datalad-public'\r\n(Pdb) p missing\r\n'inherit'\r\n```\r\nthe situation is that apparently openfmri superdataset is dirty because that ds000002 progressed forward but wasn't yet committed within openfmri... and I guess crash is because that changelog.txt is the diff between previous and new states:\r\n```shell\r\n(git)smaug:/mnt/btrfs/datasets/datalad/crawl/openfmri[master]git\r\n$> git diff ds000002 \r\ndiff --git a/ds000002 b/ds000002\r\nindex b98c69f..4f2be86 160000\r\n--- a/ds000002\r\n+++ b/ds000002\r\n@@ -1 +1 @@\r\n-Subproject commit b98c69ff35a0393d55bc957f0f419800d8b649f7\r\n+Subproject commit 4f2be86d6d79139191971113d66aefc9b8e8621e\r\n(dev)1 10296.....................................:Fri 08 Sep 2017 01:37:51 PM EDT:.\r\n(git)smaug:/mnt/btrfs/datasets/datalad/crawl/openfmri[master]git\r\n$> git -C ds000002 diff b98c69ff35a0393d55bc957f0f419800d8b649f7..4f2be86d6d79139191971113d66aefc9b8e8621e --stat\r\n .datalad/crawl/statuses/incoming.json | 19 ++++++++-----------\r\n changelog.txt                         |  1 -\r\n```\r\n\r\nIn general I guess resolution for this particular should be to filter out annotated paths for having only datasets? ", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/1813/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/1813/timeline", "performed_via_github_app": null}