{"url": "https://api.github.com/repos/datalad/datalad/issues/2813", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2813/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2813/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2813/events", "html_url": "https://github.com/datalad/datalad/issues/2813", "id": 359119159, "node_id": "MDU6SXNzdWUzNTkxMTkxNTk=", "number": 2813, "title": "BF? for direct mode: diff to invoke diff/status with manual recursion or a git shim?", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 374318336, "node_id": "MDU6TGFiZWwzNzQzMTgzMzY=", "url": "https://api.github.com/repos/datalad/datalad/labels/conference%20agenda%20item", "name": "conference agenda item", "color": "fbca04", "default": false, "description": "Scheduled to be discussed in a developer meeting"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-09-11T16:13:49Z", "updated_at": "2018-09-14T14:00:07Z", "closed_at": "2018-09-14T14:00:07Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "#### What is the problem?\r\n\r\nIt seems that we are closer to support direct mode of operation than ever before ;-)\r\n\r\nOne of the outstanding issues is inability to get `status` or `diff` in a dataset with submodules in direct mode. It is because we cannot pass --work-tree=. -c core.bare=False to the internal invocations of git, which it runs within submodules, which are also in direct mode and thus those git invocations fail.  \r\nBut for e.g. status we could tell to ignore submodules, and query status inside of them similarly \"manually\", and just assemble that all information ourselves through hierarchy\r\n\r\n```shell\r\n $> git -c receive.autogc=0 -c gc.auto=0 --work-tree=. -c core.bare=False status\r\nfatal: This operation must be run in a work tree\r\nfatal: 'git status --porcelain' failed in submodule subds1\r\n\r\n$> git -c receive.autogc=0 -c gc.auto=0 --work-tree=. -c core.bare=False status --ignore-submodules=dirty\r\nOn branch master                                                                  \r\nChanges to be committed:\r\n  (use \"git reset HEAD <file>...\" to unstage)\r\n\r\n\tnew file:   .gitmodules\r\n\tnew file:   subds1\r\n```\r\n\r\nSo it feels that we either need to manually recurse or may be provide a `git` shim like this one?\r\n\r\n```\r\n$> cat /tmp/git-direct/git                         \r\n#!/bin/bash               \r\nset -eu\r\ncmd=$(basename $0)\r\nthisgit=`which $cmd`\r\ngit=`which -a $cmd | grep -v \"^$thisgit\\$\" | head -n 1`\r\nif [ -z \"$git\" ]; then\r\n    echo \"Cannot find $cmd other than $thisgit in the PATH=$PATH\" >&2\r\n    exit 1\r\nfi\r\necho \"E: this=$thisgit git=$git\"\r\necho I: $git --work-tree=. -c core.bare=False \"$@\"\r\n$git --work-tree=. -c core.bare=False \"$@\"\r\n```\r\n\r\nwhich (might have some craft to be pruned, since initially I was trying to change PATH before I found GIT_EXEC_PATH) seems to help in case of status at least\r\n\r\n```\r\n$> GIT_EXEC_PATH=/tmp/git-direct git status\r\nOn branch master\r\nChanges to be committed:\r\n  (use \"git reset HEAD <file>...\" to unstage)\r\n\r\n\tnew file:   .gitmodules\r\n\tnew file:   subds1\r\n\r\nChanges not staged for commit:\r\n  (use \"git add <file>...\" to update what will be committed)\r\n  (use \"git checkout -- <file>...\" to discard changes in working directory)\r\n  (commit or discard the untracked or modified content in submodules)\r\n\r\n\tmodified:   subds1 (modified content)\r\n\r\n```", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2813/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2813/timeline", "performed_via_github_app": null}