{"url": "https://api.github.com/repos/datalad/datalad/issues/4690", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4690/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4690/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4690/events", "html_url": "https://github.com/datalad/datalad/issues/4690", "id": 655226275, "node_id": "MDU6SXNzdWU2NTUyMjYyNzU=", "number": 4690, "title": "Avoid running apt-cache policy on every import", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 289240596, "node_id": "MDU6TGFiZWwyODkyNDA1OTY=", "url": "https://api.github.com/repos/datalad/datalad/labels/performance", "name": "performance", "color": "f4b2d8", "default": false, "description": "Improve performance of an existing feature"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-07-11T15:15:54Z", "updated_at": "2020-07-14T23:01:03Z", "closed_at": "2020-07-14T23:01:03Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "```shell\r\n$> strace -f python -c 'import os' 2>&1 | grep -v ENOENT | grep execv.*apt-cache     \r\n\r\n$> strace -f python -c 'import datalad' 2>&1 | grep -v ENOENT | grep execv.*apt-cache\r\n[pid 1637620] execve(\"/usr/bin/apt-cache\", [\"apt-cache\", \"policy\"], 0x227f5c0 /* 107 vars */ <unfinished ...>\r\n```\r\nI guess through some module/checks.  That ends up quite a number of invocations when we test our base external remotes. E.g. while testing datalad-crawler:\r\n```\r\n$> grep 'exec.*\\(apt-cache.*\\)' strace.log | grep -v ENOENT | nl | tail        \r\n...\r\n   196\t1626634 22:16:14.871171 execve(\"/usr/bin/apt-cache\", [\"apt-cache\", \"policy\"], 0x19dc270 /* 128 vars */ <unfinished ...>\r\n   197\t1626648 22:16:16.521609 execve(\"/usr/bin/apt-cache\", [\"apt-cache\", \"policy\"], 0x2079270 /* 128 vars */ <unfinished ...>\r\n```\r\nwhich is more  less in agreement with number of special remote invocations:\r\n```shell\r\n$> grep 'exec.*\\(git-annex-remote-data.*\\)' strace.log | grep -v ENOENT | nl | tail -n 2\r\n   177\t1626631 22:16:14.714512 execve(\"/home/yoh/proj/datalad/datalad-crawler/venvs/dev3/bin/git-annex-remote-datalad-archives\", [\"/home/yoh/proj/datalad/datalad-c\"...], 0x42000e6af8 /* 127 vars */ <unfinished ...>\r\n   178\t1626645 22:16:16.377021 execve(\"/home/yoh/proj/datalad/datalad-crawler/venvs/dev3/bin/git-annex-remote-datalad-archives\", [\"/home/yoh/proj/datalad/datalad-c\"...], 0x42000e1af8 /* 127 vars */ <unfinished ...>\r\n```\r\n\r\ngiven that each invocation is about 200-300ms on my laptop:\r\n\r\n```\r\n$> time apt-cache policy 2>&1 | tail -n 2\r\n     origin deb.debian.org\r\nPinned packages:\r\nnoglob apt-cache policy 2>&1  0.20s user 0.04s system 99% cpu 0.238 total\r\ntail -n 2  0.00s user 0.00s system 1% cpu 0.237 total\r\n```\r\n\r\nthat is at least 20 seconds of tests run time (unlikely it is some async) contributing (and this is just datalad-crawler which tests are relatively speedy .\r\n\r\naltogether running the datalad-crawler tests results in over 100k invocations of external tools\r\n```\r\n$> grep 'execve' strace.log | grep -v ENOENT | nl | tail -n 2  \r\n112096\t1628529 22:16:25.497272 execve(\"/usr/lib/git-annex.linux/bin/git\", [\"git\", \"--git-dir=\", \"config\", \"-z\", \"-l\", \"--show-origin\"], 0x55c3a37a1038 /* 123 vars */) = 0\r\n112097\t1628529 22:16:25.498675 execve(\"/usr/lib/git-annex.linux/exe/git\", [\"/usr/lib/git-annex.linux/exe/git\", \"--library-path\", \"/usr/lib/git-annex.linux//usr/li\"..., \"/usr/lib/git-annex.linux/shimmed\"..., \"--git-dir=\", \"config\", \"-z\", \"-l\", \"--show-origin\"], 0x55c0a5f22ee8 /* 124 vars */) = 0\r\n```\r\n\r\nI hope that identifying the source of some of such invocations and adding some caching, where possible (our direct invocation), could help to at least partially mitigate them. May be https://github.com/con/pyfscacher (see https://github.com/con/pyfscacher/issues/1) whenever it is born could be of use.", "closed_by": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4690/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4690/timeline", "performed_via_github_app": null}