{"url": "https://api.github.com/repos/datalad/datalad/issues/3656", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3656/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3656/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3656/events", "html_url": "https://github.com/datalad/datalad/pull/3656", "id": 491310353, "node_id": "MDExOlB1bGxSZXF1ZXN0MzE1NzAzMTg0", "number": 3656, "title": "BF: cmd: Don't leave unread lines on stream when logging online", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2019-09-09T20:30:34Z", "updated_at": "2019-09-10T11:42:32Z", "closed_at": "2019-09-10T00:44:01Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/3656", "html_url": "https://github.com/datalad/datalad/pull/3656", "diff_url": "https://github.com/datalad/datalad/pull/3656.diff", "patch_url": "https://github.com/datalad/datalad/pull/3656.patch"}, "body": "Now that we have a branch that drops Python 2, I've been looking into using asyncio in the runner.  Much of that so far has been trying to wrap my head around how the different parameters of Runner.run() interact.  While doing this, I realized that some output lines were being lost.\r\n\r\n---\r\n\r\n```\r\nWhen the Runner is called with log_online=True and we're logging\r\neither stdout or stderr, the readline() call for the stream happens\r\nunder a `while proc.poll() is None`.  After that block, we may have\r\nuncaptured output, either because the process was already finished by\r\nthe time we got to the proc.poll() condition or because each iteration\r\nreads only a single line.  To collect this output, communicate() is\r\ncalled.\r\n\r\nHowever, communicate() may return an empty string even when there is\r\nuncaptured output and appears to reliably do so if\r\n\r\n  (1) we've called readline() on the stream\r\n  (2) both stdout and stderr are set to subprocess.PIPE\r\n  (3) we're running under Python 3\r\n\r\nThe second condition likely involves the fact that subprocess.py has\r\nan optimization to avoid using threads if the number of pipes is below\r\ntwo.\r\n\r\nFor example, try\r\n\r\n    import subprocess as sp\r\n    p = sp.Popen([\"printf\", \"one\\ntwo\\n\"], stdout=sp.PIPE, stderr=sp.PIPE)\r\n    print(p.stdout.readline())\r\n    print(p.communicate())\r\n\r\n\"two\\n\" is not included in the output returned by communicate().\r\n\r\nTo work around this, gather these remaining lines with a direct read()\r\ncall rather than relying on communicate() when we're using a pipe for\r\nbother stdout and stderr.\r\n```", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3656/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3656/timeline", "performed_via_github_app": null}