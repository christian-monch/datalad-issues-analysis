{"url": "https://api.github.com/repos/datalad/datalad/issues/4832", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4832/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4832/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4832/events", "html_url": "https://github.com/datalad/datalad/issues/4832", "id": 686461795, "node_id": "MDU6SXNzdWU2ODY0NjE3OTU=", "number": 4832, "title": "Some python modules break threading (for datalad)", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 385404347, "node_id": "MDU6TGFiZWwzODU0MDQzNDc=", "url": "https://api.github.com/repos/datalad/datalad/labels/for%20our%20information", "name": "for our information", "color": "fbca04", "default": false, "description": "Announcement-type issues (possibly inconsequential)"}, {"id": 533730441, "node_id": "MDU6TGFiZWw1MzM3MzA0NDE=", "url": "https://api.github.com/repos/datalad/datalad/labels/:woman_facepalming:", "name": ":woman_facepalming:", "color": "ffffff", "default": false, "description": "facepalm"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-08-26T16:36:49Z", "updated_at": "2020-09-01T09:35:49Z", "closed_at": "2020-09-01T09:35:49Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "I created\r\n\r\n```\r\n% cat /tmp/test_dummy.py\r\ndef test_threads():\r\n    from concurrent.futures import ThreadPoolExecutor\r\n    with ThreadPoolExecutor(max_workers=1) as executor:\r\n        future = executor.submit(pow, 323, 1235)\r\n        l = future.result()\r\n```\r\n\r\nRunning this in my datalad dev virtualenv I get:\r\n\r\n```\r\n(datalad3-dev) mih@meiner /tmp % python -m nose -s -v test_dummy.py\r\ntest_dummy.test_threads ... [2]    1825796 segmentation fault (core dumped)  python -m nose -s -v test_dummy.py\r\n```\r\n\r\nin a fresh virtualenv (same major python version 3.7, but 3.7.3 in the broken one, and 3.7.5 in the working one) with a full editable install of datalad things work fine.\r\n\r\nSo it seems one can install something that would break threading fundamentally. I was suffering from this for a long time (e.g. https://github.com/datalad/datalad/pull/4182#issuecomment-596188023) and it seems that I wasn't just stupid back then, but was even more stupid to not make this simple test.\r\n\r\n<details>\r\n\r\n<summary>Here is the `pip freeze` diff between a working and a broken env.</summary>\r\n\r\n```diff\r\n--- works.txt   2020-08-26 18:23:35.473857233 +0200\r\n+++ broken.txt  2020-08-26 18:23:51.102416300 +0200\r\n@@ -1,55 +1,167 @@\r\n+alabaster==0.7.12\r\n annexremote==1.4.3\r\n-appdirs==1.4.4\r\n-beautifulsoup4==4.9.1\r\n+appdirs==1.4.3\r\n+argcomplete==1.11.1\r\n+asn1crypto==0.24.0\r\n+asv==0.4.1\r\n+attrs==19.1.0\r\n+Automat==0.7.0\r\n+Babel==2.7.0\r\n+backcall==0.1.0\r\n+bcrypt==3.1.7\r\n+bids-validator==1.4.2\r\n+bleach==3.1.0\r\n boto==2.49.0\r\n-certifi==2020.6.20\r\n-cffi==1.14.2\r\n+certifi==2019.6.16\r\n+cffi==1.12.3\r\n chardet==3.0.4\r\n citeproc-py==0.5.1\r\n-cryptography==3.0\r\n-Deprecated==1.2.10\r\n+cmarkgfm==0.4.2\r\n+constantly==15.1.0\r\n+coverage==5.0.3\r\n+cryptography==2.7\r\n+cssselect==1.0.3\r\n+ddt==1.2.1\r\n+decorator==4.4.0\r\n+Deprecated==1.2.6\r\n+docopt==0.6.2\r\n+docutils==0.15\r\n duecredit==0.8.0\r\n+-e git+git@github.com:datalad/datalad-container.git@634ac22d0fb42d6b3d75655d14ff3e3f2d61ed94#egg=datalad_container\r\n+-e git+git@github.com:datalad/datalad-crawler.git@a6d5efc94074b67ceb7977c64f31c760a37cbaa6#egg=datalad_crawler\r\n+-e git+git@github.com:datalad/datalad-extension-template.git@f304d45b8d1f34dae08d0809c8e87c5047f8e278#egg=datalad_helloworld\r\n+-e git+git@github.com:datalad/datalad-metalad.git@d9b9a164db14c6086eccb4ca1fe78913c5fc7c62#egg=datalad_metalad\r\n+-e git+git@github.com:datalad/datalad-neuroimaging.git@884ce81961df0c54e12bb016d7b9a0c0030a24ae#egg=datalad_neuroimaging\r\n+-e git+git@github.com:datalad/datalad-osf.git@27e69586d805c91b1b114e6f30a2bd2a00403062#egg=datalad_osf\r\n+-e git+git@github.com:datalad/datalad-ukbiobank.git@46c743ef8fce01c6c321c7943533a9a0c420795f#egg=datalad_ukbiobank\r\n+-e git+git@github.com:datalad/git-remote-rclone.git@d727a2bc28aeb8b55649acdd68a9690fe0464762#egg=git_remote_rclone\r\n+-e git+git@github.com:datalad-handbook/book.git@167aeda522aa495334e98266679c4d1e32177a52#egg=dataladhandbook\r\n -e git+git@github.com:mih/datalad.git@4a80358bd21897af4cee4c4c0c8c644b49f8dd46#egg=datalad\r\n-ExifRead==2.3.1\r\n+-e git://github.com/mih/autorunrecord.git@e114becf6e34d1f04eeb2ed05f1af1fbaf0d1abf#egg=autorunrecord\r\n+entrypoints==0.3\r\n+et-xmlfile==1.0.1\r\n+fabric==2.5.0\r\n fasteners==0.15\r\n-future==0.18.2\r\n-httpretty==1.0.2\r\n-humanize==2.6.0\r\n-idna==2.10\r\n-importlib-metadata==1.7.0\r\n+future==0.17.1\r\n+gitdb==0.6.4\r\n+gitdb2==2.0.5\r\n+gitlab==1.0.2\r\n+GitPython==3.0.5\r\n+gprof2dot==2017.9.19\r\n+h5py==2.10.0\r\n+humanize==0.5.1\r\n+hyperlink==19.0.0\r\n+idna==2.8\r\n+imagesize==1.1.0\r\n+importlib-metadata==1.6.0\r\n+incremental==17.5.0\r\n+invoke==1.3.0\r\n+ipdb==0.12.2\r\n+ipython==7.7.0\r\n+ipython-genutils==0.2.0\r\n iso8601==0.1.12\r\n-jeepney==0.4.3\r\n+jdcal==1.4.1\r\n+jedi==0.15.1\r\n+jeepney==0.4\r\n+Jinja2==2.10.1\r\n+joblib==0.14.1\r\n jsmin==2.2.2\r\n-keyring==21.3.1\r\n-keyrings.alt==3.4.0\r\n-lxml==4.5.2\r\n+keyring==19.0.2\r\n+keyrings.alt==3.1.1\r\n+lxml==4.4.0\r\n+MarkupSafe==1.1.1\r\n+mock==3.0.5\r\n monotonic==1.5\r\n-msgpack==1.0.0\r\n-multidict==4.7.6\r\n-mutagen==1.45.1\r\n+more-itertools==8.4.0\r\n+msgpack==0.6.1\r\n+multidict==4.7.4\r\n+nibabel==3.1.1\r\n nose==1.3.7\r\n+nose-cprof==0.2.1\r\n+num2words==0.5.10\r\n+numpy==1.18.1\r\n+openpyxl==3.0.4\r\n+packaging==19.0\r\n+pandas==1.0.1\r\n+paramiko==2.6.0\r\n+parsel==1.5.1\r\n+parso==0.5.1\r\n patool==1.12\r\n+patsy==0.5.1\r\n+pexpect==4.7.0\r\n+pickleshare==0.7.5\r\n Pillow==7.2.0\r\n+pkginfo==1.5.0.1\r\n pkg-resources==0.0.0\r\n-pycparser==2.20\r\n-PyGithub==1.53\r\n+pluggy==0.13.1\r\n+prompt-toolkit==2.0.9\r\n+psutil==5.7.0\r\n+ptyprocess==0.6.0\r\n+py==1.8.2\r\n+pyasn1==0.4.6\r\n+pyasn1-modules==0.2.6\r\n+pybids==0.10.1\r\n+pycallgraph==1.0.1\r\n+pycparser==2.19\r\n+pydicom==1.4.1\r\n+PyDispatcher==2.0.5\r\n+PyGithub==1.43.8\r\n+Pygments==2.4.2\r\n+PyHamcrest==1.9.0\r\n PyJWT==1.7.1\r\n-pyperclip==1.8.0\r\n+PyNaCl==1.3.0\r\n+pyOpenSSL==19.0.0\r\n+pyparsing==2.4.1\r\n+pytest==5.4.3\r\n python-dateutil==2.8.1\r\n-python-xmp-toolkit==2.0.1\r\n-pytz==2020.1\r\n-PyYAML==5.3.1\r\n+pytz==2019.1\r\n+pyxnat==1.2.1.0.post3\r\n+PyYAML==5.3\r\n+queuelib==1.5.0\r\n+readme-renderer==24.0\r\n requests==2.24.0\r\n-requests-ftp==0.3.1\r\n-SecretStorage==3.1.2\r\n-simplejson==3.17.2\r\n+requests-toolbelt==0.9.1\r\n+scipy==1.4.1\r\n+Scrapy==1.7.3\r\n+SecretStorage==3.1.1\r\n+service-identity==18.1.0\r\n+setuptools-scm==3.3.3\r\n+shleeh==0.0.7\r\n+SimpleITK==1.2.4\r\n+simplejson==3.16.0\r\n six==1.15.0\r\n-soupsieve==2.0.1\r\n-tqdm==4.48.2\r\n-typing-extensions==3.7.4.3\r\n-urllib3==1.25.10\r\n-vcrpy==4.1.0\r\n+smmap==0.9.0\r\n+smmap2==2.0.5\r\n+snakeviz==2.0.1\r\n+snowballstemmer==1.9.0\r\n+Sphinx==2.1.2\r\n+sphinxcontrib-applehelp==1.0.1\r\n+sphinxcontrib-devhelp==1.0.1\r\n+sphinxcontrib-htmlhelp==1.0.2\r\n+sphinxcontrib-jsmath==1.0.1\r\n+sphinxcontrib-plantuml==0.17\r\n+sphinxcontrib-qthelp==1.0.2\r\n+sphinxcontrib-serializinghtml==1.1.3\r\n+sphinxcontrib-svg2pdfconverter==1.0.1\r\n+sphinxcontrib-websupport==1.2.2\r\n+sphinx-notfound-page==0.4\r\n+sphinx-rtd-theme==0.4.3\r\n+sphinx-sitemap==2.1.0\r\n+SQLAlchemy==1.3.13\r\n+tornado==6.0.3\r\n+tqdm==4.46.1\r\n+traitlets==4.3.2\r\n+twine==2.0.0\r\n+Twisted==19.2.1\r\n+urllib3==1.25.3\r\n+vcrpy==4.0.2\r\n+versioneer==0.18\r\n+w3lib==1.20.0\r\n+wcwidth==0.1.7\r\n+webencodings==0.5.1\r\n Whoosh==2.7.4\r\n-wrapt==1.12.1\r\n-yarl==1.5.1\r\n+wrapt==1.11.2\r\n+xlrd==1.2.0\r\n+yarl==1.4.2\r\n zipp==3.1.0\r\n+zope.interface==4.6.0\r\n```\r\n\r\n</details>", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4832/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4832/timeline", "performed_via_github_app": null}