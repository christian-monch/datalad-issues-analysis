{"url": "https://api.github.com/repos/datalad/datalad/issues/3554", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3554/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3554/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3554/events", "html_url": "https://github.com/datalad/datalad/issues/3554", "id": 471757994, "node_id": "MDU6SXNzdWU0NzE3NTc5OTQ=", "number": 3554, "title": "Consider command for spliting dataset", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 736433505, "node_id": "MDU6TGFiZWw3MzY0MzM1MDU=", "url": "https://api.github.com/repos/datalad/datalad/labels/severity-wishlist", "name": "severity-wishlist", "color": "ffeeee", "default": false, "description": "feature request, or bugs that are very difficult to fix due to design issues"}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-07-23T15:14:40Z", "updated_at": "2021-10-01T10:36:40Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Today on the call the idea of a command for splitting a dataset into multiple came up.  Off the top of my head, I don't have a description of what the interface should look like or what capabilities should be supported, so this issue is mostly a placeholder to be fleshed out.\r\n\r\nI mentioned that @jbpoline had previously discussed splitting datasets with me and @yarikoptic and that I had sent him a follow-up email with a rough sketch of an approach.  Here it is in case it's of any use.\r\n\r\n<details>\r\n<summary>email</summary>\r\n\r\n```\r\nSubject: splitting dataset by cloning\r\nDate: Fri, 19 Apr 2019 23:03:37 -0400\r\n\r\nHi JB,\r\n\r\nStemming from the discussion today, here's an attempt to split a\r\nrepository with a cloning-based method.  It preserves things like\r\nmetadata and URLs, but, as I note at the end, the git-annex branch\r\nisn't entirely pruned.\r\n\r\nFirst, here's the setup for a toy repository.  The important thing is\r\nthat we're registering URLs and adding metadata that should be preserved\r\nin the split.\r\n\r\n  $ cd $(mktemp -dt dl-split-XXXX)\r\n  $ datalad create ds\r\n  $ cd ds && mkdir dir-a dir-b\r\n\r\n  $ cd dir-a\r\n  $ datalad download-url -m'dir-a url' \\\r\n    https://raw.githubusercontent.com/datalad/artwork/master/brochure/git-annex-logo.svg\r\n  $ git annex metadata --set somekey=val-a git-annex-logo.svg\r\n\r\n  $ cd ../dir-b\r\n  $ datalad download-url -m'dir-b url' \\\r\n    https://raw.githubusercontent.com/datalad/artwork/master/logos/logo_solo.svg\r\n  $ git annex metadata --set somekey=val-b logo_solo.svg\r\n\r\nThat gives us a dataset with the following structure:\r\n\r\n  ds\r\n  |-- dir-a\r\n  |   `-- git-annex-logo.svg -> ../.git/annex/objects/[...]\r\n  `-- dir-b\r\n      `-- logo_solo.svg -> ../.git/annex/objects/[...]\r\n\r\nNow clone that repository into a new one that we will prune.\r\n\r\n  $ cd ../..\r\n  $ datalad install -s ds subset && cd subset\r\n\r\nAt this point, we need to get rid of the files and git history that we\r\ndon't want and then create a new dataset (i.e. generate a new dataset\r\nUUID).  One way to do this would be to check out an orphan branch\r\n(e.g., `git checkout --orphan=new`), remove any files that we don't\r\nwant, and drop 'datalad.dataset.id' from .datalad/config.  But if the\r\nfiles we want to keep are limited to a subdirectory, it's simpler to\r\nuse filter-branch to create a new, restricted branch.\r\n\r\n  $ git filter-branch --subdirectory-filter dir-a\r\n\r\nAfter this, we'll be left with the single commit from above that\r\ntouched dir-a.  The working tree no longer contains a .datalad/config\r\nfile, so we can simply create a new dataset without worrying about the\r\nprevious dataset ID.\r\n\r\n  $ datalad create --force\r\n\r\nWe can disconnect from the source repository by declaring the remote\r\ndead to annex (important for the next step) and removing the git\r\nremote:\r\n\r\n  $ git annex dead origin && git remote rm origin\r\n\r\nWe can now squash history on the git-annex branch, pruning information\r\nabout the dead remote.\r\n\r\n  $ git branch git-annex-old git-annex  # backup branch for comparison\r\n  $ git annex forget --force --drop-dead\r\n\r\nIf you diff the new git-annex branch with the old one, you'll see that\r\nthe information about the previous remote was dropped, as intended.\r\n\r\n  $ git diff git-annex-old git-annex\r\n\r\nAs expected, but sadly for this use case, information about other keys\r\nfor files that we filtered out (in this case the key that was in dir-b,\r\nwhich we removed) is still available in the git-annex branch.  For\r\nexample, here is the metadata information for the file that was in\r\ndir-b:\r\n\r\n  $ git grep val-b git-annex\r\n  git-annex:b05/e5b/MD5E-s4327--c9d3989d28cce3495a9b0f679e69f143.svg.log.met\r\n\r\nAnd here's that non-existent file's URL:\r\n\r\n  $ git grep --name-only logo_solo git-annex\r\n  git-annex:b05/e5b/MD5E-s4327--c9d3989d28cce3495a9b0f679e69f143.svg.log.web\r\n\r\nSo, if you're splitting a large repository with this method, you'll\r\nend up with a lot of unneeded content in the git-annex branch, which\r\nis kind of a waste.\r\n\r\nNot sure if that's helpful, but figured I'd send it along in case.\r\n```\r\n\r\n</details>\r\n\r\n\r\n", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3554/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3554/timeline", "performed_via_github_app": null}