{"url": "https://api.github.com/repos/datalad/datalad/issues/2269", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2269/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2269/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2269/events", "html_url": "https://github.com/datalad/datalad/issues/2269", "id": 302554120, "node_id": "MDU6SXNzdWUzMDI1NTQxMjA=", "number": 2269, "title": "Interface: Positional argument with dashes leads to an error", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 2096760260, "node_id": "MDU6TGFiZWwyMDk2NzYwMjYw", "url": "https://api.github.com/repos/datalad/datalad/labels/corpse-in-basement", "name": "corpse-in-basement", "color": "d4c5f9", "default": false, "description": ""}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-03-06T03:47:27Z", "updated_at": "2021-03-24T21:03:00Z", "closed_at": "2021-03-24T21:03:00Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "When converting the addurls plugin into a command, I wanted to use a positional argument that had a dash in it, but this doesn't seem to be possible.\r\n\r\nAs a simple example (which can be applied to master):\r\n\r\n```diff\r\ndiff --git a/datalad/interface/__init__.py b/datalad/interface/__init__.py\r\nindex bd9019d36..cf2eff674 100644\r\n--- a/datalad/interface/__init__.py\r\n+++ b/datalad/interface/__init__.py\r\n@@ -68,6 +68,7 @@\r\n         ('datalad.interface.download_url', 'DownloadURL', 'download-url'),\r\n         ('datalad.interface.run', 'Run', 'run'),\r\n         ('datalad.interface.rerun', 'Rerun', 'rerun'),\r\n+        ('datalad.interface.posarg', 'Posarg', 'posarg'),\r\n     ])\r\n\r\n _group_plumbing = (\r\ndiff --git a/datalad/interface/posarg.py b/datalad/interface/posarg.py\r\nnew file mode 100644\r\nindex 000000000..6147b8f3b\r\n--- /dev/null\r\n+++ b/datalad/interface/posarg.py\r\n@@ -0,0 +1,33 @@\r\n+\"\"\"Take a position argument\"\"\"\r\n+\r\n+__docformat__ = 'restructuredtext'\r\n+\r\n+from datalad.distribution.dataset import datasetmethod\r\n+from datalad.interface.base import Interface\r\n+from datalad.interface.base import build_doc\r\n+from datalad.interface.utils import eval_results\r\n+from datalad.support.param import Parameter\r\n+\r\n+import logging\r\n+\r\n+lgr = logging.getLogger('datalad.interface.posarg')\r\n+\r\n+\r\n+@build_doc\r\n+class Posarg(Interface):\r\n+    \"\"\"Blah\"\"\"\r\n+    _params_ = dict(\r\n+        pos_arg=Parameter(\r\n+            args=(\"pos-arg\",),\r\n+            doc=\"a positional argument.  Try to use me.\"),\r\n+        opt_arg=Parameter(\r\n+            args=(\"--opt-arg\",),\r\n+            doc=\"an optional argument\"),\r\n+    )\r\n+\r\n+    @staticmethod\r\n+    @datasetmethod(name='posarg')\r\n+    @eval_results\r\n+    def __call__(pos_arg, opt_arg=None):\r\n+        print(posarg)\r\n+        yield {}\r\n\r\n```\r\n\r\nInvoking this results in the following error:\r\n\r\n```\r\n$ datalad posarg ok\r\n[ERROR  ] 'Namespace' object has no attribute 'pos_arg' [base.py:<dictcomp>:393] (AttributeError)\r\n```\r\n\r\nIf I replace `args=(\"pos-arg\",)` with `args=(\"pos_arg\",)`, I see the same error.\r\n\r\nIf I instead add `dest=\"pos_arg\"`, I get a different error:\r\n\r\n```\r\n$ datalad posarg ok\r\nTraceback (most recent call last):\r\n  File \"/home/kyle/src/python/datalad/venv-datalad/bin/datalad\", line 8, in <module>\r\n    main()\r\n  File \"/home/kyle/src/python/datalad/datalad/cmdline/main.py\", line 304, in main\r\n    parser = setup_parser(args or sys.argv)\r\n  File \"/home/kyle/src/python/datalad/datalad/cmdline/main.py\", line 245, in setup_parser\r\n    _intf.setup_parser(subparser)\r\n  File \"/home/kyle/src/python/datalad/datalad/interface/base.py\", line 375, in setup_parser\r\n    **parser_kwargs)\r\n  File \"/usr/lib/python3.5/argparse.py\", line 1320, in add_argument\r\n    raise ValueError('dest supplied twice for positional argument')\r\nValueError: dest supplied twice for positional argument\r\n```\r\n\r\n#### First error\r\n\r\nI think what is going on is that `base.Interface.setup_parser` assumes that argparse replaces all dashes in the argument's name with underscores.  However, it seems that `ArgumentParser.parse_known_args` [leaves][0] dashes in positional arguments untouched:\r\n\r\n```\r\nNamespace(_=False, cfg_overrides=None, change_path=None, common_debug=False, common_idebug=False, common_on_failure=None, common_output_format='default', common_report_status=None, common_report_type=None, common_run_after=None, common_run_before=None, func=<bound method Interface.call_from_parser of <class 'datalad.interface.posarg.Posarg'>>, help=None, log_level='warning', logger=<logging.Logger object at 0x7f07c37babe0>, opt_arg=None, pbs_runner=None, pos-arg='ok', subparser=ArgumentParser(prog='datalad posarg', usage=None, description='Blah', formatter_class=<class 'argparse.RawDescriptionHelpFormatter'>, conflict_handler='error', add_help=False))\r\n```\r\n\r\nNote the \"pos-arg\".  So, when `base.Interface.call_from_parser` [goes looking][1] for `pos_arg`, it doesn't find it, leading to the attribute error.\r\n\r\nOr, to remove this from the context of datalad:\r\n\r\n```python\r\n>>> import argparse\r\n>>> parser = argparse.ArgumentParser()\r\n>>> parser.add_argument('fo-o')\r\n>>> parser.add_argument('--ba-z')\r\n>>> parser.parse_args('arg'.split())\r\nNamespace(ba_z=None, fo-o='arg')\r\n```\r\n\r\n#### Second error\r\n\r\nThe second error seems to come from the fact that `argparse.add_argument` treats `dest` [differently][2] depending on whether the argument is a positional argument or an optional one, but `Interface.base.setup_parser` doesn't account for this.\r\n\r\nFixing this error would make it easy to work around the first error by specifying `dest`.  If I'm thinking about this correctly, it should be enough for `setup_parser` to check whether the argument is a positional one and, if so, move `dest` from `parser_kwargs` to the first argument in `parser_args`.\r\n\r\n[0]: https://github.com/datalad/datalad/blob/afe3db7e9fc01d84947452e33f8786cb953420cb/datalad/cmdline/main.py#L312\r\n[1]: https://github.com/datalad/datalad/blob/afe3db7e9fc01d84947452e33f8786cb953420cb/datalad/interface/base.py#L393\r\n[2]: https://docs.python.org/2/library/argparse.html?highlight=add_argument#dest\r\n", "closed_by": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2269/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2269/timeline", "performed_via_github_app": null}