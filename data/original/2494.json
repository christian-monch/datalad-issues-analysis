{"url": "https://api.github.com/repos/datalad/datalad/issues/2494", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2494/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2494/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2494/events", "html_url": "https://github.com/datalad/datalad/issues/2494", "id": 323660234, "node_id": "MDU6SXNzdWUzMjM2NjAyMzQ=", "number": 2494, "title": "OPT: even basic datalad command(s) terribly slow to start", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 390153891, "node_id": "MDU6TGFiZWwzOTAxNTM4OTE=", "url": "https://api.github.com/repos/datalad/datalad/labels/UX", "name": "UX", "color": "0052cc", "default": false, "description": "user experience"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-05-16T14:59:17Z", "updated_at": "2018-05-21T21:04:57Z", "closed_at": "2018-05-21T21:04:57Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "#### What is the problem?\r\nWith all the extensions etc `datalad` cmdline invocation grew unacceptably slow to start.  Here are some timings from a run of `datalad` on smaug (although it is IO busy ATM) which takes over a second.\r\nI have trimmed the boring lines, and the number upfront shows how long it takes from that log line to the next.  We can see that it is something within main `__init__` which takes awhile (unlikely ssh manager takes that long ), and then entry point for neuroimaging loading (I guess since there is not much of log messages within it -- can't tell where exactly 300ms is wasted)\r\n```shell\r\n(git)smaug:~datalad/datalad-neuroimaging[master]git\r\n$> DATALAD_LOG_TIMESTAMP=1 DATALAD_LOG_LEVEL=2 datalad 2>&1 | ../datalad-master/tools/dtime\r\n  572 2018-05-16 10:24:03,788 [Level 5] Instantiating ssh manager\r\n    1 2018-05-16 10:24:04,360 [Level 5] Done importing main __init__\r\n  314 2018-05-16 10:24:04,361 [Level 5] Importing cmdline.main\r\n    1 2018-05-16 10:24:04,675 [Level 5] Done importing cmdline.main\r\n    0 2018-05-16 10:24:04,676 [Level 5] Starting main(None)\r\n   57 2018-05-16 10:24:04,676 [Level 5] Starting to setup_parser\r\n    6 2018-05-16 10:24:04,733 [Level 5] Importing support.network\r\n...\r\n   37 2018-05-16 10:24:04,740 [Level 5] Importing dataset\r\n  320 2018-05-16 10:24:04,777 [DEBUG] Loading entrypoint neuroimaging from datalad.extensions\r\n    2 2018-05-16 10:24:05,097 [Level 5] Importing module datalad.distribution.create\r\n  ...\r\n    0 2018-05-16 10:24:05,207 [DEBUG] Building doc for <class 'datalad.distribution.create_test_dataset.CreateTestDataset'>\r\n  294 2018-05-16 10:24:05,207 [DEBUG] Building doc for <class 'datalad.support.sshrun.SSHRun'>\r\n    6 2018-05-16 10:24:05,501 [DEBUG] Building doc for <class 'datalad_neuroimaging.bids2scidata.BIDS2Scidata'>\r\n...\r\n```\r\nupon invocation of some (in this case `install`) command situation seems to differ a bit:\r\n```shell\r\n$> DATALAD_LOG_TIMESTAMP=1 DATALAD_LOG_LEVEL=2 datalad install -s /// /tmp/123333  2>&1 | ../datalad-master/tools/dtime\r\n    5 2018-05-16 10:30:37,744 [Level 5] Instantiating ssh manager\r\n    0 2018-05-16 10:30:37,749 [Level 5] Done importing main __init__\r\n  286 2018-05-16 10:30:37,749 [Level 5] Importing cmdline.main\r\n    0 2018-05-16 10:30:38,035 [Level 5] Done importing cmdline.main\r\n    0 2018-05-16 10:30:38,035 [Level 5] Starting main(None)\r\n   72 2018-05-16 10:30:38,035 [Level 5] Starting to setup_parser\r\n    9 2018-05-16 10:30:38,107 [Level 5] Importing support.network\r\n...\r\n    2 2018-05-16 10:30:38,117 [DEBUG] parseParameters: Given \"with_urls_only : bool, optional\r\n   47 2018-05-16 10:30:38,119 [Level 5] Importing dataset\r\n  303 2018-05-16 10:30:38,166 [DEBUG] Loading entrypoint neuroimaging from datalad.extensions\r\n    2 2018-05-16 10:30:38,469 [Level 5] Importing module datalad.distribution.install\r\n...\r\n    0 2018-05-16 10:30:38,576 [Level 5] Detected url ri\r\n  239 2018-05-16 10:30:38,576 [DEBUG] Git clone from http://datasets.datalad.org/.git to /tmp/123333\r\n    1 2018-05-16 10:30:38,815 [DEBUG] Git clone completed\r\n   18 2018-05-16 10:30:38,816 [Level 9] Running: ['git', 'version']\r\n```\r\nso import of main proceeds faster, we do not build not needed docs, but then still spend a lot while importing cmdline.main somehow and  loading of `neuroimaging` (not really needed for anything here) is taking a good toll.  If we get even more extensions, impact would be even higher! (although installing `crawler` into this added \"only\" 78ms, so not as bad, but still not good since it is not needed for anything in install)\r\n\r\nSo I feel that \r\n- [x] `from pkg_resources import iter_entry_points` should always be delayed until point/func of use to avoid heavy import time impact upon merely importing our submodules (#2495)\r\n- [x] no need to generate full docs if only list of commands need to be presented\r\n- [ ] no need to build docs for classes for which --help is not asked for\r\n- [ ] no need to look at extensions if a command of interest is internal/known.\r\n  - I thought even that eventually we might want to keep a registry of some commands and extensions from which they might come, so we could let user known that `crawl command is provided by datalad-crawler extension. It could be installed via \"pip install datalad-crawler\"` (patched correspondingly for debian)\r\n- [ ] \"extensions\" functionality should be loaded \"lazily\" by `.api` somehow instead of upon every command invocation\r\n- [ ] come back and see if we could do anything about not bothering with ssh manager instantiation (IMHO should be relevant only if we at least work with some Dataset or GitRepo so may be could be done then, need to find an issue where we discussed it before)\r\n", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2494/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2494/timeline", "performed_via_github_app": null}