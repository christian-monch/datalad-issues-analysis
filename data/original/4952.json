{"url": "https://api.github.com/repos/datalad/datalad/issues/4952", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4952/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4952/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4952/events", "html_url": "https://github.com/datalad/datalad/pull/4952", "id": 707459257, "node_id": "MDExOlB1bGxSZXF1ZXN0NDkxODU3NjQ5", "number": 4952, "title": "downloader: handle non-utf8 files being downloaded", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1746781627, "node_id": "MDU6TGFiZWwxNzQ2NzgxNjI3", "url": "https://api.github.com/repos/datalad/datalad/labels/merge-if-ok", "name": "merge-if-ok", "color": "fbca04", "default": false, "description": "OP considers this work done, and requests review/merge"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/79", "html_url": "https://github.com/datalad/datalad/milestone/79", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/79/labels", "id": 5909792, "node_id": "MDk6TWlsZXN0b25lNTkwOTc5Mg==", "number": 79, "title": "0.13.4", "description": null, "creator": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 2, "state": "closed", "created_at": "2020-09-23T14:28:31Z", "updated_at": "2021-01-06T14:54:49Z", "due_on": null, "closed_at": "2021-01-06T14:54:49Z"}, "comments": 4, "created_at": "2020-09-23T15:19:09Z", "updated_at": "2020-10-07T15:23:49Z", "closed_at": "2020-09-24T15:44:10Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/4952", "html_url": "https://github.com/datalad/datalad/pull/4952", "diff_url": "https://github.com/datalad/datalad/pull/4952.diff", "patch_url": "https://github.com/datalad/datalad/pull/4952.patch"}, "body": "Some downloaders need to read-in the actual downloaded content to see if it may be a \"login error\" message since portals do not return a proper 403 etc.  If content is not utf8 - it was causing a puke (#4951) .\r\n\r\nThis is likely a tip of an iceberg and there could be more of places in datalad where we read some content assuming it to be utf-8, whenever it is not.  Introduced here `read_file` (I am ok to rename if desired, initially `read_file_ensure_unicode` - generalized into one to use without decoding as well) would be of help.  May be you know a better way? but I thought it would be nice to centralize all such logic on encoding discovery via `ensure_unicode` which we do use already quite a bit throughout the code.\r\n\r\nedit 1 after more pushes: One functionality change/fix is for S3 downloader is to not try to decode content (when no file is provided) to stay consistent with http downloader which uses BytesIO and just returns its content.  It is up for outside logic on either to decode it ATM, although generally downloaders should respect content-type/encoding header fields and act appropriately (which AFIAK they don't do ATM) but that is outside of the scope of this BF PR.", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4952/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4952/timeline", "performed_via_github_app": null}