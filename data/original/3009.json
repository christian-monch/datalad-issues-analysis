{"url": "https://api.github.com/repos/datalad/datalad/issues/3009", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3009/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3009/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3009/events", "html_url": "https://github.com/datalad/datalad/pull/3009", "id": 383923886, "node_id": "MDExOlB1bGxSZXF1ZXN0MjMzMjc3MzE0", "number": 3009, "title": "BF:  be able to commit annexed changed files which potentially jump between git/annex", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/55", "html_url": "https://github.com/datalad/datalad/milestone/55", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/55/labels", "id": 3757215, "node_id": "MDk6TWlsZXN0b25lMzc1NzIxNQ==", "number": 55, "title": "Release 0.11.1", "description": "", "creator": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "open_issues": 0, "closed_issues": 34, "state": "closed", "created_at": "2018-10-22T14:17:38Z", "updated_at": "2018-11-27T03:27:46Z", "due_on": null, "closed_at": "2018-11-27T03:27:46Z"}, "comments": 8, "created_at": "2018-11-23T20:44:32Z", "updated_at": "2019-02-17T03:53:58Z", "closed_at": "2018-11-27T03:26:35Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/3009", "html_url": "https://github.com/datalad/datalad/pull/3009", "diff_url": "https://github.com/datalad/datalad/pull/3009.diff", "patch_url": "https://github.com/datalad/datalad/pull/3009.patch"}, "body": "This pull request fixes #1651, fixes #2752. Ran into it again in the course of preparing PR for #3007 \r\n\r\n- includes some minor refactoring and BFing around the code\r\n\r\n- overall it boils down to adopting our \"hack\" for direct mode to be applied generally when we are working with a commit for specific subset of files.  All the files listed to be committed and which were not staged, would get first `annex add`-ed, index would be copied into a temporary one, staged files which are not to be committed, reset from that index, we commit, and if we added some files explicitly - we reset original index to match the committed state.\r\n\r\nWhat is more \"useful\" in this PR is actually the unittest which triggers original failure.  Now I am testing only with first optionally unlocking of the files to be edited, but we should test also with \"unannex\"ing first (left TODO for the future or revolution).\r\n\r\nTODOs\r\n- [x] fix introduced bugs/side-effects\r\n     - [x] side effect 1: save recursive - (re)solution was re-enable \"careless\" commits\r\n     - [x] bunch of failures in direct mode: https://travis-ci.org/datalad/datalad/jobs/458946969 \r\n- [x] assess hit on performance (benchmarks)\r\n\r\n<details>\r\n<summary>side effect 1:</summary>\r\n\r\nhttp://smaug.datalad.org:8020/builders/datalad-pr-docker-dl-nd16_04/builds/3119/steps/nosetests/logs/stdio\r\n```\r\n======================================================================\r\nERROR: datalad.interface.tests.test_save.test_recursive_save\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/dist-packages/nose/case.py\", line 197, in runTest\r\n    self.test(*self.arg)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/tests/utils.py\", line 596, in newfunc\r\n    return t(*(arg + (filename,)), **kw)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/interface/tests/test_save.py\", line 230, in test_recursive_save\r\n    subsubds.save(message=\"savingtestmessage\", super_datasets=True)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/venv-ci/local/lib/python2.7/site-packages/wrapt/wrappers.py\", line 562, in __call__\r\n    args, kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/distribution/dataset.py\", line 494, in apply_func\r\n    return f(**kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/venv-ci/local/lib/python2.7/site-packages/wrapt/wrappers.py\", line 523, in __call__\r\n    args, kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/interface/utils.py\", line 479, in eval_func\r\n    return return_func(generator_func)(*args, **kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/venv-ci/local/lib/python2.7/site-packages/wrapt/wrappers.py\", line 523, in __call__\r\n    args, kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/interface/utils.py\", line 467, in return_func\r\n    results = list(results)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/interface/utils.py\", line 422, in generator_func\r\n    result_renderer, result_xfm, _result_filter, **_kwargs):\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/interface/utils.py\", line 509, in _process_results\r\n    for res in results:\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/interface/save.py\", line 398, in __call__\r\n    message=message)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/interface/save.py\", line 142, in save_dataset\r\n    careless=True)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/support/annexrepo.py\", line 2941, in commit\r\n    index_file=alt_index_file)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/support/gitrepo.py\", line 1308, in commit\r\n    index_file=index_file)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/support/annexrepo.py\", line 1256, in _git_custom_command\r\n    return super(AnnexRepo, self)._git_custom_command(*args, **kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/support/gitrepo.py\", line 313, in newfunc\r\n    result = func(self, files_new, *args, **kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/support/gitrepo.py\", line 1747, in _git_custom_command\r\n    expect_fail=expect_fail)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/cmd.py\", line 673, in run\r\n    cmd, env=self.get_git_environ_adjusted(env), *args, **kwargs)\r\n  File \"/home/buildbot/datalad-pr-docker-dl-nd16_04/build/datalad/cmd.py\", line 533, in run\r\n    raise CommandError(str(cmd), msg, status, out[0], out[1])\r\nCommandError: CommandError: command '['git', '-c', 'receive.autogc=0', '-c', 'gc.auto=0', 'commit', '-m', 'savingtestmessage']' failed with exitcode 1\r\nFailed to run ['git', '-c', 'receive.autogc=0', '-c', 'gc.auto=0', 'commit', '-m', 'savingtestmessage'] under u'/tmp/datalad_temp_test_recursive_savewPsceM/sub'. Exit code=1. out=On branch master\r\nChanges not staged for commit:\r\n\tmodified:   subsub (untracked content)\r\n\r\nUntracked files:\r\n\ttestadded\r\n\ttestnew\r\n\r\nno changes added to commit\r\n err=\r\n```\r\n</details>", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3009/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3009/timeline", "performed_via_github_app": null}