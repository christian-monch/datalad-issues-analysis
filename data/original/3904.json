{"url": "https://api.github.com/repos/datalad/datalad/issues/3904", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3904/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3904/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3904/events", "html_url": "https://github.com/datalad/datalad/pull/3904", "id": 534343514, "node_id": "MDExOlB1bGxSZXF1ZXN0MzUwMjY4NjA1", "number": 3904, "title": "BF: gitrepo: Work around change in 'ls-files -o' output", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 6, "created_at": "2019-12-07T02:50:17Z", "updated_at": "2019-12-08T22:05:09Z", "closed_at": "2019-12-08T08:13:05Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/3904", "html_url": "https://github.com/datalad/datalad/pull/3904", "diff_url": "https://github.com/datalad/datalad/pull/3904.diff", "patch_url": "https://github.com/datalad/datalad/pull/3904.patch"}, "body": "```\r\nsave_() calls 'ls-files -o' on a list of untracked directories to\r\ndetermine which directories correspond to untracked submodules.  If\r\nthe directories remain unexpanded in the 'ls-files -o' output, they\r\nare taken as submodules.\r\n\r\nThis method of identifying untracked submodules breaks [0,1] with the\r\nlatest release of Git (v2.24.0) due to an unintentional change in the\r\n'ls-files -o' output [2]: when given _multiple_ pathspecs, 'ls-files\r\n-o' recurses into untracked submodules and lists the files from the\r\nsubmodule (even the tracked ones).  save_() filters the output to\r\ndirectories, so most of the additional entries are removed, but when\r\nthe submodule itself has submodules (untracked or tracked) these and\r\nthose from any deeper levels are included in the output.  save_()\r\npasses these deeper repositories to add_submodule(), which as expected\r\nleads to 'git submodule add' failing.\r\n\r\nThis behavior will hopefully be addressed in Git itself [2], but we\r\nshould still provide a workaround for the current version of Git.  Add\r\na helper that filters these deeper repositories from the list of\r\nsubmodules that save_() feeds to add_submodule().  This approach takes\r\nadvantage of the fact that, even when 'ls-files -o' misbehaves and\r\ntraverses into the submodule, it still reports an unexpanded entry.\r\nIf it didn't, we wouldn't be able to distinguish a submodule from a\r\nregular directory.\r\n\r\nNote that the helper is conditionally defined at the module level; for\r\nearlier versions of Git that don't need this kludge, this reduces the\r\ncost per save_() call to a single call to an identity function.\r\n```\r\n\r\n0: https://github.com/datalad/datalad/issues/3890#issuecomment-561722194\r\n1: https://github.com/datalad/datalad/pull/3902#issuecomment-562630681\r\n2: https://lore.kernel.org/git/87fti15agv.fsf@kyleam.com/T/#u\r\n\r\n---\r\n\r\nMarking as \"do not merge\" because the tip commit should be dropped before merging.", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3904/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3904/timeline", "performed_via_github_app": null}