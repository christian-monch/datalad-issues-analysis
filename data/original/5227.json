{"url": "https://api.github.com/repos/datalad/datalad/issues/5227", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5227/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5227/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5227/events", "html_url": "https://github.com/datalad/datalad/issues/5227", "id": 760637039, "node_id": "MDU6SXNzdWU3NjA2MzcwMzk=", "number": 5227, "title": "FOI: recipe for uploading (exporting) (super)dataset fully to S3", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2020-12-09T20:12:58Z", "updated_at": "2021-09-27T14:27:50Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "I thought it (after we finalize it to our satisfaction) could at least be an addition to the handbook somewhere (hence attn @adswa), but ideally we should look into :\r\n\r\n- establish support for `annex initremote` of arbitrary type (or can we do it already?), smth like `create-sibling-annex` if we follow current approach of `create-sibling*`\r\n- add support for using `annex export` instead of `annex copy` for those with `exporttree=yes` (#3127)\r\n\r\nHere is our quick&dirty script we came up with @snastase while preparing upload to fcp-indi which you point to superdataset, bucket, and prefix and it exports (or re-exports if any updates) to S3:\r\n\r\n<details>\r\n<summary>the script</summary> \r\n\r\n```bash\r\n#!/bin/bash\r\n\r\nset -eu\r\n\r\nexport PS4='> '\r\nset -x\r\n\r\ntopds=\"$1\"\r\nbucket=\"$2\"\r\nprefix=\"$3\"\r\n\r\n# TEMP\r\nsrname=\"${bucket}5\"\r\n\r\ntopdsfull=$PWD/$topds/\r\n\r\nif ! git annex version | grep 8.20201 ; then\r\n\techo \"E: need recent git annex. check what you have\"\r\n\texit 1\r\nfi\r\n\r\n{ echo \"$topdsfull\"; datalad -f '{path}' subdatasets -r -d \"$topds\"; } | \\\r\nwhile read ds; do\r\n\trelds=$(relpath \"$ds\" \"$topdsfull\")\r\n\tfileprefix=\"$prefix/$relds/\"\r\n\tfileprefix=$(python -c \"import os,sys; print(os.path.normpath(sys.argv[1]))\" \"$fileprefix\")\r\n\techo $relds;\r\n\t(\r\n\t\tcd \"$ds\";\r\n\t\t# TODO: make sure that there is no ./ or // in fileprefix\r\n\t\tif ! git remote | grep -q \"$srname\"; then\r\n\t\t\tgit annex initremote --debug \"$srname\" \\\r\n\t\t\t\ttype=S3 \\\r\n\t\t\t\tautoenable=true \\\r\n\t\t\t\tbucket=$bucket \\\r\n\t\t\t\tencryption=none \\\r\n\t\t\t\texporttree=yes \\\r\n\t\t\t\t\"fileprefix=$fileprefix/\" \\\r\n\t\t\t\thost=s3.amazonaws.com \\\r\n\t\t\t\tpartsize=1GiB \\\r\n\t\t\t\tport=80 \\\r\n\t\t\t\t\"publicurl=https://s3.amazonaws.com/$bucket\" \\\r\n\t\t\t\tpublic=yes \\\r\n\t\t\t\tversioning=yes\r\n\t\tfi\r\n\t\tgit annex export --to \"$srname\" --jobs 6 master\r\n\r\n\t)\r\ndone\r\n\r\n```\r\n</details>", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5227/reactions", "total_count": 3, "+1": 3, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5227/timeline", "performed_via_github_app": null}