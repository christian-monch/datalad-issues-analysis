{"url": "https://api.github.com/repos/datalad/datalad/issues/3901", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3901/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3901/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3901/events", "html_url": "https://github.com/datalad/datalad/issues/3901", "id": 533789671, "node_id": "MDU6SXNzdWU1MzM3ODk2NzE=", "number": 3901, "title": "Unclear error for S3 download", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 63778590, "node_id": "MDU6TGFiZWw2Mzc3ODU5MA==", "url": "https://api.github.com/repos/datalad/datalad/labels/severity-normal", "name": "severity-normal", "color": "ff8888", "default": false, "description": "standard severity"}, {"id": 227904225, "node_id": "MDU6TGFiZWwyMjc5MDQyMjU=", "url": "https://api.github.com/repos/datalad/datalad/labels/documentation", "name": "documentation", "color": "cfd3d7", "default": true, "description": "Changes only affect the documentation"}, {"id": 390153891, "node_id": "MDU6TGFiZWwzOTAxNTM4OTE=", "url": "https://api.github.com/repos/datalad/datalad/labels/UX", "name": "UX", "color": "0052cc", "default": false, "description": "user experience"}, {"id": 655634847, "node_id": "MDU6TGFiZWw2NTU2MzQ4NDc=", "url": "https://api.github.com/repos/datalad/datalad/labels/good-for-hackathon", "name": "good-for-hackathon", "color": "fbca04", "default": false, "description": ""}, {"id": 2919091393, "node_id": "MDU6TGFiZWwyOTE5MDkxMzkz", "url": "https://api.github.com/repos/datalad/datalad/labels/credentials", "name": "credentials", "color": "768F68", "default": false, "description": "Issues concerning credential(-management)"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2019-12-06T07:12:39Z", "updated_at": "2021-07-07T18:57:27Z", "closed_at": "2021-07-07T18:57:27Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Example download from the public HCP S3 bucket. It reports not having permissions (only in debug run), downloads \"OK\" nevertheless, but ultimately fails to verify the URL in annex (I guess because the credentials are not working), and ultimately crashes.\r\n \r\nNormal command:\r\n\r\n```\r\n\u2771 datalad download-url \"s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe\" -O here2\r\n[INFO   ] Downloading 's3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe' into 'here2' \r\n[INFO   ] S3 session: Connecting to the bucket hcp-openaccess with authentication \r\ndownload_url(ok): here2 (file)                                                                                                                                                                                                                               \r\nadd(ok): here2 (file)\r\nsave(ok): . (dataset)\r\n[WARNING] Registering here2 with s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe failed: AnnexBatchCommandError: command 'addurl'\r\nError, annex reported failure for addurl (url='s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe'): {'command': 'addurl', 'success': False, 'error-messages': ['  while adding a new url to an already annexed file, failed to verify url exists: s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe'], 'file': 'here2'} [annexrepo.py:add_url_to_file:1857] \r\naction summary:\r\n  add (ok: 1)\r\n  download_url (ok: 1)\r\n  save (ok: 1)\r\nException ignored in: <function BatchedAnnexes.__del__ at 0x7f52b098c378>\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/datalad/support/annexrepo.py\", line 3461, in __del__\r\n  File \"/usr/lib/python3/dist-packages/datalad/support/annexrepo.py\", line 3458, in close\r\n  File \"/usr/lib/python3/dist-packages/datalad/cmd.py\", line 832, in close\r\nTypeError: 'NoneType' object is not callable\r\nException ignored in: <function BatchedCommand.__del__ at 0x7f52b12300d0>\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/datalad/cmd.py\", line 818, in __del__\r\n  File \"/usr/lib/python3/dist-packages/datalad/cmd.py\", line 832, in close\r\nTypeError: 'NoneType' object is not callable\r\n```\r\n\r\nDebug info:\r\n\r\n```\r\n\u2771 datalad -l debug download-url \"s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe\" -O here                                                                                130 !\r\n[DEBUG  ] Command line args 1st pass. Parsed: Namespace() Unparsed: ['download-url', 's3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe', '-O', 'here'] \r\n[DEBUG  ] Discovering plugins \r\n[DEBUG  ] Building doc for <class 'datalad.core.local.status.Status'> \r\n[DEBUG  ] Building doc for <class 'datalad.core.local.save.Save'> \r\n[DEBUG  ] Building doc for <class 'datalad.interface.download_url.DownloadURL'> \r\n[DEBUG  ] Parsing known args among ['/usr/bin/datalad', '-l', 'debug', 'download-url', 's3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe', '-O', 'here'] \r\n[DEBUG  ] Determined class of decorated function: <class 'datalad.interface.download_url.DownloadURL'> \r\n[DEBUG  ] Failed to import requests_ftp, thus no ftp support: No module named 'requests_ftp' [http.py:<module>:48] \r\n[DEBUG  ] parseParameters: Given \"\", we split into [] \r\n[DEBUG  ] parseParameters: Given \"credential: Credential, optional\r\n|   Provides necessary credential fields to be used by authenticator\r\n| authenticator: Authenticator, optional\r\n|   Authenticator to use for authentication.\", we split into [('credential', 'credential: Credential, optional\\n  Provides necessary credential fields to be used by authenticator'), ('authenticator', 'authenticator: Authenticator, optional\\n  Authenticator to use for authentication.')] \r\n[DEBUG  ] parseParameters: Given \"\", we split into [] \r\n[DEBUG  ] parseParameters: Given \"credential: Credential, optional\r\n|   Provides necessary credential fields to be used by authenticator\r\n| authenticator: Authenticator, optional\r\n|   Authenticator to use for authentication.\", we split into [('credential', 'credential: Credential, optional\\n  Provides necessary credential fields to be used by authenticator'), ('authenticator', 'authenticator: Authenticator, optional\\n  Authenticator to use for authentication.')] \r\n[DEBUG  ] Resolved dataset for downloading urls: /data/project/rehab_hcp/tmp \r\n[DEBUG  ] Reading files: ['/usr/lib/python3/dist-packages/datalad/downloaders/configs/providers.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/nda.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/crcns.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/nitrc.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/figshare.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/hcp.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/kaggle.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/crawdad.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/loris.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/openfmri.cfg', '/usr/lib/python3/dist-packages/datalad/downloaders/configs/indi.cfg'] \r\n[DEBUG  ] Assigning credentials into 19 providers \r\n[DEBUG  ] Returning provider Provider(authenticator=<<S3Authenticator(bucket...>>, credential=<<AWS_S3(name='hcp-s3', ...>>, name='hcp-s3', url_res=['s3://hcp-openaccess.*']) for url s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe \r\n[INFO   ] Downloading 's3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe' into 'here' \r\n[DEBUG  ] S3 session: Reconnecting to the bucket \r\n[DEBUG  ] Importing keyring \r\n[INFO   ] S3 session: Connecting to the bucket hcp-openaccess with authentication \r\n[DEBUG  ] Cannot access bucket hcp-openaccess by name: S3ResponseError: 403 Forbidden\r\n [connection.py:head_bucket:539] \r\n[DEBUG  ] Found following buckets hcp-openaccess, hcp-openaccess-logfiles, hcp-openaccess-logs-temp, hcp-openaccess-logstorage-temp, hcp-openaccess-test, hcp-openaccess-trail-temp \r\ndownload_url(ok): here (file)                                                                                                                                                                                                                                \r\n[DEBUG  ] Determined class of decorated function: <class 'datalad.core.local.save.Save'> \r\n[DEBUG  ] Resolved dataset for saving: /data/project/rehab_hcp/tmp \r\n[DEBUG  ] Determined class of decorated function: <class 'datalad.core.local.status.Status'> \r\n[DEBUG  ] Resolved dataset for status reporting: /data/project/rehab_hcp/tmp \r\n[DEBUG  ] query <AnnexRepo path=/data/project/rehab_hcp/tmp (<class 'datalad.support.annexrepo.AnnexRepo'>)>.diffstatus() for paths: [PosixPath('/data/project/rehab_hcp/tmp/here')] \r\n[DEBUG  ] <AnnexRepo path=/data/project/rehab_hcp/tmp (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...) \r\n[DEBUG  ] Query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o'] \r\n[DEBUG  ] Done query repo: ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard', '-o'] \r\n[DEBUG  ] Done <AnnexRepo path=/data/project/rehab_hcp/tmp (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...) \r\n[DEBUG  ] <AnnexRepo path=/data/project/rehab_hcp/tmp (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...) \r\n[DEBUG  ] Query repo: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] \r\n[DEBUG  ] Done query repo: ['git', 'ls-tree', 'HEAD', '-z', '-r', '--full-tree', '-l'] \r\n[DEBUG  ] Done <AnnexRepo path=/data/project/rehab_hcp/tmp (<class 'datalad.support.annexrepo.AnnexRepo'>)>.get_content_info(...) \r\n[DEBUG  ] Determined 1 datasets for saving from input arguments \r\n[DEBUG  ] 1 path(s) to add to <AnnexRepo path=/data/project/rehab_hcp/tmp (<class 'datalad.support.annexrepo.AnnexRepo'>)> {'here': {'state': 'untracked', 'type': 'file'}} \r\nadd(ok): here (file)\r\n[DEBUG  ] Committing via direct call of git: ['git', 'commit', '-m', '[DATALAD] Download URLs\\n\\nURLs:\\n  s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe'] \r\nsave(ok): . (dataset)\r\n[DEBUG  ] Initiating a new process for BatchedAnnex(cmd=<<['git', 'annex', 'addu...>>, output_proc=<function>, path='/data/project/rehab_hcp/tmp') \r\n[WARNING] Registering here with s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe failed: AnnexBatchCommandError: command 'addurl'\r\nError, annex reported failure for addurl (url='s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe'): {'command': 'addurl', 'success': False, 'error-messages': ['  while adding a new url to an already annexed file, failed to verify url exists: s3://hcp-openaccess/HCP_1200/966975/.xdlm/966975_3T_tfMRI_EMOTION_analysis_s4.json?versionId=kct4Q1cxV5Cb9N08pkDUpIuglCq8Flhe'], 'file': 'here'} [annexrepo.py:add_url_to_file:1857] \r\naction summary:\r\n  add (ok: 1)\r\n  download_url (ok: 1)\r\n  save (ok: 1)\r\nException ignored in: <function BatchedAnnexes.__del__ at 0x7fbffe942378>\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/datalad/support/annexrepo.py\", line 3461, in __del__\r\n  File \"/usr/lib/python3/dist-packages/datalad/support/annexrepo.py\", line 3458, in close\r\n  File \"/usr/lib/python3/dist-packages/datalad/cmd.py\", line 832, in close\r\nTypeError: 'NoneType' object is not callable\r\nException ignored in: <function BatchedCommand.__del__ at 0x7fbfff1e60d0>\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/datalad/cmd.py\", line 818, in __del__\r\n  File \"/usr/lib/python3/dist-packages/datalad/cmd.py\", line 832, in close\r\nTypeError: 'NoneType' object is not callable\r\n\r\n```", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3901/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3901/timeline", "performed_via_github_app": null}