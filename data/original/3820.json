{"url": "https://api.github.com/repos/datalad/datalad/issues/3820", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3820/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3820/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3820/events", "html_url": "https://github.com/datalad/datalad/issues/3820", "id": 509815128, "node_id": "MDU6SXNzdWU1MDk4MTUxMjg=", "number": 3820, "title": "`git status` broken in submodule with adjusted branch (on crippled FS)", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 63778590, "node_id": "MDU6TGFiZWw2Mzc3ODU5MA==", "url": "https://api.github.com/repos/datalad/datalad/labels/severity-normal", "name": "severity-normal", "color": "ff8888", "default": false, "description": "standard severity"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 4, "created_at": "2019-10-21T08:37:44Z", "updated_at": "2019-10-23T06:42:40Z", "closed_at": "2019-10-23T06:42:40Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "I was trying to figure out, how we could properly save the state of a modified subdataset in a parent repository when both are using adjusted branches. However, I stumbled upon behavior that seems like a more fundamental bug. Here is a demo:\r\n\r\nPrepare a repo with a submodule\r\n\r\n```\r\n/tmp % datalad create repo\r\n/tmp % datalad create -d repo repo/sub\r\n/tmp % echo 123 > repo/sub/file\r\n/tmp % echo 234 > repo/file\r\n/tmp % datalad save -d repo -r\r\n\r\n# clean state\r\n/tmp % git -C repo submodule\r\n fdb2afee57643a978494530b136a8ced7f6d5f34 sub (heads/master)\r\n\r\n/tmp % git -C repo/sub log -n1 |cat\r\ncommit fdb2afee57643a978494530b136a8ced7f6d5f34\r\nAuthor: Michael Hanke <michael.hanke@gmail.com>\r\nDate:   Mon Oct 21 09:37:04 2019 +0200\r\n\r\n    [DATALAD] Recorded changes\r\n/tmp % git -C repo status\r\nOn branch master\r\nnothing to commit, working tree clean\r\n```\r\n\r\nClone onto a crippled FS and initial both repos\r\n\r\n```\r\n/tmp/crippled % git clone /tmp/repo\r\nCloning into 'repo'...\r\ndone.\r\n/tmp/crippled % cd repo\r\n/tmp/crippled/repo (git)-[master] % git annex init\r\ninit  \r\n  Detected a filesystem without fifo support.\r\n\r\n  Disabling ssh connection caching.\r\n\r\n  Detected a crippled filesystem.\r\n(merging origin/git-annex into git-annex...)\r\n(recording state in git...)\r\n(scanning for unlocked files...)\r\n\r\n  Entering an adjusted branch where files are unlocked as this filesystem does not support locked files.\r\n\r\nSwitched to branch 'adjusted/master(unlocked)'\r\nok\r\n(recording state in git...)\r\n\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git submodule init\r\nSubmodule 'sub' (/tmp/repo/sub) registered for path 'sub'\r\n\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git status\r\nOn branch adjusted/master(unlocked)\r\nnothing to commit, working tree clean\r\n\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git -C sub annex init\r\ninit  \r\n  Detected a filesystem without fifo support.\r\n\r\n  Disabling ssh connection caching.\r\n\r\n  Detected a crippled filesystem.\r\n(scanning for unlocked files...)\r\nok\r\n```\r\n\r\nThe repo is reported clean, despite the submodule checkout not being identical with the recorded commit:\r\n\r\n```\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git status\r\nOn branch adjusted/master(unlocked)\r\nnothing to commit, working tree clean\r\n\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git submodule\r\n fdb2afee57643a978494530b136a8ced7f6d5f34 sub\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git -C sub log -n1 |cat\r\ncommit 3aac9c0887b2eb6e47f0da33e07656a70c32434e\r\nAuthor: Michael Hanke <michael.hanke@gmail.com>\r\nDate:   Mon Oct 21 09:37:04 2019 +0200\r\n\r\n    git-annex adjusted branch\r\n```\r\n\r\nInitially I thought this is a nice feature, and it detects that there is nothing different other than the adjustment. However, no modifications to the submodule are being detected:\r\n\r\n```\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % touch sub/this\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git status\r\nOn branch adjusted/master(unlocked)\r\nnothing to commit, working tree clean\r\n```\r\n\r\nBut modifications to the parent are being detected:\r\n\r\n```\r\n(datalad3-dev) mih@meiner /tmp/crippled/repo (git)-[adjusted/master(unlocked)] % touch up\r\n(datalad3-dev) mih@meiner /tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git status\r\nOn branch adjusted/master(unlocked)\r\nUntracked files:\r\n  (use \"git add <file>...\" to include in what will be committed)\r\n\r\n        up\r\n\r\nnothing added to commit but untracked files present (use \"git add\" to track)\r\n```\r\n\r\nIt seems as if Git doesn't realize that it is in a submodule, as it reports the parent change from inside the submodule, but still not the original modification\r\n\r\n```\r\n/tmp/crippled/repo (git)-[adjusted/master(unlocked)] % git -C sub status\r\nOn branch adjusted/master(unlocked)\r\nUntracked files:\r\n  (use \"git add <file>...\" to include in what will be committed)\r\n\r\n        ../up\r\n\r\nnothing added to commit but untracked files present (use \"git add\" to track)\r\n```\r\n\r\nWhen I apply the same modifications to the original repositories on the normal FS, everything behaves as expected:\r\n\r\n```\r\n/tmp/repo (git)-[master] % touch sub/this\r\n/tmp/repo (git)-[master] % touch up\r\n/tmp/repo (git)-[master] % git status\r\nOn branch master\r\nChanges not staged for commit:\r\n  (use \"git add <file>...\" to update what will be committed)\r\n  (use \"git checkout -- <file>...\" to discard changes in working directory)\r\n  (commit or discard the untracked or modified content in submodules)\r\n\r\n        modified:   sub (untracked content)\r\n\r\nUntracked files:\r\n  (use \"git add <file>...\" to include in what will be committed)\r\n\r\n        up\r\n\r\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\r\n/tmp/repo (git)-[master] % git -C sub status\r\nOn branch master\r\nUntracked files:\r\n  (use \"git add <file>...\" to include in what will be committed)\r\n\r\n        this\r\n\r\nnothing added to commit but untracked files present (use \"git add\" to track)\r\n```\r\n\r\n@joeyh Could you please have a look and share your thoughts on what is happening here?", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3820/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3820/timeline", "performed_via_github_app": null}