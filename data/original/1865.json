{"url": "https://api.github.com/repos/datalad/datalad/issues/1865", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/1865/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/1865/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/1865/events", "html_url": "https://github.com/datalad/datalad/issues/1865", "id": 261826626, "node_id": "MDU6SXNzdWUyNjE4MjY2MjY=", "number": 1865, "title": "Performance issue of save() with many files", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 289240596, "node_id": "MDU6TGFiZWwyODkyNDA1OTY=", "url": "https://api.github.com/repos/datalad/datalad/labels/performance", "name": "performance", "color": "f4b2d8", "default": false, "description": "Improve performance of an existing feature"}, {"id": 390153891, "node_id": "MDU6TGFiZWwzOTAxNTM4OTE=", "url": "https://api.github.com/repos/datalad/datalad/labels/UX", "name": "UX", "color": "0052cc", "default": false, "description": "user experience"}, {"id": 533730441, "node_id": "MDU6TGFiZWw1MzM3MzA0NDE=", "url": "https://api.github.com/repos/datalad/datalad/labels/:woman_facepalming:", "name": ":woman_facepalming:", "color": "ffffff", "default": false, "description": "facepalm"}], "state": "closed", "locked": false, "assignee": {"login": "bpoldrack", "id": 10498301, "node_id": "MDQ6VXNlcjEwNDk4MzAx", "avatar_url": "https://avatars.githubusercontent.com/u/10498301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bpoldrack", "html_url": "https://github.com/bpoldrack", "followers_url": "https://api.github.com/users/bpoldrack/followers", "following_url": "https://api.github.com/users/bpoldrack/following{/other_user}", "gists_url": "https://api.github.com/users/bpoldrack/gists{/gist_id}", "starred_url": "https://api.github.com/users/bpoldrack/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bpoldrack/subscriptions", "organizations_url": "https://api.github.com/users/bpoldrack/orgs", "repos_url": "https://api.github.com/users/bpoldrack/repos", "events_url": "https://api.github.com/users/bpoldrack/events{/privacy}", "received_events_url": "https://api.github.com/users/bpoldrack/received_events", "type": "User", "site_admin": false}, "assignees": [{"login": "bpoldrack", "id": 10498301, "node_id": "MDQ6VXNlcjEwNDk4MzAx", "avatar_url": "https://avatars.githubusercontent.com/u/10498301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bpoldrack", "html_url": "https://github.com/bpoldrack", "followers_url": "https://api.github.com/users/bpoldrack/followers", "following_url": "https://api.github.com/users/bpoldrack/following{/other_user}", "gists_url": "https://api.github.com/users/bpoldrack/gists{/gist_id}", "starred_url": "https://api.github.com/users/bpoldrack/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bpoldrack/subscriptions", "organizations_url": "https://api.github.com/users/bpoldrack/orgs", "repos_url": "https://api.github.com/users/bpoldrack/repos", "events_url": "https://api.github.com/users/bpoldrack/events{/privacy}", "received_events_url": "https://api.github.com/users/bpoldrack/received_events", "type": "User", "site_admin": false}], "milestone": null, "comments": 16, "created_at": "2017-09-30T07:49:13Z", "updated_at": "2018-11-05T16:05:17Z", "closed_at": "2017-10-08T00:08:52Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Haven't investigated it, but `datalad add` on a directory with 40k files is very snappy until the `save` stage (single dataset), where an insane waiting period is interrupting the process. CPU is going full tilt, so the machine is clearly pondering some ideas.\r\n\r\nI suspect that something in the \"sorting\" phase of `save` is implemented sub-optimally. We are still calling stuff twice in order to get stats for a progress bar (IIRC), and to be compatible with direct mode. \r\n\r\nUpdate: After 45min it finally crashed:\r\n\r\n```\r\n[ERROR  ] Failed to start ['git', '-c', 'receive.autogc=0', '-c', 'gc.auto=0', 'add', '--dry-run', '-N', '--ignore-missing', '--verbose', '--', <snip 40k files>\r\n[Errno 7] Argument list too long [subprocess.py:_execute_child:1024]\r\n[ERROR  ] add: [Errno 7] Argument list too long \r\n[ERROR  ] [Errno 7] Argument list too long [subprocess.py:_execute_child:1024] (OSError) \r\ndatalad add study_20140724_095117357  2680,36s user 29,57s system 99% cpu 45:24,90 total\r\n```\r\n\r\nThe add stage took less than a minute (I think), which is OK for 40k files with about 1GB total.\r\n\r\nAfter the crash evrything was nicely staged, and a simple `git commit` was sufficient to finish the process in:\r\n\r\n```\r\ngit commit -m save  4,21s user 1,24s system 69% cpu 7,836 total\r\n```\r\n\r\ndatalad had already staged all files within that initial minute, so `save` spend 40+ minutes only to blow up eventually.\r\n\r\nConclusion: Our approach to pass a long list of files to git is fundamentally broken in such scenario. I know that we have to do this, because we want to be able to work with any flavor of dirty repositories, but clearly we need workarounds to still be able to work with lots of files. And most importantly we should be aware that we are paying a substantial price for this flexibility -- at least with the current implementation.", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/1865/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/1865/timeline", "performed_via_github_app": null}