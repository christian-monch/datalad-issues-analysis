{"url": "https://api.github.com/repos/datalad/datalad/issues/2348", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2348/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2348/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2348/events", "html_url": "https://github.com/datalad/datalad/pull/2348", "id": 309066974, "node_id": "MDExOlB1bGxSZXF1ZXN0MTc3ODE0NTIw", "number": 2348, "title": "BF: Resolve interaction between batch commands and set_metadata", "user": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 0, "created_at": "2018-03-27T17:41:27Z", "updated_at": "2018-03-27T23:29:17Z", "closed_at": "2018-03-27T19:16:33Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/2348", "html_url": "https://github.com/datalad/datalad/pull/2348", "diff_url": "https://github.com/datalad/datalad/pull/2348.diff", "patch_url": "https://github.com/datalad/datalad/pull/2348.patch"}, "body": "If files are being added in an active batch process, set_metadata will\r\nsilently fail (return a generator that yields no values).  This is\r\nbecause the underlying git annex command has a zero-exit status but no\r\noutput.  As an example, this can be triggered by running\r\n\r\n    $ echo content >foo\r\n    $ ( echo \"foo\" && sleep 30 ) | git annex add --batch\r\n\r\nin one shell and then running 'git annex metadata --json --set f=v -- foo'\r\nin another before the first completes.\r\n\r\nThis issue was noticed when running the addurls plugin with the\r\n--nosave option, in which case no metadata gets registered for\r\nsubdatasets.\r\n\r\nWork around it by running precommit before setting metadata.  It's not\r\nclear whether there are similar issues elsewhere, and in general it\r\nmight be better make the cleanup of batch processes more local (e.g.,\r\na context manager), but this at least fixes the immediate issue.\r\n\r\nRe: http://git-annex.branchable.com/bugs/annex_metadata___40__not_--batch__39__ed__41___is_not_aware_of_files_added_via_addurls_--batch/\r\n\r\n---\r\n\r\n- [x] This change is complete\r\n\r\n", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2348/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2348/timeline", "performed_via_github_app": null}