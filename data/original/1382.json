{"url": "https://api.github.com/repos/datalad/datalad/issues/1382", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/1382/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/1382/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/1382/events", "html_url": "https://github.com/datalad/datalad/issues/1382", "id": 215054141, "node_id": "MDU6SXNzdWUyMTUwNTQxNDE=", "number": 1382, "title": "segfault crash troubleshooting with gdb notes", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-03-17T16:24:25Z", "updated_at": "2017-03-20T18:57:24Z", "closed_at": "2017-03-20T18:57:24Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "so -- troubleshooting #1350 segfault... things has changed from how they were but finally I got gdb to report the traceback and wanted to put notes out somewhere. They are adhoc, was done in neurodebian:nd90 buildbot docker\r\n\r\n- `apt-get install python-dbg`\r\n- get our repo\r\n- `virtualenv --python=python-dbg --system-site-packages venv-dbg`\r\n- `source venv-dbg/bin/activate`\r\n- `pip install -e '.[full]'` (also I installed wrapt from git but in general not needed)\r\n- `cp /usr/share/gdb/auto-load/usr/lib/x86_64-linux-gnu/libpython2.7.so.1.0-gdb.py  libpython.py`\r\n- run gdb with python with nose\r\n```\r\nPYTHONPATH=$PWD DATALAD_LOG_LEVEL=2 gdb --args  python   -c 'import nose; nose.main()' -s -v datalad/distribution/tests/test_install.py:test_install_crcns\r\n```\r\n- load this libpython thingie \r\n```python import libpython```\r\n- `r` and whenever crashes can use `py-bt`:\r\n\r\n```(gdb) py-bt\r\nTraceback (most recent call first):\r\n  Garbage-collecting\r\n  <built-in function collect>\r\n  File \"/home/buildbot/datalad-michael-broke-it/venv-dbg/local/lib/python2.7/site-packages/git/repo/base.py\", line 194, in close\r\n    gc.collect()\r\n  File \"/home/buildbot/datalad-michael-broke-it/venv-dbg/local/lib/python2.7/site-packages/git/repo/base.py\", line 189, in __del__\r\n    self.close()\r\n  File \"/home/buildbot/datalad-michael-broke-it/datalad/distribution/tests/test_install.py\", line 174, in test_install_crcns\r\n    ds2 = Dataset('all-nonrecursive').install('crcns')\r\n  File \"/home/buildbot/datalad-michael-broke-it/datalad/tests/utils.py\", line 564, in newfunc\r\n    return t(*(arg + (filename,)), **kw)\r\n  File \"/home/buildbot/datalad-michael-broke-it/datalad/tests/utils.py\", line 564, in newfunc\r\n    return t(*(arg + (filename,)), **kw)\r\n  File \"/home/buildbot/datalad-michael-broke-it/datalad/support/vcr_.py\", line 77, in wrapper\r\n    return t(*args, **kwargs)\r\n  File \"/home/buildbot/datalad-michael-broke-it/datalad/tests/utils.py\", line 775, in newfunc\r\n    return func(*args, **kwargs)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/case.py\", line 197, in runTest\r\n    self.test(*self.arg)\r\n  File \"/usr/lib/python2.7/unittest/case.py\", line 329, in run\r\n    testMethod()\r\n  File \"/usr/lib/python2.7/unittest/case.py\", line 393, in __call__\r\n    return self.run(*args, **kwds)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/case.py\", line 151, in runTest\r\n    test(result)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/case.py\", line 133, in run\r\n    self.runTest(result)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/case.py\", line 45, in __call__\r\n    return self.run(*arg, **kwarg)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/suite.py\", line 224, in run\r\n    test(orig)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/suite.py\", line 177, in __call__\r\n    return self.run(*arg, **kw)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/suite.py\", line 224, in run\r\n    test(orig)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/suite.py\", line 177, in __call__\r\n    return self.run(*arg, **kw)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/core.py\", line 62, in run\r\n    test(result)\r\n  File \"/usr/lib/python2.7/dist-packages/nose/core.py\", line 207, in runTests\r\n    result = self.testRunner.run(self.test)\r\n  File \"/usr/lib/python2.7/unittest/main.py\", line 95, in __init__\r\n    self.runTests()\r\n  File \"/usr/lib/python2.7/dist-packages/nose/core.py\", line 121, in __init__\r\n    **extra_args)\r\n  File \"<string>\", line 1, in <module>\r\n```\r\n\r\nand regular gdb traceback \"top\" is:\r\n```\r\n(gdb) bt 15\r\n#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:58\r\n#1  0x00007ffff6f2d40a in __GI_abort () at abort.c:89\r\n#2  0x00007ffff6f24e47 in __assert_fail_base (fmt=<optimized out>, assertion=assertion@entry=0x5555557fae87 \"gc->gc.gc_refs != 0\", file=file@entry=0x5555557fae40 \"../Modules/gcmodule.c\", line=line@entry=351, \r\n    function=function@entry=0x5555557fb2d8 <__PRETTY_FUNCTION__.9755> \"update_refs\") at assert.c:92\r\n#3  0x00007ffff6f24ef2 in __GI___assert_fail (assertion=0x5555557fae87 \"gc->gc.gc_refs != 0\", file=0x5555557fae40 \"../Modules/gcmodule.c\", line=351, function=0x5555557fb2d8 <__PRETTY_FUNCTION__.9755> \"update_refs\")\r\n    at assert.c:101\r\n#4  0x0000555555712c3b in update_refs (containers=0x555555a7cd20 <generations+96>) at ../Modules/gcmodule.c:351\r\n#5  0x0000555555713e48 in collect (generation=2) at ../Modules/gcmodule.c:924\r\n#6  0x000055555571432b in gc_collect (self=0x0, args=(), kws=0x0) at ../Modules/gcmodule.c:1121\r\n#7  0x00005555556187a8 in PyCFunction_Call (func=<built-in function collect>, arg=(), kw=0x0) at ../Objects/methodobject.c:85\r\n#8  0x00005555556c4fc2 in call_function (pp_stack=0x7fffffff4ea0, oparg=0) at ../Python/ceval.c:4352\r\n#9  0x00005555556bf5e1 in PyEval_EvalFrameEx (\r\n    f=Frame 0x7ffff3557ba0, for file /home/buildbot/datalad-michael-broke-it/venv-dbg/local/lib/python2.7/site-packages/git/repo/base.py, line 194, in close (self=<Repo(git=<Git at remote 0x7ffff3548cd8>, working_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive', _bare=False, git_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git', odb=<GitCmdObjectDB(_ostream=None, _hexsha_to_file={}, _fd_open_flags=262144, _root_path='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git/objects', _git=<...>) at remote 0x7ffff3a8bfb0>, _working_tree_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive') at remote 0x7ffff3a8bd10>), throwflag=0) at ../Python/ceval.c:2989\r\n#10 0x00005555556c54bc in fast_function (func=<function at remote 0x7ffff3b7d1b0>, pp_stack=0x7fffffff5310, n=1, na=1, nk=0) at ../Python/ceval.c:4437\r\n#11 0x00005555556c51b5 in call_function (pp_stack=0x7fffffff5310, oparg=0) at ../Python/ceval.c:4372\r\n#12 0x00005555556bf5e1 in PyEval_EvalFrameEx (\r\n    f=Frame 0x7ffff35579c0, for file /home/buildbot/datalad-michael-broke-it/venv-dbg/local/lib/python2.7/site-packages/git/repo/base.py, line 189, in __del__ (self=<Repo(git=<Git at remote 0x7ffff3548cd8>, working_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive', _bare=False, git_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git', odb=<GitCmdObjectDB(_ostream=None, _hexsha_to_file={}, _fd_open_flags=262144, _root_path='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git/objects', _git=<...>) at remote 0x7ffff3a8bfb0>, _working_tree_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive') at remote 0x7ffff3a8bd10>), throwflag=0) at ../Python/ceval.c:2989\r\n#13 0x00005555556c25ee in PyEval_EvalCodeEx (co=0x7ffff3ba8b40, \r\n    globals={'handle_process_output': <function at remote 0x7ffff42abe28>, 'Git': <type at remote 0x5555561bd4b0>, 'find_submodule_git_dir': <function at remote 0x7ffff3b774f8>, 'osp': <module at remote 0x7ffff7ee6060>, 'PY3': False, 'Actor': <type at remote 0x555556198dc0>, 'hex_to_bin': <built-in function a2b_hex>, 'decygpath': <function at remote 0x7ffff42fc990>, 'Submodule': <type at remote 0x5555561f09a0>, 'gc': <module at remote 0x7ffff5aa7f68>, 'Commit': <type at remote 0x5555561b5190>, 'touch': <function at remote 0x7ffff3b773a8>, 'BlameEntry': <type at remote 0x5555561fe130>, 'DefaultDBType': <type at remote 0x5555561a4030>, 'Head': <type at remote 0x5555561f4590>, 'log': <Logger(name='git.repo.base', parent=<Logger(name='git', parent=<RootLogger(name='root', parent=None, handlers=[<MyMemoryHandler(level=0, buffer=['datalad.utils: Level 5: Importing datalad.utils', 'datalad.utils: Level 5: Done importing datalad.utils', \"datalad.cmd: DEBUG: Will use git under '/usr/lib/git-annex.linux' (no adjustments to PATH if...(truncated), locals=0x0, args=0x7ffff3614be8, argcount=1, kws=0x0, kwcount=0, defs=0x0, \r\n    defcount=0, closure=0x0) at ../Python/ceval.c:3584\r\n#14 0x00005555555f465f in function_call (func=<function at remote 0x7ffff3b7d108>, \r\n    arg=(<Repo(git=<Git at remote 0x7ffff3548cd8>, working_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive', _bare=False, git_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git', odb=<GitCmdObjectDB(_ostream=None, _hexsha_to_file={}, _fd_open_flags=262144, _root_path='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git/objects', _git=<...>) at remote 0x7ffff3a8bfb0>, _working_tree_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive') at remote 0x7ffff3a8bd10>,), kw=0x0) at ../Objects/funcobject.c:523\r\n...\r\n#29 0x000055555561f0bb in _Py_Dealloc (\r\n    op=<Dataset(_cfg=None, _repo=<GitRepo(realpath=<unknown at remote 0x7ffff354d9d0>, _GIT_COMMON_OPTIONS=['-c', 'receive.autogc=0', '-c', 'gc.auto=0'], cmd_call_wrapper=<unknown at remote 0x7ffff3580ec0>, repo=<Repo(git=<Git at remote 0x7ffff3548cd8>, working_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive', _bare=False, git_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git', odb=<GitCmdObjectDB(_ostream=None, _hexsha_to_file={}, _fd_open_flags=262144, _root_path='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive/.git/objects', _git=<...>) at remote 0x7ffff3a8bfb0>, _working_tree_dir='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive') at remote 0x7ffff3a8bd10>, _cfg=None, path='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive') at remote 0x7ffff373c370>, _id=None, _path='/tmp/datalad_temp_test_install_crcnsrR0VqX/all-nonrecursive') at remote 0x7ffff4b8e8b0>) at ../Objects/object.c:2262\r\n#30 0x00007ffff4e323e4 in WraptFunctionWrapperBase_clear (self=0x7ffff3578ba0) at src/wrapt/_wrappers.c:1898\r\n#31 0x00007ffff4e32657 in WraptFunctionWrapperBase_dealloc (self=0x7ffff3578ba0) at src/wrapt/_wrappers.c:1911\r\n#32 0x000055555561f0bb in _Py_Dealloc (op=<BoundFunctionWrapper at remote 0x7ffff3578ba0>) at ../Objects/object.c:2262\r\n#33 0x00005555556c52fd in call_function (pp_stack=0x7fffffff6030, oparg=1) at ../Python/ceval.c:4385\r\n...\r\n```\r\n\r\nso at `#9` you can see the close call.  \r\n\r\n`valgrind --leak-check=full --track-origins=yes` output around that point of crash is:\r\n\r\n```\r\n[DEBUG] Running: ['git', 'config', '-z', '-l']\r\n| cwd: /tmp/datalad_temp_test_install_crcnswAlX64\r\n[Level 8] Finished running ['git', 'config', '-z', '-l'] with status 0\r\n==12629== Invalid write of size 8\r\n==12629==    at 0x1E5A33: gc_list_remove (gcmodule.c:251)\r\n==12629==    by 0x1E5A33: PyObject_GC_Del (gcmodule.c:1557)\r\n==12629==    by 0x240DB8: PyTuple_ClearFreeList (tupleobject.c:905)\r\n==12629==    by 0x1E6377: clear_freelists (gcmodule.c:843)\r\n==12629==    by 0x1E6377: collect.lto_priv.1950 (gcmodule.c:1020)\r\n==12629==    by 0x2A37E8: gc_collect.lto_priv.2658 (gcmodule.c:1121)\r\n==12629==    by 0x2033C9: call_function (ceval.c:4352)\r\n==12629==    by 0x2033C9: PyEval_EvalFrameEx (ceval.c:2989)\r\n==12629==    by 0x208C1E: fast_function (ceval.c:4437)\r\n==12629==    by 0x208C1E: call_function (ceval.c:4372)\r\n==12629==    by 0x208C1E: PyEval_EvalFrameEx (ceval.c:2989)\r\n==12629==    by 0x201534: PyEval_EvalCodeEx (ceval.c:3584)\r\n==12629==    by 0x21DCED: function_call.lto_priv.296 (funcobject.c:523)\r\n==12629==    by 0x1EF672: PyObject_Call (abstract.c:2547)\r\n==12629==    by 0x233FED: instancemethod_call.lto_priv.215 (classobject.c:2602)\r\n==12629==    by 0x1EF672: PyObject_Call (abstract.c:2547)\r\n==12629==    by 0x20D47C: PyEval_CallObjectWithKeywords (ceval.c:4221)\r\n==12629==  Address 0x8 is not stack'd, malloc'd or (recently) free'd\r\n==12629==\r\n==12629==\r\n==12629== Process terminating with default action of signal 11 (SIGSEGV): dumping core\r\n==12629==  Access not within mapped region at address 0x8\r\n==12629==    at 0x1E5A33: gc_list_remove (gcmodule.c:251)\r\n==12629==    by 0x1E5A33: PyObject_GC_Del (gcmodule.c:1557)\r\n==12629==    by 0x240DB8: PyTuple_ClearFreeList (tupleobject.c:905)\r\n==12629==    by 0x1E6377: clear_freelists (gcmodule.c:843)\r\n==12629==    by 0x1E6377: collect.lto_priv.1950 (gcmodule.c:1020)\r\n==12629==    by 0x2A37E8: gc_collect.lto_priv.2658 (gcmodule.c:1121)\r\n==12629==    by 0x2033C9: call_function (ceval.c:4352)\r\n==12629==    by 0x2033C9: PyEval_EvalFrameEx (ceval.c:2989)\r\n==12629==    by 0x208C1E: fast_function (ceval.c:4437)\r\n==12629==    by 0x208C1E: call_function (ceval.c:4372)\r\n==12629==    by 0x208C1E: PyEval_EvalFrameEx (ceval.c:2989)\r\n==12629==    by 0x201534: PyEval_EvalCodeEx (ceval.c:3584)\r\n==12629==    by 0x21DCED: function_call.lto_priv.296 (funcobject.c:523)\r\n==12629==    by 0x1EF672: PyObject_Call (abstract.c:2547)\r\n==12629==    by 0x233FED: instancemethod_call.lto_priv.215 (classobject.c:2602)\r\n==12629==    by 0x1EF672: PyObject_Call (abstract.c:2547)\r\n==12629==    by 0x20D47C: PyEval_CallObjectWithKeywords (ceval.c:4221)\r\n==12629==  If you believe this happened as a result of a stack\r\n==12629==  overflow in your program's main thread (unlikely but\r\n==12629==  possible), you can try to increase the size of the\r\n==12629==  main thread stack using the --main-stacksize= flag.\r\n==12629==  The main thread stack size used in this run was 8388608.\r\n==12629==\r\n==12629== HEAP SUMMARY:\r\n==12629==     in use at exit: 14,248,744 bytes in 14,105 blocks\r\n==12629==   total heap usage: 248,027 allocs, 233,922 frees, 218,197,419 bytes allocated\r\n...\r\n```\r\nfull log: http://www.onerussian.com/tmp/valgrind-track-origins.log\r\n\r\nchecking with wrapt:  https://github.com/GrahamDumpleton/wrapt/issues/98", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/1382/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/1382/timeline", "performed_via_github_app": null}