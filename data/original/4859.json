{"url": "https://api.github.com/repos/datalad/datalad/issues/4859", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4859/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4859/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4859/events", "html_url": "https://github.com/datalad/datalad/issues/4859", "id": 690842889, "node_id": "MDU6SXNzdWU2OTA4NDI4ODk=", "number": 4859, "title": "Substantial overhead of `get` vs direct clone of a subdataset", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 289240596, "node_id": "MDU6TGFiZWwyODkyNDA1OTY=", "url": "https://api.github.com/repos/datalad/datalad/labels/performance", "name": "performance", "color": "f4b2d8", "default": false, "description": "Improve performance of an existing feature"}, {"id": 2767256516, "node_id": "MDU6TGFiZWwyNzY3MjU2NTE2", "url": "https://api.github.com/repos/datalad/datalad/labels/cmd-get", "name": "cmd-get", "color": "FEF2C0", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2020-09-02T08:53:53Z", "updated_at": "2021-07-22T19:04:29Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "Context is the UKB dataset with 42k subdatasets.\r\n\r\nCloning a particular subject dataset takes less than a second (baseline):\r\n\r\n```\r\ndatalad clone http://ukb.ds.inm7.de/...   0.47s user 0.19s system 76% cpu 0.855 total\r\n```\r\n\r\nObtaining the same dataset as a subdataset via the UKB superdataset (no subdatasets installed yet) takes more than 7x longer:\r\n\r\n```\r\ndatalad get -n -d . sub-...  5.76s user 1.11s system 98% cpu 6.985 total\r\n```\r\n\r\nClone source and target are identical, the difference in runtime is reliable.\r\n\r\nHere is the ugly truth (timestamps of a DEBUG log decomposing some of the 7s):\r\n\r\n<details>\r\n<summary>startup and read gitmodules ~700ms</summary>\r\n\r\n```\r\n2020-09-02 11:25:42,201 [DEBUG] Command line args 1st pass. Parsed: Namespace() Unparsed: ['get', '-n', '-d', '.', 'sub-3507513/']                                                          \r\n2020-09-02 11:25:42,201 [DEBUG] Discovering plugins\r\n2020-09-02 11:25:42,204 [DEBUG] Building doc for <class 'datalad.local.subdatasets.Subdatasets'>                                                                                            \r\n2020-09-02 11:25:42,266 [DEBUG] Building doc for <class 'datalad.core.distributed.clone.Clone'>                                                                                             \r\n2020-09-02 11:25:42,268 [DEBUG] Building doc for <class 'datalad.distribution.get.Get'>\r\n2020-09-02 11:25:42,272 [DEBUG] Parsing known args among ['/home/mih/venvs/datalad/bin/datalad', '-l', 'debug', 'get', '-n', '-d', '.', 'sub-3507513/']                                     \r\n2020-09-02 11:25:42,277 [DEBUG] Determined class of decorated function: <class 'datalad.distribution.get.Get'>                                                                              \r\n2020-09-02 11:25:42,292 [DEBUG] Resolved dataset for get content: /tmp/bidsclone\r\n2020-09-02 11:25:42,293 [DEBUG] Determined class of decorated function: <class 'datalad.local.subdatasets.Subdatasets'>                                                                     \r\n2020-09-02 11:25:42,293 [DEBUG] Resolved dataset for subdataset reporting/modification: /tmp/bidsclone                                                                                      \r\n2020-09-02 11:25:42,293 [DEBUG] Query subdatasets of .\r\n2020-09-02 11:25:42,293 [DEBUG] Resolved dataset for path resolution: /tmp/bidsclone\r\n2020-09-02 11:25:42,294 [DEBUG] Async run ['git', 'config', '-z', '-l', '--file', '.gitmodules']                                                                                            \r\n2020-09-02 11:25:42,294 [DEBUG] Launching process ['git', 'config', '-z', '-l', '--file', '.gitmodules']                                                                                    \r\n2020-09-02 11:25:42,297 [DEBUG] Process 248518 started\r\n2020-09-02 11:25:42,297 [DEBUG] Waiting for process 248518 to complete\r\n2020-09-02 11:25:42,361 [DEBUG] Process 248518 exited with return code 0\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>500ms of superdataset content_info</summary>\r\n\r\n```\r\n2020-09-02 11:25:42,917 [DEBUG] AnnexRepo(/tmp/bidsclone).get_content_info(...)\r\n2020-09-02 11:25:42,918 [DEBUG] Query repo: ['ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                                 \r\n2020-09-02 11:25:42,918 [DEBUG] Async run ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                            \r\n2020-09-02 11:25:42,918 [DEBUG] Launching process ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                    \r\n2020-09-02 11:25:42,924 [DEBUG] Process 248519 started\r\n2020-09-02 11:25:42,924 [DEBUG] Waiting for process 248519 to complete\r\n2020-09-02 11:25:43,014 [DEBUG] Process 248519 exited with return code 0\r\n2020-09-02 11:25:43,016 [DEBUG] Done query repo: ['ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                            \r\n2020-09-02 11:25:43,391 [DEBUG] Done AnnexRepo(/tmp/bidsclone).get_content_info(...)\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>Another 700ms of reading the gitmodules again</summary>\r\n\r\n```\r\n2020-09-02 11:25:43,995 [DEBUG] Determined class of decorated function: <class 'datalad.local.subdatasets.Subdatasets'>                                                                     \r\n2020-09-02 11:25:43,995 [DEBUG] Resolved dataset for subdataset reporting/modification: /tmp/bidsclone                                                                                      \r\n2020-09-02 11:25:43,995 [DEBUG] Query subdatasets of Dataset(/tmp/bidsclone)\r\n2020-09-02 11:25:43,996 [DEBUG] Async run ['git', 'config', '-z', '-l', '--file', '.gitmodules']                                                                                            \r\n2020-09-02 11:25:43,996 [DEBUG] Launching process ['git', 'config', '-z', '-l', '--file', '.gitmodules']                                                                                    \r\n2020-09-02 11:25:44,001 [DEBUG] Process 248532 started\r\n2020-09-02 11:25:44,002 [DEBUG] Waiting for process 248532 to complete\r\n2020-09-02 11:25:44,073 [DEBUG] Process 248532 exited with return code 0\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>Another 500ms of reading content_info again</summary>\r\n\r\n```\r\n2020-09-02 11:25:44,731 [DEBUG] AnnexRepo(/tmp/bidsclone).get_content_info(...)\r\n2020-09-02 11:25:44,731 [DEBUG] Query repo: ['ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                                 \r\n2020-09-02 11:25:44,731 [DEBUG] Async run ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                            \r\n2020-09-02 11:25:44,731 [DEBUG] Launching process ['git', 'ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                    \r\n2020-09-02 11:25:44,739 [DEBUG] Process 248550 started\r\n2020-09-02 11:25:44,740 [DEBUG] Waiting for process 248550 to complete\r\n2020-09-02 11:25:44,831 [DEBUG] Process 248550 exited with return code 0\r\n2020-09-02 11:25:44,833 [DEBUG] Done query repo: ['ls-files', '--stage', '-z', '-d', '-m', '--exclude-standard']                                                                            \r\n2020-09-02 11:25:45,249 [DEBUG] Done AnnexRepo(/tmp/bidsclone).get_content_info(...)\r\n```\r\n\r\n</details>\r\n<details>\r\n<summary>and finally 1700ms for cloning the dataset and setting it up (of which 900ms are the baseline for a standlone clone)</summary>\r\n\r\n```\r\n2020-09-02 11:25:46,464 [DEBUG] Async run ['git', 'symbolic-ref', 'HEAD'] \r\n2020-09-02 11:25:46,464 [DEBUG] Launching process ['git', 'symbolic-ref', 'HEAD'] \r\n2020-09-02 11:25:46,470 [DEBUG] Process 248772 started \r\n2020-09-02 11:25:46,471 [DEBUG] Waiting for process 248772 to complete \r\n2020-09-02 11:25:46,472 [DEBUG] Process 248772 exited with return code 0 \r\n2020-09-02 11:25:46,472 [DEBUG] Process file list chunk 0 (length 1) \r\n2020-09-02 11:25:46,473 [DEBUG] Async run ['git', 'rev-list', '-n1', 'HEAD', '--', 'sub-3507513'] \r\n2020-09-02 11:25:46,473 [DEBUG] Launching process ['git', 'rev-list', '-n1', 'HEAD', '--', 'sub-3507513'] \r\n2020-09-02 11:25:46,478 [DEBUG] Process 248773 started \r\n2020-09-02 11:25:46,478 [DEBUG] Waiting for process 248773 to complete \r\n2020-09-02 11:25:46,534 [DEBUG] Process 248773 exited with return code 0 \r\n2020-09-02 11:25:46,535 [DEBUG] Async run ['git', 'for-each-ref', '--format=%(refname:strip=2)', '--contains=d9f1981f7f5ffee8c3ee689964c9f0e251442e22', 'refs/remotes'] \r\n2020-09-02 11:25:46,535 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', '--contains=d9f1981f7f5ffee8c3ee689964c9f0e251442e22', 'refs/remotes'] \r\n2020-09-02 11:25:46,542 [DEBUG] Process 248774 started \r\n2020-09-02 11:25:46,542 [DEBUG] Waiting for process 248774 to complete \r\n2020-09-02 11:25:46,544 [DEBUG] Process 248774 exited with return code 0 \r\n2020-09-02 11:25:46,547 [INFO] Cloning dataset to Dataset(/tmp/bidsclone/sub-3507513) \r\n2020-09-02 11:25:46,547 [INFO] Attempting to clone from http://ukb.ds.inm7.de/c9f/9c2e8-d362-11ea-8da0-ac1f6bbc444e to /tmp/bidsclone/sub-3507513 \r\n2020-09-02 11:25:46,547 [DEBUG] Git clone from http://ukb.ds.inm7.de/c9f/9c2e8-d362-11ea-8da0-ac1f6bbc444e to /tmp/bidsclone/sub-3507513 \r\n2020-09-02 11:25:46,548 [DEBUG] Async run ['git', 'clone', '--progress', 'http://ukb.ds.inm7.de/c9f/9c2e8-d362-11ea-8da0-ac1f6bbc444e', '/tmp/bidsclone/sub-3507513'] \r\n2020-09-02 11:25:46,548 [DEBUG] Launching process ['git', 'clone', '--progress', 'http://ukb.ds.inm7.de/c9f/9c2e8-d362-11ea-8da0-ac1f6bbc444e', '/tmp/bidsclone/sub-3507513'] \r\n2020-09-02 11:25:46,554 [DEBUG] Process 248775 started \r\n2020-09-02 11:25:46,555 [DEBUG] Waiting for process 248775 to complete \r\n2020-09-02 11:25:46,555 [DEBUG] Non-progress stderr: b\"Cloning into '/tmp/bidsclone/sub-3507513'...\\n\" \r\n2020-09-02 11:25:46,638 [INFO] Start enumerating objects \r\n2020-09-02 11:25:46,638 [INFO] Finished enumerating objects \r\n2020-09-02 11:25:46,638 [INFO] Start counting objects \r\n2020-09-02 11:25:46,646 [INFO] Finished counting objects \r\n2020-09-02 11:25:46,646 [INFO] Start compressing objects \r\n2020-09-02 11:25:46,650 [INFO] Finished compressing objects \r\n2020-09-02 11:25:46,650 [DEBUG] Non-progress stderr: b'remote: Total 343 (delta 48), reused 343 (delta 48)        \\n' \r\n2020-09-02 11:25:46,650 [INFO] Start receiving objects \r\n2020-09-02 11:25:46,653 [INFO] Finished receiving objects \r\n2020-09-02 11:25:46,653 [INFO] Start resolving deltas \r\n2020-09-02 11:25:46,655 [INFO] Finished resolving deltas \r\n2020-09-02 11:25:46,658 [DEBUG] Process 248775 exited with return code 0 \r\n2020-09-02 11:25:46,658 [DEBUG] Git clone completed \r\n2020-09-02 11:25:46,659 [INFO] Completed clone attempts for Dataset(/tmp/bidsclone/sub-3507513) \r\n2020-09-02 11:25:46,659 [DEBUG] Async run ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,659 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,664 [DEBUG] Process 248785 started \r\n2020-09-02 11:25:46,664 [DEBUG] Waiting for process 248785 to complete \r\n2020-09-02 11:25:46,665 [DEBUG] Process 248785 exited with return code 0 \r\n2020-09-02 11:25:46,666 [DEBUG] Async run ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,666 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,673 [DEBUG] Process 248786 started \r\n2020-09-02 11:25:46,673 [DEBUG] Waiting for process 248786 to complete \r\n2020-09-02 11:25:46,674 [DEBUG] Process 248786 exited with return code 0 \r\n2020-09-02 11:25:46,719 [DEBUG] Async run ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,719 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,725 [DEBUG] Process 248793 started \r\n2020-09-02 11:25:46,725 [DEBUG] Waiting for process 248793 to complete \r\n2020-09-02 11:25:46,725 [DEBUG] Process 248793 exited with return code 0 \r\n2020-09-02 11:25:46,726 [DEBUG] Async run ['git', 'rev-parse', '--verify', 'HEAD^{commit}'] \r\n2020-09-02 11:25:46,726 [DEBUG] Launching process ['git', 'rev-parse', '--verify', 'HEAD^{commit}'] \r\n2020-09-02 11:25:46,732 [DEBUG] Process 248794 started \r\n2020-09-02 11:25:46,732 [DEBUG] Waiting for process 248794 to complete \r\n2020-09-02 11:25:46,733 [DEBUG] Process 248794 exited with return code 0 \r\n2020-09-02 11:25:46,734 [DEBUG] Async run ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,734 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,741 [DEBUG] Process 248795 started \r\n2020-09-02 11:25:46,741 [DEBUG] Waiting for process 248795 to complete \r\n2020-09-02 11:25:46,742 [DEBUG] Process 248795 exited with return code 0 \r\n2020-09-02 11:25:46,742 [DEBUG] Initializing annex repo at /tmp/bidsclone/sub-3507513 \r\n2020-09-02 11:25:46,743 [DEBUG] Async run ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,743 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads', 'refs/remotes'] \r\n2020-09-02 11:25:46,749 [DEBUG] Process 248796 started \r\n2020-09-02 11:25:46,749 [DEBUG] Waiting for process 248796 to complete \r\n2020-09-02 11:25:46,750 [DEBUG] Process 248796 exited with return code 0 \r\n2020-09-02 11:25:46,751 [DEBUG] Async run ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads'] \r\n2020-09-02 11:25:46,751 [DEBUG] Launching process ['git', 'for-each-ref', '--format=%(refname:strip=2)', 'refs/heads'] \r\n2020-09-02 11:25:46,757 [DEBUG] Process 248797 started \r\n2020-09-02 11:25:46,757 [DEBUG] Waiting for process 248797 to complete \r\n2020-09-02 11:25:46,758 [DEBUG] Process 248797 exited with return code 0 \r\n2020-09-02 11:25:46,782 [DEBUG] Async run ['git-annex', 'init', '-c', 'annex.dotfiles=true', '-c', 'annex.retry=3'] \r\n2020-09-02 11:25:46,782 [DEBUG] Launching process ['git-annex', 'init', '-c', 'annex.dotfiles=true', '-c', 'annex.retry=3'] \r\n2020-09-02 11:25:46,789 [DEBUG] Process 248805 started \r\n2020-09-02 11:25:46,790 [DEBUG] Waiting for process 248805 to complete \r\n2020-09-02 11:25:46,848 [INFO] Scanning for unlocked files (this may take some time) \r\n2020-09-02 11:25:47,406 [DEBUG] Process 248805 exited with return code 0 \r\n2020-09-02 11:25:47,422 [DEBUG] Async run ['git', 'cat-file', 'blob', 'git-annex:remote.log'] \r\n2020-09-02 11:25:47,423 [DEBUG] Launching process ['git', 'cat-file', 'blob', 'git-annex:remote.log'] \r\n2020-09-02 11:25:47,428 [DEBUG] Process 248943 started \r\n2020-09-02 11:25:47,429 [DEBUG] Waiting for process 248943 to complete \r\n2020-09-02 11:25:47,430 [DEBUG] Process 248943 exited with return code 0 \r\n2020-09-02 11:25:47,486 [DEBUG] Discovering plugins \r\n2020-09-02 11:25:47,489 [DEBUG] Building doc for <class 'datalad.distribution.update.Update'> \r\n2020-09-02 11:25:47,494 [DEBUG] Building doc for <class 'datalad.distribution.siblings.Siblings'> \r\n2020-09-02 11:25:47,498 [DEBUG] Found matching interface ('datalad.distribution.siblings', 'Siblings', 'siblings') for siblings \r\n2020-09-02 11:25:47,498 [DEBUG] Determined class of decorated function: <class 'datalad.distribution.siblings.Siblings'> \r\n2020-09-02 11:25:47,498 [DEBUG] Resolved dataset for sibling configuration: /tmp/bidsclone/sub-3507513 \r\n2020-09-02 11:25:47,979 [DEBUG] Async run ['git', 'cat-file', 'blob', 'git-annex:remote.log'] \r\n2020-09-02 11:25:47,980 [DEBUG] Launching process ['git', 'cat-file', 'blob', 'git-annex:remote.log'] \r\n2020-09-02 11:25:47,986 [DEBUG] Process 249070 started \r\n2020-09-02 11:25:47,986 [DEBUG] Waiting for process 249070 to complete \r\n2020-09-02 11:25:47,987 [DEBUG] Process 249070 exited with return code 0 \r\n2020-09-02 11:25:47,988 [DEBUG] Update cloned subdataset /tmp/bidsclone/sub-3507513 in parent \r\n2020-09-02 11:25:48,002 [DEBUG] Async run ['git', 'reset', '--hard', 'f60818e04b1ea9dc3a7eca8923367033d71ae4a4'] \r\n2020-09-02 11:25:48,002 [DEBUG] Launching process ['git', 'reset', '--hard', 'f60818e04b1ea9dc3a7eca8923367033d71ae4a4'] \r\n2020-09-02 11:25:48,008 [DEBUG] Process 249073 started \r\n2020-09-02 11:25:48,008 [DEBUG] Waiting for process 249073 to complete \r\n2020-09-02 11:25:48,108 [DEBUG] Process 249073 exited with return code 0 \r\n2020-09-02 11:25:48,134 [DEBUG] Installed subdataset in order to get /tmp/bidsclone/sub-3507513 [install(/tmp/bidsclone/sub-3507513)] \r\n2020-09-02 11:25:48,135 [DEBUG] Discovering plugins \r\n2020-09-02 11:25:48,135 [DEBUG] Found no match among known interfaces for 'dot_git' \r\n2020-09-02 11:25:48,172 [DEBUG] Determined class of decorated function: <class 'datalad.local.subdatasets.Subdatasets'> \r\n2020-09-02 11:25:48,173 [DEBUG] Resolved dataset for subdataset reporting/modification: /tmp/bidsclone/sub-3507513 \r\n2020-09-02 11:25:48,173 [DEBUG] Query subdatasets of Dataset(/tmp/bidsclone/sub-3507513) \r\n```\r\n\r\n</details>\r\n\r\nA major chunk of time (~30%) is spent on figuring out the relevant subdataset to get:\r\n\r\n```\r\ndatalad subdatasets -d . -r --contains sub-3507513  2.33s user 0.23s system 102% cpu 2.496 total\r\n```\r\n\r\n`subdatasets` rejects about 14ds/msec as not matching the target path. Sounds fast, but with 42k datasets it leads to this runtime.", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4859/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4859/timeline", "performed_via_github_app": null}