{"url": "https://api.github.com/repos/datalad/datalad/issues/4454", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4454/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4454/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4454/events", "html_url": "https://github.com/datalad/datalad/pull/4454", "id": 608677690, "node_id": "MDExOlB1bGxSZXF1ZXN0NDEwNDExMjc5", "number": 4454, "title": "WiP: dirty draft for alternative paths reporting by default renderer", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 526935563, "node_id": "MDU6TGFiZWw1MjY5MzU1NjM=", "url": "https://api.github.com/repos/datalad/datalad/labels/feedback-desired", "name": "feedback-desired", "color": "fbca04", "default": false, "description": ""}, {"id": 1453907298, "node_id": "MDU6TGFiZWwxNDUzOTA3Mjk4", "url": "https://api.github.com/repos/datalad/datalad/labels/stale-PR-closed-without-merge", "name": "stale-PR-closed-without-merge", "color": "ffffff", "default": false, "description": ""}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/84", "html_url": "https://github.com/datalad/datalad/milestone/84", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/84/labels", "id": 6275407, "node_id": "MDk6TWlsZXN0b25lNjI3NTQwNw==", "number": 84, "title": "0.14.x", "description": "", "creator": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "open_issues": 7, "closed_issues": 4, "state": "open", "created_at": "2021-01-05T14:42:35Z", "updated_at": "2021-09-13T13:27:50Z", "due_on": null, "closed_at": null}, "comments": 16, "created_at": "2020-04-28T23:26:10Z", "updated_at": "2021-01-09T09:39:45Z", "closed_at": "2021-01-09T09:39:32Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/4454", "html_url": "https://github.com/datalad/datalad/pull/4454", "diff_url": "https://github.com/datalad/datalad/pull/4454.diff", "patch_url": "https://github.com/datalad/datalad/pull/4454.patch"}, "body": "**Warnings**: Don't look at the diff, this is more of a \"tech preview\", tests guaranteed to fail, diff has unrelated changes etc. Authors of the handbook and/or documentation which hardcoded outputs most likely would start hating me.\r\n\r\nPrior attempt was gh-2679 but didn't proceed on that one since then the main problem I was fighting was full paths, and then paths relative to `refds` came to resolve that aspect. I kept running into situations where \"relative to refds\" made little sense, if not to say that it was misleading since `subds` could differ -- see gh-3442 .  The reason is that although the behavior of \"always to refds\" is easy to describe, since the actual `refds` is not shown, user is likely to be provided with paths he cannot just cut/paste in majority of the cases IMHO, and would not even know that they are not really such.\r\n\r\nSo, with this PR output paths would be either relative\r\n- to the CWD\r\n- to the specified dataset, and thus prefixed with an explicit `-d/` prefix (could be anything, but would be nice to have some explicit indication) to signal that.\r\n\r\nBehavior: The second case is excercised only if that dataset is outside of the CWD.\r\n\r\nAppearance: we could use some other demarkation between the two, e.g. make all relative paths start with `os.curdir` and relative to the dataset not have any `os.curdir` prefix.\r\n\r\n<details>\r\n<summary>Here is a demo script which exercises a number of scenarios invoking basic commands with or without `-d` and possibly from within a subdirectory of a dataset</summary> \r\n\r\n```bash\r\n#!/bin/bash\r\n\r\nexport PS4=\"> \"\r\nset -eu\r\ncd \"$(mktemp -d ${TMPDIR:-/tmp}/dl-XXXXXXX)\"\r\n\r\nwhich datalad\r\ndatalad --version\r\n\r\nset -x\r\ndatalad create src\r\ndatalad create -d src src/subds\r\ndatalad create -d src src/subds/subsubds\r\n\r\n(\r\ncd src/subds\r\ntouch file\r\ntouch subsubds/file\r\n\r\nmkdir d1 d2\r\ntouch d1/f1 d2/f2\r\ncd d1\r\ndatalad save -d^  -r \r\n#file subsubds/file\r\n)\r\n\r\n# now we will try from some very outside directory which has nothing in\r\n# common with the dataset path\r\nmkdir outside\r\n\r\n# introduce some changes to the dataset somewhere deep\r\nrm src/subds/d2/f2\r\ntouch src/newfile\r\n\r\n(\r\ncd outside\r\ndatalad save -r -d ../src\r\n)\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Full output on master</summary> \r\n\r\n```shell\r\n/home/yoh/proj/datalad/datalad-master/venvs/dev3/bin/datalad\r\ndatalad 0.12.6.dev611\r\n> datalad create src\r\n[INFO   ] Creating a new annex repo at /home/yoh/.tmp/dl-zHdjBPX/src \r\ncreate(ok): /home/yoh/.tmp/dl-zHdjBPX/src (dataset)\r\n> datalad create -d src src/subds\r\n[INFO   ] Creating a new annex repo at /home/yoh/.tmp/dl-zHdjBPX/src/subds \r\nadd(ok): subds (file)\r\nadd(ok): .gitmodules (file)\r\nsave(ok): . (dataset)\r\ncreate(ok): subds (dataset)\r\naction summary:\r\n  add (ok: 2)\r\n  create (ok: 1)\r\n  save (ok: 1)\r\n> datalad create -d src src/subds/subsubds\r\n[INFO   ] Creating a new annex repo at /home/yoh/.tmp/dl-zHdjBPX/src/subds/subsubds \r\nadd(ok): subsubds (file)\r\nadd(ok): .gitmodules (file)\r\nsave(ok): subds (dataset)\r\nadd(ok): subds (file)\r\nsave(ok): . (dataset)\r\ncreate(ok): subds/subsubds (dataset)\r\naction summary:\r\n  add (ok: 3)\r\n  create (ok: 1)\r\n  save (ok: 2)\r\n> cd src/subds\r\n> touch file\r\n> touch subsubds/file\r\n> mkdir d1 d2\r\n> touch d1/f1 d2/f2\r\n> cd d1\r\n> datalad save '-d^' -r\r\nadd(ok): file (file)\r\nsave(ok): subds/subsubds (dataset)\r\nadd(ok): subsubds (file)\r\nadd(ok): d1/f1 (file)                                                                                            \r\nadd(ok): d2/f2 (file)\r\nadd(ok): file (file)\r\nsave(ok): subds (dataset)\r\nadd(ok): subds (file)\r\nsave(ok): . (dataset)\r\naction summary:\r\n  add (ok: 6)\r\n  save (ok: 3)\r\n> mkdir outside\r\n> rm src/subds/d2/f2\r\n> touch src/newfile\r\n> cd outside\r\n> datalad save -r -d ../src\r\ndelete(ok): d2/f2 (file)\r\nsave(ok): subds (dataset)\r\nadd(ok): subds (file)\r\nadd(ok): newfile (file)                                                                                          \r\nsave(ok): . (dataset)\r\naction summary:\r\n  add (ok: 2)\r\n  delete (ok: 1)\r\n  save (notneeded: 1, ok: 2)\r\nbash ../trash/demo-paths.sh  6.36s user 2.32s system 103% cpu 8.372 total\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Full output on this PR</summary> \r\n\r\n```shell\r\n/home/yoh/proj/datalad/datalad-master/venvs/dev3/bin/datalad\r\ndatalad 0.12.6.dev612\r\n> datalad create src\r\n[INFO   ] Creating a new annex repo at /home/yoh/.tmp/dl-Gok1gmK/src \r\ncreate(ok): src (dataset)\r\n> datalad create -d src src/subds\r\n[INFO   ] Creating a new annex repo at /home/yoh/.tmp/dl-Gok1gmK/src/subds \r\nadd(ok): src/subds (file)\r\nadd(ok): src/.gitmodules (file)\r\nsave(ok): src (dataset)\r\ncreate(ok): src/subds (dataset)\r\naction summary:\r\n  add (ok: 2)\r\n  create (ok: 1)\r\n  save (ok: 1)\r\n> datalad create -d src src/subds/subsubds\r\n[INFO   ] Creating a new annex repo at /home/yoh/.tmp/dl-Gok1gmK/src/subds/subsubds \r\nadd(ok): src/subds/subsubds (file)\r\nadd(ok): src/subds/.gitmodules (file)\r\nsave(ok): src/subds (dataset)\r\nadd(ok): src/subds (file)\r\nsave(ok): src (dataset)\r\ncreate(ok): src/subds/subsubds (dataset)\r\naction summary:\r\n  add (ok: 3)\r\n  create (ok: 1)\r\n  save (ok: 2)\r\n> cd src/subds\r\n> touch file\r\n> touch subsubds/file\r\n> mkdir d1 d2\r\n> touch d1/f1 d2/f2\r\n> cd d1\r\n> datalad save '-d^' -r\r\nadd(ok): ../subsubds/file (file)\r\nsave(ok): ../subsubds (dataset)\r\nadd(ok): ../subsubds (file)\r\nadd(ok): f1 (file)                                                                                               \r\nadd(ok): ../d2/f2 (file)\r\nadd(ok): ../file (file)\r\nsave(ok): .. (dataset)\r\nadd(ok): .. (file)\r\nsave(ok): ../.. (dataset)\r\naction summary:\r\n  add (ok: 6)\r\n  save (ok: 3)\r\n> mkdir outside\r\n> rm src/subds/d2/f2\r\n> touch src/newfile\r\n> cd outside\r\n> datalad save -r -d ../src\r\ndelete(ok): -d/subds/d2/f2 (file)\r\nsave(ok): -d/subds (dataset)\r\nadd(ok): -d/subds (file)\r\nadd(ok): -d/newfile (file)                                                                                       \r\nsave(ok): -d/. (dataset)\r\naction summary:\r\n  add (ok: 2)\r\n  delete (ok: 1)\r\n  save (notneeded: 1, ok: 2)\r\nbash ../trash/demo-paths.sh  5.91s user 2.00s system 104% cpu 7.599 total\r\n```\r\n</details>\r\n\r\nA brief excerpt from the above outputs could be the one where I am saving a number of changes while being in the subdirectory of a dataset:\r\n\r\n```\r\n> datalad save '-d^' -r\r\nadd(ok): file (file)\r\nsave(ok): subds/subsubds (dataset)\r\nadd(ok): subsubds (file)\r\nadd(ok): d1/f1 (file)                                                                                            \r\nadd(ok): d2/f2 (file)\r\nadd(ok): file (file)\r\nsave(ok): subds (dataset)\r\nadd(ok): subds (file)\r\nsave(ok): . (dataset)\r\n```\r\nvs\r\n```\r\n> datalad save '-d^' -r\r\nadd(ok): ../subsubds/file (file)\r\nsave(ok): ../subsubds (dataset)\r\nadd(ok): ../subsubds (file)\r\nadd(ok): f1 (file)                                                                                               \r\nadd(ok): ../d2/f2 (file)\r\nadd(ok): ../file (file)\r\nsave(ok): .. (dataset)\r\nadd(ok): .. (file)\r\nsave(ok): ../.. (dataset)\r\n```\r\n\r\nCloses gh-3442 (if we get there)\r\n\r\n[ci skip]\r\n\r\nTODOs:\r\n- [ ] seek feedback and if decided to proceed - may be in some use cases it would make no sense\r\n- [ ] fixup diff to make it sensible\r\n- [ ] fixup tests", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4454/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4454/timeline", "performed_via_github_app": null}