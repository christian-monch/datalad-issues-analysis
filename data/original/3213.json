{"url": "https://api.github.com/repos/datalad/datalad/issues/3213", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/3213/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/3213/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/3213/events", "html_url": "https://github.com/datalad/datalad/issues/3213", "id": 419258247, "node_id": "MDU6SXNzdWU0MTkyNTgyNDc=", "number": 3213, "title": "Make `run_command` tests be tolerated by nose without `-s`", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 440544386, "node_id": "MDU6TGFiZWw0NDA1NDQzODY=", "url": "https://api.github.com/repos/datalad/datalad/labels/fix-implemented", "name": "fix-implemented", "color": "0e8a16", "default": false, "description": "A fix is available, but has not been merged or released, yet."}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2019-03-11T01:13:03Z", "updated_at": "2019-03-21T14:18:40Z", "closed_at": "2019-03-21T14:16:26Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "ATM even more tests fail to run `nose` without `-s`. An example:\r\n```\r\n======================================================================\r\nERROR: datalad.distribution.tests.test_create.test_create_withprocedure\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python2.7/dist-packages/nose/case.py\", line 197, in runTest\r\n    self.test(*self.arg)\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/tests/utils.py\", line 615, in newfunc\r\n    return t(*(arg + (filename,)), **kw)\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/distribution/tests/test_create.py\", line 320, in test_create_withprocedure\r\n    proc_post=[['cfg_metadatatypes', 'xmp', 'datacite']])\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 491, in eval_func\r\n    return return_func(generator_func)(*args, **kwargs)\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 479, in return_func\r\n    results = list(results)\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 446, in generator_func\r\n    **_kwargs):\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 521, in _process_results\r\n    for res in results:\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 428, in generator_func\r\n    result_renderer, result_xfm, _result_filter, **_kwargs):\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 521, in _process_results\r\n    for res in results:\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/run_procedure.py\", line 462, in __call__\r\n    return_type='generator'\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 428, in generator_func\r\n    result_renderer, result_xfm, _result_filter, **_kwargs):\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/utils.py\", line 521, in _process_results\r\n    for res in results:\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/run.py\", line 216, in __call__\r\n    sidecar=sidecar):\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/run.py\", line 546, in run_command\r\n    expected_exit=rerun_info.get(\"exit\", 0) if rerun_info else None)\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/run.py\", line 385, in _execute_command\r\n    expect_fail=True,\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/cmd.py\", line 496, in run\r\n    stdin=stdin)\r\n  File \"/usr/lib/python2.7/subprocess.py\", line 382, in __init__\r\n    errread, errwrite), to_close = self._get_handles(stdin, stdout, stderr)\r\n  File \"/usr/lib/python2.7/subprocess.py\", line 818, in _get_handles\r\n    c2pwrite = stdout.fileno()\r\nAttributeError: StringIO instance has no attribute 'fileno'\r\n```\r\nI believe a full list is\r\n```\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/distribution/tests/test_create.py\", line 320, in test_create_withprocedure\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/tests/test_run_procedure.py\", line 138, in test_procedure_discovery\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/tests/test_run_procedure.py\", line 224, in test_configs\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/tests/test_run_procedure.py\", line 68, in test_basics\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/tests/test_run.py\", line 146, in test_py2_unicode_command\r\n  File \"/home/yoh/proj/datalad/datalad/datalad/interface/tests/test_run.py\", line 169, in test_sidecar\r\n```\r\nthis would complement a long list of tests we already marked for being unable to similarly be ran:\r\n```\r\n$> git grep @ignore_nose_capturing_stdout | nl | tail\r\n    25  datalad/support/tests/test_annexrepo.py:@ignore_nose_capturing_stdout\r\n    26  datalad/support/tests/test_annexrepo.py:@ignore_nose_capturing_stdout\r\n    27  datalad/tests/test_cmd.py:@ignore_nose_capturing_stdout\r\n    28  datalad/tests/test_cmd.py:@ignore_nose_capturing_stdout\r\n    29  datalad/tests/test_cmd.py:@ignore_nose_capturing_stdout\r\n    30  datalad/tests/test_cmd.py:@ignore_nose_capturing_stdout\r\n    31  datalad/tests/test_cmd.py:@ignore_nose_capturing_stdout\r\n    32  datalad/tests/test_cmd.py:@ignore_nose_capturing_stdout\r\n    33  datalad/tests/test_cmd.py:@ignore_nose_capturing_stdout\r\n    34  datalad/tests/test_installed.py:@ignore_nose_capturing_stdout\r\n```\r\nof cause we can just mark these newly discovered tests similarly (which I think I will now), but ideally we should look into this problem again.  Here (via  `run_procedure`) , and for all the tests of `run`, problem stems from the run.py:run_command\r\n```\r\n    runner = Runner(cwd=pwd)\r\n    try:\r\n        lgr.info(\"== Command start (output follows) =====\")\r\n        runner.run(\r\n            command,\r\n            # immediate output\r\n            log_online=True,\r\n            # not yet sure what we should do with the command output\r\n            # IMHO `run` itself should be very silent and let the command talk\r\n            log_stdout=False,\r\n            log_stderr=False,\r\n            expect_stderr=True,\r\n            expect_fail=True,\r\n            # TODO stdin\r\n        )\r\n```\r\nso we have both log_stdout and log_stderr False so there is no output collection to a temp file, and thus we bug out with the nose's StringIO as the stdout, which has no .file.", "closed_by": {"login": "kyleam", "id": 1297788, "node_id": "MDQ6VXNlcjEyOTc3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1297788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kyleam", "html_url": "https://github.com/kyleam", "followers_url": "https://api.github.com/users/kyleam/followers", "following_url": "https://api.github.com/users/kyleam/following{/other_user}", "gists_url": "https://api.github.com/users/kyleam/gists{/gist_id}", "starred_url": "https://api.github.com/users/kyleam/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kyleam/subscriptions", "organizations_url": "https://api.github.com/users/kyleam/orgs", "repos_url": "https://api.github.com/users/kyleam/repos", "events_url": "https://api.github.com/users/kyleam/events{/privacy}", "received_events_url": "https://api.github.com/users/kyleam/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/3213/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/3213/timeline", "performed_via_github_app": null}