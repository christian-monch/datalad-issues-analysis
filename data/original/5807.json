{"url": "https://api.github.com/repos/datalad/datalad/issues/5807", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5807/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5807/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5807/events", "html_url": "https://github.com/datalad/datalad/issues/5807", "id": 950792872, "node_id": "MDU6SXNzdWU5NTA3OTI4NzI=", "number": 5807, "title": "`CommandError` info hidden (likely wide-spread issue)", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 390153891, "node_id": "MDU6TGFiZWwzOTAxNTM4OTE=", "url": "https://api.github.com/repos/datalad/datalad/labels/UX", "name": "UX", "color": "0052cc", "default": false, "description": "user experience"}, {"id": 1782622781, "node_id": "MDU6TGFiZWwxNzgyNjIyNzgx", "url": "https://api.github.com/repos/datalad/datalad/labels/severity-important", "name": "severity-important", "color": "cc0000", "default": false, "description": "major effect on the usability of a package, without rendering it completely unusable to everyone"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": {"url": "https://api.github.com/repos/datalad/datalad/milestones/84", "html_url": "https://github.com/datalad/datalad/milestone/84", "labels_url": "https://api.github.com/repos/datalad/datalad/milestones/84/labels", "id": 6275407, "node_id": "MDk6TWlsZXN0b25lNjI3NTQwNw==", "number": 84, "title": "0.14.x", "description": "", "creator": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "open_issues": 7, "closed_issues": 4, "state": "open", "created_at": "2021-01-05T14:42:35Z", "updated_at": "2021-09-13T13:27:50Z", "due_on": null, "closed_at": null}, "comments": 0, "created_at": "2021-07-22T15:30:19Z", "updated_at": "2021-07-29T14:55:27Z", "closed_at": "2021-07-29T14:55:27Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "Working on #3127, I tried what would happen when calling `push` on a special remote with `exporttree=yes`:\r\n\r\n```\r\n% datalad push --to expdir\r\nTransfer data to 'expdir':  50%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c         | 2.00/4.00 [00:00<00:00, 7.06k Steps/sCommandError: 'git -c diff.ignoreSubmodules=none annex copy --batch -z --to expdir --fast --json --json-error-messages --json-progress -c annex.dotfiles=true -c annex.retry=3' failed with exitcode 1 under /tmp/testds\r\ngit-annex: copy: 1 failed\r\n```\r\n\r\nThat is suboptimal error reporting.\r\n\r\nHere is what git-annex is actually reporting:\r\n\r\n```\r\n% git annex copy --to expdir\r\ncopy 123 (to expdir...) \r\n  remote is configured with exporttree=yes; use `git-annex export` to store content on it\r\nfailed\r\ngit-annex: copy: 1 failed\r\n```\r\n\r\nBut this seems to have little to do with `push`. There is no specific error handling. This is a plain `CommandError`:\r\n\r\n```\r\n> /home/mih/hacking/datalad/git/datalad/cmd.py(168)run()\r\n-> raise CommandError(\r\n(Pdb) l\r\n163             if results.get('code', True) not in [0, None]:\r\n164                 # the runner has a better idea, doc string warns Protocol\r\n165                 # implementations not to return these\r\n166                 results.pop('cmd', None)\r\n167                 results.pop('cwd', None)\r\n168  ->             raise CommandError(\r\n169                     # whatever the results were, we carry them forward\r\n170                     cmd=cmd,\r\n171                     cwd=self.cwd,\r\n172                     **results,\r\n173                 )\r\n```\r\n\r\nand there is plenty of information given to it:\r\n\r\n```\r\n(Pdb) pprint(results)\r\n{'code': 1,\r\n 'stderr': 'git-annex: copy: 1 failed\\n',\r\n 'stdout': '',\r\n 'stdout_json': [{'command': 'copy',\r\n                  'error-messages': ['  remote is configured with '\r\n                                     'exporttree=yes; use `git-annex export` '\r\n                                     'to store content on it',\r\n                                     '  remote is configured with '\r\n                                     'exporttree=yes; use `git-annex export` '\r\n                                     'to store content on it',\r\n                                     '  remote is configured with '\r\n                                     'exporttree=yes; use `git-annex export` '\r\n                                     'to store content on it',\r\n                                     '  This could have failed because --fast '\r\n                                     'is enabled.'],\r\n                  'file': '123',\r\n                  'input': ['123'],\r\n                  'key': 'MD5E-s4--ba1f2511fc30423bdbb183fe33f3dd0f',\r\n                  'note': 'to expdir...',\r\n                  'success': False}]}\r\n```\r\n\r\nBut none of it makes it out the other end (despite being available in `.kwargs` of the `CommandError` instance).\r\n\r\nTurns out it is explicitly disabled in `main.py`\r\n\r\n```\r\n-> exc_msg = exc.to_str(include_output=False)\r\n(Pdb) l\r\n234                     import pdb; pdb.set_trace()\r\n235                     # behave as if the command ran directly, importantly pass\r\n236                     # exit code as is\r\n237                     # to not duplicate any captured output in the exception\r\n238                     # rendering, will come next\r\n239  ->                 exc_msg = exc.to_str(include_output=False)\r\n```\r\n\r\nwith `include_output=True` the info is back!\r\n\r\nThis was caused (or amplified) by me in 09d3fd8ed0287586847f31e1863cc71a877e6942, and seems to not consider enough sources of structured information -- in particular the errors from JSON records provided by git-annex!!!", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5807/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5807/timeline", "performed_via_github_app": null}