{"url": "https://api.github.com/repos/datalad/datalad/issues/2379", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2379/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2379/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2379/events", "html_url": "https://github.com/datalad/datalad/issues/2379", "id": 311234798, "node_id": "MDU6SXNzdWUzMTEyMzQ3OTg=", "number": 2379, "title": "get_versioned_url should handle correctly urls with a version already assigned", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 2, "created_at": "2018-04-04T13:41:10Z", "updated_at": "2018-04-07T17:54:46Z", "closed_at": "2018-04-07T17:54:46Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "#### What is the problem?\r\n```ipython\r\nIn [10]: get_versioned_url('http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=pNsV5jJrnGATkmNrP8.i_xNH6CY4Mo5s')\r\n[DEBUG  ] Returning provider Provider(authenticator=<<S3Authenticator(bucket...>>, credential=<<AWS_S3(name='datalad-t...>>, name='datalad-test-s3', url_res=['s3://datalad-test.*']) for url s3://datalad-test0-versioned/ \r\nOut[10]: u'http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=pNsV5jJrnGATkmNrP8.i_xNH6CY4Mo5s&versionId=Kvuind11HZh._dCPaDAb0OY9dRrQoTMn'\r\n```\r\nyou can see that it adds one more versionId (the most recent one) to the already versioned URL.  Should have returned original url.\r\nAdditionally might be worth to add an option `update` which would replace versionId with the most recent one\r\n\r\nCould be tested on that file with 3 versions:\r\n```shell\r\n$> datalad ls -aL s3://datalad-test0-versioned/3versions-allversioned.txt \r\nConnecting to bucket: datalad-test0-versioned\r\n[INFO   ] S3 session: Connecting to the bucket datalad-test0-versioned \r\nBucket info:\r\n  Versioning: {'MfaDelete': 'Disabled', 'Versioning': 'Enabled'}\r\n     Website: datalad-test0-versioned.s3-website-us-east-1.amazonaws.com\r\n         ACL: <Policy: yoh@cs.unm.edu (owner) = FULL_CONTROL>\r\n3versions-allversioned.txt            2015-11-07T05:23:37.000Z 8 ver:Kvuind11HZh._dCPaDAb0OY9dRrQoTMn  acl:<Policy: yoh@cs.unm.edu (owner) = FULL_CONTROL>  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=Kvuind11HZh._dCPaDAb0OY9dRrQoTMn [OK]\r\n3versions-allversioned.txt            2015-11-07T05:23:37.000Z 8 ver:b.qCuh7Sg58VIYj8TVHzbRS97EvejzEl  acl:<Policy: yoh@cs.unm.edu (owner) = FULL_CONTROL>  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=b.qCuh7Sg58VIYj8TVHzbRS97EvejzEl [OK]\r\n3versions-allversioned.txt            2015-11-07T05:23:37.000Z 8 ver:pNsV5jJrnGATkmNrP8.i_xNH6CY4Mo5s  acl:<Policy: yoh@cs.unm.edu (owner) = FULL_CONTROL>  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt?versionId=pNsV5jJrnGATkmNrP8.i_xNH6CY4Mo5s [OK]\r\n3versions-allversioned.txt_sameprefix 2015-11-07T05:23:37.000Z 8 ver:Mvsc4FgJWc6gExwSw1d6wsLrnk6wdDVa  acl:<Policy: yoh@cs.unm.edu (owner) = FULL_CONTROL>  http://datalad-test0-versioned.s3.amazonaws.com/3versions-allversioned.txt_sameprefix?versionId=Mvsc4FgJWc6gExwSw1d6wsLrnk6wdDVa [OK]\r\n```\r\n", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2379/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2379/timeline", "performed_via_github_app": null}