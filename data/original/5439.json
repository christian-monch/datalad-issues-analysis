{"url": "https://api.github.com/repos/datalad/datalad/issues/5439", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/5439/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/5439/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/5439/events", "html_url": "https://github.com/datalad/datalad/issues/5439", "id": 816066898, "node_id": "MDU6SXNzdWU4MTYwNjY4OTg=", "number": 5439, "title": "git-annex will instantaneously and silently upgrade the repo to a new version of git-annex ", "user": {"login": "jbpoline", "id": 275048, "node_id": "MDQ6VXNlcjI3NTA0OA==", "avatar_url": "https://avatars.githubusercontent.com/u/275048?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jbpoline", "html_url": "https://github.com/jbpoline", "followers_url": "https://api.github.com/users/jbpoline/followers", "following_url": "https://api.github.com/users/jbpoline/following{/other_user}", "gists_url": "https://api.github.com/users/jbpoline/gists{/gist_id}", "starred_url": "https://api.github.com/users/jbpoline/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jbpoline/subscriptions", "organizations_url": "https://api.github.com/users/jbpoline/orgs", "repos_url": "https://api.github.com/users/jbpoline/repos", "events_url": "https://api.github.com/users/jbpoline/events{/privacy}", "received_events_url": "https://api.github.com/users/jbpoline/received_events", "type": "User", "site_admin": false}, "labels": [], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 7, "created_at": "2021-02-25T04:16:00Z", "updated_at": "2021-03-17T20:25:11Z", "closed_at": "2021-03-17T20:25:10Z", "author_association": "NONE", "active_lock_reason": null, "body": "Described by @prioux ; possibly linked to #5399\r\n\r\n@yarikoptic : this may be a @joey question\r\n\r\n#### What is the problem?\r\n\r\nThe 'git-annex' command and its different versions is the tricky point here.\r\n\r\nThe problem is that when git-annex version N is run on a repo created with an\r\nearlier version of git-annex (e.g. A, where A < N), then git-annex will instantaneously\r\nand silently upgrade the repo to git-annex version N.\r\n\r\nThis is a problem when the datalad command, for some reason, invokes an old version A of git-annex\r\nwhile the system or the user's shell has access to a newer version N. This sequence of operation then\r\ncauses problems:\r\n\r\n1) You can install a datalad dataset with the datalad command, which uses old git-annex A\r\n2) You manually run some git-annex commands, which uses new git-annex N, and which upgrades the\r\ndataset to git-annex N structure.\r\n3) You attempt to run further datalad commands, but now it is trying to run git-annex A again\r\nand these will crash, because version A doesn't know how to access git-annex version N files.\r\n\r\n#### What steps will reproduce the problem?\r\n\r\nA very specific example of that is when using the datalad singularity container:\r\nFetch the container with\r\n\r\nsingularity pull datalad.sif shub://datalad/datalad:fullmaster\r\n\r\nThis creates the file 'datalad.sif' which is a self-contained, self-running container with\r\ndatalad 0.13 and git-annex 7.20:\r\n\r\nunix> ./datalad.sif --version\r\ndatalad 0.13.0rc2\r\nunix> singularity exec datalad.sif git-annex version | head -1\r\ngit-annex version: 7.20190819+git2-g908476a9b-1~ndall+1\r\n\r\nIf on that system I also have a more recent git-annex:\r\n\r\nunix> git-annex version | head -1\r\ngit-annex version: 8.20200909-g2d5036e44\r\n\r\nThen it's easy to demonstrate the problem:\r\n\r\nunix> export SINGUALRITY_BINDPATH=$PWD # only needed if you run datalad on any path outside of the default bind path of singularity\r\n\r\nInstall a dataset:\r\n\r\nunix> ./datalad.sif install ///conp-dataset/projects/BigBrain_3DSurfaces\r\nunix> cd BigBrain_3DSurfaces\r\n\r\nQuery with the build-in git-annex, v7 :\r\n\r\nunix> singularity exec ../datalad.sif git-annex whereis bigbrain.loris.ca_BigBrainRelease.2015_3D_Surfaces_CerebralCortex_MNI_obj_white_right_327680.obj                                                                                  \r\nwhereis bigbrain.loris.ca_BigBrainRelease.2015_3D_Surfaces_CerebralCortex_MNI_obj_white_right_327680.obj (2 copies)                                                                                                                  \r\n       00000000-0000-0000-0000-000000000001 -- web                                                                \r\n       4850dd3d-9f7c-4e2f-8b43-27f1a0111376 -- emmet@emmet-VirtualBox:~/conp-dataset/projects/BigBrain_3DSurfaces\r\n\r\n web: ftp://bigbrain.loris.ca/BigBrainRelease.2015/3D_Surfaces/CerebralCortex/MNI-obj/white_right_327680.obj      \r\nok                      \r\n\r\nQuery now with the system git-annex, v8 :\r\n\r\nunix> git-annex whereis bigbrain.loris.ca_BigBrainRelease.2015_3D_Surfaces_CerebralCortex_MNI_obj_white_right_327680.obj                                                                                                                  \r\nwhereis bigbrain.loris.ca_BigBrainRelease.2015_3D_Surfaces_CerebralCortex_MNI_obj_white_right_327680.obj (2 copies)                                                                                                                  \r\n       00000000-0000-0000-0000-000000000001 -- web                                                                \r\n       4850dd3d-9f7c-4e2f-8b43-27f1a0111376 -- emmet@emmet-VirtualBox:~/conp-dataset/projects/BigBrain_3DSurfaces\r\n\r\n web: ftp://bigbrain.loris.ca/BigBrainRelease.2015/3D_Surfaces/CerebralCortex/MNI-obj/white_right_327680.obj      \r\nok                                                                                                             \r\n\r\nEven though I get the same result, now the repo has been silently upgraded to version 8. Future datalad commands will fail:\r\n\r\nunix> singularity exec ../datalad.sif git-annex whereis bigbrain.loris.ca_BigBrainRelease.2015_3D_Surfaces_CerebralCortex_MNI_obj_white_right_327680.obj                                         \r\ngit-annex: Repository version 8 is not supported. Upgrade git-annex.\r\n\r\nunix> ../datalad.sif get bigbrain.loris.ca_BigBrainRelease.2015_3D_Surfaces_CerebralCortex_MNI_obj_white_right_327680.obj\r\nCommandError: 'git -c annex.merge-annex-branches=false annex find -c annex.dotfiles=true -c annex.retry=3 --json --json-error-messages --not --in . -- bigbrain.loris.ca_BigBrainRelease.2015_3D_Surfaces_CerebralCortex_MNI_obj_white_right_327680.obj' failed with exitcode 1 under /tmp/X/BigBrain_3DSurfaces\r\ngit-annex: Repository version 8 is not supported. Upgrade git-annex.\r\n", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/5439/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/5439/timeline", "performed_via_github_app": null}