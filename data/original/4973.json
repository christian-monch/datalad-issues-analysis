{"url": "https://api.github.com/repos/datalad/datalad/issues/4973", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/4973/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/4973/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/4973/events", "html_url": "https://github.com/datalad/datalad/pull/4973", "id": 711506389, "node_id": "MDExOlB1bGxSZXF1ZXN0NDk1MTUxMjMw", "number": 4973, "title": "BF+OPT: addurls - avoid resources (processes) exhaustion in case of having large number of subdatasets", "user": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 1037235281, "node_id": "MDU6TGFiZWwxMDM3MjM1Mjgx", "url": "https://api.github.com/repos/datalad/datalad/labels/do%20not%20merge", "name": "do not merge", "color": "fbca04", "default": false, "description": "Not to be merged, will trigger WIP app \"not passed\" status"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 8, "created_at": "2020-09-29T22:30:27Z", "updated_at": "2020-10-20T21:17:51Z", "closed_at": "2020-10-20T21:17:51Z", "author_association": "MEMBER", "active_lock_reason": null, "pull_request": {"url": "https://api.github.com/repos/datalad/datalad/pulls/4973", "html_url": "https://github.com/datalad/datalad/pull/4973", "diff_url": "https://github.com/datalad/datalad/pull/4973.diff", "patch_url": "https://github.com/datalad/datalad/pull/4973.patch"}, "body": "Motivation: For ABCD, due to a vast number of subjects (`>1k`) and number of files per each (`>200`) it is desired to adhere to the same ideas as for HCP dataset and create a subdataset for each subject (at least in the `derivatives/*/*`) subfolders. Upon its analysis, `addurls` discovers which subdatasets,  creates (or warns about their existence, see #4968) them, and then proceeds with invoking `AnnexRepo.add_url_to_file` in a batched mode (which is good).  But then each such batched git-annex instantiates about 19 subprocesses (one of which is `git-remote-annex-datalad`) which leads to resources exhaustion, and at some point one of the batched processes doesn't start or perform as expected and the whole run collapses.\r\n\r\nIMHO a \"resolution\" to this is quite straightforward -- group rows by their datasets, and issue `.precommit` when done with any particular to stop all the batched processes for that dataset.repo.  That is what is implemented in this PR.\r\n\r\nI went a little further with OPT though after I noticed access to `.repo` per each row.  IIRC that operation is not \"fast\".  How much it is affecting overall runtime - in case of non `--fast`, any such penalty is probably negligible.  I do not know yet if there is any notable difference, but once again -- why to waste cycles.\r\n\r\nCommit messages and comments in the code provide more argumentation and information. \r\nTODOs\r\n- [x] see how it effects a real run on ABCD - verified that git/git-annex count stays close to \"hard to spot\" since processes are short lived (spotted that the datalad process itself is quite heavy - 4GB virtual/resident memory.  I guess all the datasets' instances, didn't investigate)\r\n- [ ] decide on either to proceed fixing up progress indication here one way or another, or just move the entire BF against `master` with a more invasive RFing of addurls to avoid unnecessary duplicate actions across `add_urls` and `add_meta` subcalls\r\n- [ ] may be add a unittest which would verify that no more than a single batched addurls exists any given point in time throughout addurls testing.", "closed_by": {"login": "yarikoptic", "id": 39889, "node_id": "MDQ6VXNlcjM5ODg5", "avatar_url": "https://avatars.githubusercontent.com/u/39889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yarikoptic", "html_url": "https://github.com/yarikoptic", "followers_url": "https://api.github.com/users/yarikoptic/followers", "following_url": "https://api.github.com/users/yarikoptic/following{/other_user}", "gists_url": "https://api.github.com/users/yarikoptic/gists{/gist_id}", "starred_url": "https://api.github.com/users/yarikoptic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yarikoptic/subscriptions", "organizations_url": "https://api.github.com/users/yarikoptic/orgs", "repos_url": "https://api.github.com/users/yarikoptic/repos", "events_url": "https://api.github.com/users/yarikoptic/events{/privacy}", "received_events_url": "https://api.github.com/users/yarikoptic/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/4973/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/4973/timeline", "performed_via_github_app": null}