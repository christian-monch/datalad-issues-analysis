{"url": "https://api.github.com/repos/datalad/datalad/issues/2192", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/2192/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/2192/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/2192/events", "html_url": "https://github.com/datalad/datalad/issues/2192", "id": 297995883, "node_id": "MDU6SXNzdWUyOTc5OTU4ODM=", "number": 2192, "title": "whoosh search index writer issues on NFS", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 700886055, "node_id": "MDU6TGFiZWw3MDA4ODYwNTU=", "url": "https://api.github.com/repos/datalad/datalad/labels/metadata", "name": "metadata", "color": "0052cc", "default": false, "description": ""}], "state": "open", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 3, "created_at": "2018-02-17T10:45:58Z", "updated_at": "2018-03-20T07:33:37Z", "closed_at": null, "author_association": "MEMBER", "active_lock_reason": null, "body": "#### What is the problem?\r\n\r\n```\r\n% datalad --dbg search mr\r\n[INFO   ] Rebuilding search index \r\n[INFO   ] Processing metadata records for 5 datasets \r\n[INFO   ] Added 1 document on dataset . \r\n[INFO   ] Added 1 document on dataset 7t \r\n[INFO   ] Added 1 document on dataset 7t/yx11_2014/dicoms \r\n[INFO   ] Added 1 document on dataset 7t/yx11_2015/dicoms \r\n[INFO   ] Added 1 document on dataset 7t/yx11_2022/dicoms \r\nTraceback (most recent call last):\r\n  File \"/home/mih/datalad4users/bin/datalad\", line 9, in <module>\r\n    load_entry_point('datalad==0.3.0.dev1', 'console_scripts', 'datalad')()\r\n  File \"/home/mih/datalad4users/datalad/cmdline/main.py\", line 354, in main\r\n    ret = cmdlineargs.func(cmdlineargs)\r\n  File \"/home/mih/datalad4users/datalad/interface/base.py\", line 432, in call_from_parser\r\n    ret = list(ret)\r\n  File \"/home/mih/datalad4users/datalad/interface/utils.py\", line 408, in generator_func\r\n    result_renderer, result_xfm, _result_filter, **_kwargs):\r\n  File \"/home/mih/datalad4users/datalad/interface/utils.py\", line 475, in _process_results\r\n    for res in results:\r\n  File \"/home/mih/datalad4users/datalad/metadata/search.py\", line 638, in __call__\r\n    documenttype)\r\n  File \"/home/mih/datalad4users/datalad/metadata/search.py\", line 411, in _get_search_index\r\n    idx.commit(optimize=True)\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/writing.py\", line 935, in commit\r\n    self._finish()\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/writing.py\", line 884, in _finish\r\n    self._tempstorage.destroy()\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/filedb/filestore.py\", line 458, in destroy\r\n    self.clean()\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/filedb/filestore.py\", line 518, in clean\r\n    os.remove(os.path.join(path, fname))\r\nOSError: [Errno 16] Device or resource busy: '/home/mih/scratch/cbbstest/lin/.git/datalad/search_index/default/MAIN.tmp/.nfs0000000000392db500027c44'\r\n```\r\n\r\nSadly a simple delay doesn't work around this issue, as whoosh doesn't expect this situation:\r\n\r\n```diff\r\ndiff --git a/datalad/metadata/search.py b/datalad/metadata/search.py\r\nindex a7aa7b5b..f4cf0eb0 100644\r\n--- a/datalad/metadata/search.py\r\n+++ b/datalad/metadata/search.py\r\n@@ -40,6 +40,7 @@ from datalad.consts import LOCAL_CENTRAL_PATH\r\n from datalad.consts import SEARCH_INDEX_DOTGITDIR\r\n from datalad.utils import assure_list\r\n from datalad.utils import assure_unicode\r\n+from datalad.dochelpers import exc_str\r\n from datalad.support.exceptions import NoDatasetArgumentFound\r\n from datalad.ui import ui\r\n from datalad.dochelpers import single_or_plural\r\n@@ -408,7 +409,15 @@ def _get_search_index(index_dir, label, ds, force_reindex, get_schema, meta2doc,\r\n             old_ds_rpath)\r\n \r\n     lgr.debug(\"Committing index\")\r\n-    idx.commit(optimize=True)\r\n+    try:\r\n+        idx.commit(optimize=True)\r\n+    except OSError as e:\r\n+        lgr.warning(\r\n+            'Failed to store search index, trying again in two seconds [{}]'.format(\r\n+                exc_str(e)))\r\n+        import time\r\n+        time.sleep(2)\r\n+        idx.commit()\r\n \r\n     # \"timestamp\" the search index to allow for automatic invalidation\r\n     with open(stamp_fname, 'w') as f:\r\n```\r\n\r\n```\r\n<snip>\r\n[WARNING] Failed to store search index, trying again in two seconds [[Errno 16] Device or resource busy: '/home/mih/scratch/cbbstest/lin/.git/datalad/search_index/default/MAIN.tmp/.nfs0000000000392dd300027c4a' [filestore.py:clean:518]] \r\nTraceback (most recent call last):\r\n  File \"/home/mih/datalad4users/bin/datalad\", line 9, in <module>\r\n    load_entry_point('datalad==0.3.0.dev1', 'console_scripts', 'datalad')()\r\n  File \"/home/mih/datalad4users/datalad/cmdline/main.py\", line 354, in main\r\n    ret = cmdlineargs.func(cmdlineargs)\r\n  File \"/home/mih/datalad4users/datalad/interface/base.py\", line 432, in call_from_parser\r\n    ret = list(ret)\r\n  File \"/home/mih/datalad4users/datalad/interface/utils.py\", line 408, in generator_func\r\n    result_renderer, result_xfm, _result_filter, **_kwargs):\r\n  File \"/home/mih/datalad4users/datalad/interface/utils.py\", line 475, in _process_results\r\n    for res in results:\r\n  File \"/home/mih/datalad4users/datalad/metadata/search.py\", line 647, in __call__\r\n    documenttype)\r\n  File \"/home/mih/datalad4users/datalad/metadata/search.py\", line 420, in _get_search_index\r\n    idx.commit()\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/writing.py\", line 927, in commit\r\n    finalsegments.append(self._finalize_segment())\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/writing.py\", line 866, in _finalize_segment\r\n    self._flush_segment()\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/writing.py\", line 830, in _flush_segment\r\n    self.perdocwriter.close()\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/codec/whoosh3.py\", line 267, in close\r\n    self._cols.save_as_files(self._storage, self._column_filename)\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/filedb/compound.py\", line 297, in save_as_files\r\n    for name, blocks in self._readback():\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/filedb/compound.py\", line 278, in _readback\r\n    temp.close()\r\n  File \"/usr/lib/python2.7/dist-packages/whoosh/filedb/structfile.py\", line 123, in close\r\n    raise Exception(\"This file is already closed\")\r\nException: This file is already closed\r\n```", "closed_by": null, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/2192/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/2192/timeline", "performed_via_github_app": null}