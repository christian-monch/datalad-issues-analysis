{"url": "https://api.github.com/repos/datalad/datalad/issues/1238", "repository_url": "https://api.github.com/repos/datalad/datalad", "labels_url": "https://api.github.com/repos/datalad/datalad/issues/1238/labels{/name}", "comments_url": "https://api.github.com/repos/datalad/datalad/issues/1238/comments", "events_url": "https://api.github.com/repos/datalad/datalad/issues/1238/events", "html_url": "https://github.com/datalad/datalad/issues/1238", "id": 203861418, "node_id": "MDU6SXNzdWUyMDM4NjE0MTg=", "number": 1238, "title": "`publish` doesn't honor `--to`", "user": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "labels": [{"id": 63778590, "node_id": "MDU6TGFiZWw2Mzc3ODU5MA==", "url": "https://api.github.com/repos/datalad/datalad/labels/severity-normal", "name": "severity-normal", "color": "ff8888", "default": false, "description": "standard severity"}], "state": "closed", "locked": false, "assignee": null, "assignees": [], "milestone": null, "comments": 1, "created_at": "2017-01-29T10:07:08Z", "updated_at": "2017-01-29T14:09:35Z", "closed_at": "2017-01-29T14:09:35Z", "author_association": "MEMBER", "active_lock_reason": null, "body": "This may be related to #1236 \r\n\r\nHere is a demo script that created a fresh dataset, creates to remote siblings, and publishes a subsequent change to one of the remotes. However, It get's published to both:\r\n\r\n````#!/bin/bash\r\nset -e\r\nwdir=\"$(mktemp -d)\"\r\ncd $wdir\r\ndatalad create orig\r\ndatalad create-sibling -d orig -s target1 localhost:\"$wdir\"/target1\r\ndatalad create-sibling -d orig -s target2 localhost:\"$wdir\"/target2 --publish-depends target1\r\ncd orig\r\ntouch probe\r\ndatalad add probe\r\ngit status\r\ndatalad -l debug publish --to target1\r\nfor t in target1 target2; do\r\n  test -e $wdir/$t/probe && echo \"published $t\" || echo \"not published $t\"\r\ndone\r\n````\r\n\r\nHere is the log\r\n\r\n````\r\n% bash -x publishdemo.sh\r\n+ set -e\r\n++ mktemp -d\r\n+ wdir=/tmp/tmp.vCirTaLCYp\r\n+ cd /tmp/tmp.vCirTaLCYp\r\n+ datalad create orig\r\n[INFO   ] Creating a new annex repo at /tmp/tmp.vCirTaLCYp/orig \r\nCreated dataset at /tmp/tmp.vCirTaLCYp/orig.\r\n+ datalad create-sibling -d orig -s target1 localhost:/tmp/tmp.vCirTaLCYp/target1\r\n[INFO   ] Connecting ... \r\n[INFO   ] Creating target dataset /tmp/tmp.vCirTaLCYp/orig at /tmp/tmp.vCirTaLCYp/target1 \r\n[INFO   ] Adjusting remote git configuration \r\n[INFO   ] Enabling git post-update hook ... \r\n+ datalad create-sibling -d orig -s target2 localhost:/tmp/tmp.vCirTaLCYp/target2 --publish-depends target1\r\n[INFO   ] Connecting ... \r\n[INFO   ] Creating target dataset /tmp/tmp.vCirTaLCYp/orig at /tmp/tmp.vCirTaLCYp/target2 \r\n[INFO   ] Configure additional publication dependency on \"target1\" \r\n[INFO   ] Adjusting remote git configuration \r\n[INFO   ] Enabling git post-update hook ... \r\n+ cd orig\r\n+ touch probe\r\n+ datalad add probe\r\n                                                                              \r\nAdded /tmp/tmp.vCirTaLCYp/orig/probe\r\n+ git status\r\nOn branch master\r\nnothing to commit, working tree clean\r\n+ datalad -l debug publish --to target1\r\n[DEBUG  ] Resolved dataset for publishing: <Dataset path=/tmp/tmp.vCirTaLCYp/orig> \r\n[DEBUG  ] Resolved input path arguments: [] \r\n[DEBUG  ] Evaluating 1 dataset publication candidate(s) \r\n[DEBUG  ] Attempt to publish 1 datasets \r\n[DEBUG  ] Try starting control master by calling:\r\n| ['ssh', '-o', 'ControlMaster=auto', '-o', 'ControlPersist=15m', '-o', 'ControlPath=/home/mih/.cache/datalad/sockets/localhost', 'localhost', 'exit'] \r\n[DEBUG  ] Running: ['git', '-c', 'receive.autogc=0', '-c', 'gc.auto=0', 'annex', 'sync', '--debug', '-c', 'remote.target1.annex-ssh-options=-o ControlMaster=auto -S /home/mih/.cache/datalad/sockets/localhost', '-c', 'remote.target2.annex-ssh-options=-o ControlMaster=auto -S /home/mih/.cache/datalad/sockets/localhost']\r\n| cwd: /tmp/tmp.vCirTaLCYp/orig \r\n[DEBUG  ] Running: ['ssh', '-O', 'check', '-o', 'ControlPath=/home/mih/.cache/datalad/sockets/localhost', 'localhost']\r\n| cwd: None \r\n[INFO   ] [up to date]\r\n|  \r\n[INFO   ] Publishing <Dataset path=/tmp/tmp.vCirTaLCYp/orig> to target1 \r\n[DEBUG  ] Running: ['ssh', '-O', 'check', '-o', 'ControlPath=/home/mih/.cache/datalad/sockets/localhost', 'localhost']\r\n| cwd: None \r\n[INFO   ] [up to date]\r\n|  \r\n[INFO   ] Publishing data of dataset <Dataset path=/tmp/tmp.vCirTaLCYp/orig> ... \r\n[DEBUG  ] Running: ['git', '-c', 'receive.autogc=0', '-c', 'gc.auto=0', 'annex', 'copy', '--debug', '-c', 'remote.target1.annex-ssh-options=-o ControlMaster=auto -S /home/mih/.cache/datalad/sockets/localhost', '-c', 'remote.target2.annex-ssh-options=-o ControlMaster=auto -S /home/mih/.cache/datalad/sockets/localhost', '--to=target1']\r\n| cwd: /tmp/tmp.vCirTaLCYp/orig \r\n1 item was published:\r\nDataset: /tmp/tmp.vCirTaLCYp/orig\r\n\r\n[DEBUG  ] Closing 1 SSH connections... \r\n[DEBUG  ] Running: ['ssh', '-O', 'stop', '-o', 'ControlPath=/home/mih/.cache/datalad/sockets/localhost', 'localhost']\r\n| cwd: None \r\n+ for t in target1 target2\r\n+ test -e /tmp/tmp.vCirTaLCYp/target1\r\n+ echo 'published target1'\r\npublished target1\r\n+ for t in target1 target2\r\n+ test -e /tmp/tmp.vCirTaLCYp/target2\r\n+ echo 'published target2'\r\npublished target2\r\n````\r\n\r\nThe culprit seems to be an unqualified call to `git annex sync`, caused by ` ds.repo.merge_annex(remote)`. This may or may not be a result of the recent RF of publish.", "closed_by": {"login": "mih", "id": 136479, "node_id": "MDQ6VXNlcjEzNjQ3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/136479?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mih", "html_url": "https://github.com/mih", "followers_url": "https://api.github.com/users/mih/followers", "following_url": "https://api.github.com/users/mih/following{/other_user}", "gists_url": "https://api.github.com/users/mih/gists{/gist_id}", "starred_url": "https://api.github.com/users/mih/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mih/subscriptions", "organizations_url": "https://api.github.com/users/mih/orgs", "repos_url": "https://api.github.com/users/mih/repos", "events_url": "https://api.github.com/users/mih/events{/privacy}", "received_events_url": "https://api.github.com/users/mih/received_events", "type": "User", "site_admin": false}, "reactions": {"url": "https://api.github.com/repos/datalad/datalad/issues/1238/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0, "rocket": 0, "eyes": 0}, "timeline_url": "https://api.github.com/repos/datalad/datalad/issues/1238/timeline", "performed_via_github_app": null}